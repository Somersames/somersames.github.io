<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Somersames</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://somersames.github.io/"/>
  <updated>2020-04-20T17:00:44.608Z</updated>
  <id>https://somersames.github.io/</id>
  
  <author>
    <name>Somersames</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä»£ç†æ¨¡å¼ä¹‹JDKä¸ºä»€ä¹ˆéœ€è¦å®ç°æ¥å£(ä¸‹ç¯‡)</title>
    <link href="https://somersames.github.io/2020/04/21/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E4%B9%8BJDK%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3-%E4%B8%8B%E7%AF%87/"/>
    <id>https://somersames.github.io/2020/04/21/ä»£ç†æ¨¡å¼ä¹‹JDKä¸ºä»€ä¹ˆéœ€è¦å®ç°æ¥å£-ä¸‹ç¯‡/</id>
    <published>2020-04-20T17:00:44.000Z</published>
    <updated>2020-04-20T17:00:44.608Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>ä»£ç†æ¨¡å¼ä¹‹JDKä¸ºä»€ä¹ˆéœ€è¦å®ç°æ¥å£(ä¸Šç¯‡)</title>
    <link href="https://somersames.github.io/2020/04/15/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E4%B9%8BJDK%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3-%E4%B8%8A%E7%AF%87/"/>
    <id>https://somersames.github.io/2020/04/15/ä»£ç†æ¨¡å¼ä¹‹JDKä¸ºä»€ä¹ˆéœ€è¦å®ç°æ¥å£-ä¸Šç¯‡/</id>
    <published>2020-04-15T14:58:59.000Z</published>
    <updated>2020-04-20T17:00:35.601Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>é¦–å…ˆä»£ç†æ¨¡å¼åˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ï¼Œç”±äºJDKé‡‡ç”¨çš„æ˜¯åŠ¨æ€ä»£ç†ï¼Œæ‰€ä»¥é™æ€ä»£ç†åœ¨è¿™é‡Œä¸å†ä»‹ç»ã€‚</p><h2 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h2><h3 id="JDKåŠ¨æ€ä»£ç†"><a href="#JDKåŠ¨æ€ä»£ç†" class="headerlink" title="JDKåŠ¨æ€ä»£ç†"></a>JDKåŠ¨æ€ä»£ç†</h3><p>é¦–å…ˆ<code>JDK</code>çš„åŠ¨æ€ä»£ç†è¦æ±‚çœŸå®çš„å¯¹è±¡å¿…é¡»å®ç°ä¸€ä¸ªæ¥å£ï¼Œè€Œä»£ç†ç±»åˆ™å®ç°<code>InvocationHandler</code>æ¥å£æ¥å®ŒæˆåŠ¨æ€ä»£ç†ã€‚å¦‚ä¸‹ä»£ç ï¼š</p><blockquote><p>æ¥å£</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">jdkProxy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¢«ä»£ç†çš„ç±»<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bus</span> <span class="keyword">implements</span> <span class="title">Car</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jdkProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"æµ‹è¯•"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>ä»£ç†ç±»</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before---------"</span>);</span><br><span class="line">        Object object = method.invoke(target,args);</span><br><span class="line">        System.out.println(<span class="string">"after---------"</span>);</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getInstance</span><span class="params">(Object target)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">        Class&lt;?&gt; clazz = target.getClass();</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(<span class="keyword">new</span> SelfClassLoader(),clazz.getInterfaces(),<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä»£ç†æ¨¡å¼ä¸­çœŸå®å¯¹è±¡ç»§æ‰¿ä¸€ä¸ªæ¥å£å¦‚æœè¯´æ˜¯ä¸ºäº†åœ¨ä»£ç†ç±»ä¸­ç»Ÿä¸€ç®¡ç†ï¼Œé‚£ä¹ˆåœ¨ <code>JDKåŠ¨æ€ä»£ç†</code> ä¸­å¦‚æœè¢«ä»£ç†çš„å¯¹è±¡è¿˜å¿…é¡»å®ç°ä¸€ä¸ªæ¥å£å°±æœ‰ç‚¹ç¹çäº†ï¼Œä½†æ˜¯å¯¹äº Java è¯­è¨€æ¥è¯´å…¶å®ä¹Ÿæ²¡åŠæ³•ã€‚æˆ‘ä»¬éƒ½è®¤ä¸ºå¾ˆç¹ççš„ä¸€ä¸ªå®ç°ï¼ŒJDK å¼€å‘äººå‘˜åº”è¯¥ä¹Ÿä¼šæƒ³åˆ°è¿™ä¸€ç‚¹ã€‚</p><p>ä¸‹é¢å°±æ¥è§£é‡Šä¸‹ä¸ºä»€ä¹ˆåŠ¨æ€ä»£ç†å¿…é¡»å®ç°ä¸€ä¸ªæ¥å£ã€‚</p><h4 id="ä¸ºä»€ä¹ˆå¿…é¡»å®ç°ä¸€ä¸ªæ¥å£"><a href="#ä¸ºä»€ä¹ˆå¿…é¡»å®ç°ä¸€ä¸ªæ¥å£" class="headerlink" title="ä¸ºä»€ä¹ˆå¿…é¡»å®ç°ä¸€ä¸ªæ¥å£"></a>ä¸ºä»€ä¹ˆå¿…é¡»å®ç°ä¸€ä¸ªæ¥å£</h4><p>åœ¨å›ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œé¦–å…ˆè¦è¯´æ˜çš„æ˜¯ <code>JDKåŠ¨æ€ä»£ç†</code> å®ç°çš„åŸç†æ˜¯é‡æ–°ä¸ºå¯¹è±¡ç±»ç”Ÿæˆäº†ä¸€ä¸ªå­ç±»ï¼Œè¿™ä¸ªç±»ç”±äºæ˜¯ JDK è‡ªå·±ç”Ÿæˆçš„ï¼Œäºæ˜¯ä¼šä»¥<code>$</code>å¼€å¤´ï¼Œåœ¨ JDK æ–‡æ¡£ä¸­æœ‰å¦‚ä¸‹è¯´æ˜ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A proxy class has the following properties:</span><br><span class="line"></span><br><span class="line">Proxy classes are <span class="keyword">public</span>, <span class="keyword">final</span>, and not <span class="keyword">abstract</span>.</span><br><span class="line">The unqualified name of a proxy class is unspecified. The space of class names that begin with the string "$Proxy" should be, however, reserved for proxy classes.</span><br><span class="line">A proxy <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">reflect</span>.<span class="title">Proxy</span>.</span></span><br></pre></td></tr></table></figure></p><p>å…¶å®è¿˜æœ‰å¾ˆå¤šè¯´æ˜ï¼Œä½†æ˜¯æ¶‰åŠåˆ°æœ¬æ–‡çš„ä¹Ÿå°±ä¸Šé¢ä¸‰æ¡ã€‚</p><ol><li>proxyç±»æ˜¯éæŠ½è±¡ç±»ï¼Œä¸”ç”±<code>public final</code>ä¿®é¥°ã€‚</li><li>proxyç±»æ˜¯ä»¥<code>$Proxy</code>å¼€å¤´çš„åŠ ç±»çš„åç§°ã€‚</li><li>proxyç±»æ˜¯<code>java.lang.reflect.Proxy</code>çš„å­ç±»ã€‚</li></ol><p>é‚£ä¹ˆæ—¢ç„¶æ˜¯<code>$Proxy</code>å¼€å¤´çš„ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥å°†ç”Ÿæˆçš„å­ç±»æ‰“å°å‡ºæ¥å‘¢ï¼Ÿï¼Œå¦‚ä¸‹ä»£ç ï¼š</p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–°ç”Ÿæˆçš„ç±»å…¶å®æ˜¯ç›´æ¥ç»§æ‰¿äº† <code>Proxy</code> ç±»ï¼Œç”±äºJavaçš„å•ç»§æ‰¿æ–¹å¼ï¼Œæ­¤æ—¶å¦‚æœè¦è·å–å¯¹è±¡ç±»é‡Œé¢çš„æ–¹æ³•é‚£ä¹ˆå°±å¿…é¡»å®ç°ä¸€ä¸ªæ¥å£ï¼Œæ‰€ä»¥ä¹Ÿå°±å¯¹è±¡ç±»å¿…é¡»è¦å®ç°ä¸€ä¸ªæ¥å£ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Car car = (Car) <span class="keyword">new</span> ProxyTest().getInstance(<span class="keyword">new</span> Bus());</span><br></pre></td></tr></table></figure></p><p>é‚£ä¹ˆå½“æˆ‘ä»¬æ‰§è¡Œè¿™ä¸ªä»£ç çš„æ—¶å€™ç©¶ç«Ÿåœ¨æ‰§è¡Œä»€ä¹ˆå‘¢ï¼Ÿåœ¨è¿™é‡Œ debug æ¥è·Ÿè¸ªæºç è§£é‡Š JDK åˆ°åº•æ˜¯å¦‚ä½•ç”Ÿäº§ Proxy ä»£ç†ç±»çš„.</p><blockquote><p>newProxyInstanceæ–¹æ³•<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/newProxyInstance.png" alt=""></p></blockquote><p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œç›®å‰æš‚æ—¶éœ€è¦æ³¨æ„çº¢æ¡†ä¸­çš„æ–¹æ³•ï¼Œä»£ç†ç±»æ˜¯åœ¨è¯¥æ–¹æ³•é‡Œé¢æ˜¯ç”Ÿæˆçš„ã€‚</p><p><code>Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</code> è¿™ä¸€è¡Œä»£ç ï¼Œåœ¨è¿™é‡Œè¿”å›çš„æ˜¯ä¸€ä¸ª classï¼Œç„¶åé€šè¿‡åå°„æ¥åˆå§‹åŒ–è¿™ä¸ª classï¼Œæœ€åè¿™ä¸ª class å°±æ˜¯ JDK ç”Ÿæˆçš„ä»£ç†ç±»ã€‚</p><blockquote><p>getProxyClass0</p></blockquote><p>è€Œåœ¨ <code>getProxyClass0</code> æ–¹æ³•é‡Œé¢å°±æ˜¯é€šè¿‡ <code>proxyClassCache.get(loader, interfaces)</code>æ¥è·å– Proxyï¼Œå¦‚æœé‡Œé¢åŒ…å«è¯¥ classLoader åŠ è½½çš„ interface çš„è¯ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±æ˜¯å†åˆå§‹åŒ–ä¸€æ¬¡ï¼Œç„¶åè¿”å›ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,</span><br><span class="line">                                           Class&lt;?&gt;... interfaces) &#123;</span><br><span class="line">    <span class="keyword">if</span> (interfaces.length &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the proxy class defined by the given loader implementing</span></span><br><span class="line">    <span class="comment">// the given interfaces exists, this will simply return the cached copy;</span></span><br><span class="line">    <span class="comment">// otherwise, it will create the proxy class via the ProxyClassFactory</span></span><br><span class="line">    <span class="keyword">return</span> proxyClassCache.get(loader, interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>proxyClassCache.get(loader, interfaces)</p></blockquote><p>ä»è¿™ä¸ªæ–¹æ³•ä¹‹åå°±æ˜¯çœŸæ­£å¼€å§‹ç”Ÿæˆ Proxy ç±»çš„è¿‡ç¨‹ï¼Œç”±äºè¿™é‡Œé¢åŒ…å«ä¸€äº› Java8 çš„ lambdaè¡¨è¾¾å¼ ç”¨æ³•ï¼Œå¯¹äºä¸å¤ªäº†è§£çš„äººå¯èƒ½ä¼šæœ‰ç‚¹çœ‹ä¸æ‡‚ã€‚<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/proxy.png" alt=""></p><p>ä¸Šé¢çš„å›¾ç»™å‡ºäº†åˆå§‹åŒ– map çš„ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªmapçš„ç»“æ„å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Object, ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt;&gt; map</span><br><span class="line">        = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br></pre></td></tr></table></figure></p><p>ä¹Ÿå°±æ˜¯ä¸€ä¸ªä¸¤å±‚çš„ ConcurrentMapï¼Œè€Œä¹‹æ‰€ä»¥ä¸ºä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡æ˜¯è·Ÿå®ç°çš„æ¥å£ç›¸å…³çš„ï¼Œæ˜¯ç”±äºç¬¬ä¸€å±‚çš„ key æ˜¯ç”± classLoader æ‰€ç”Ÿæˆçš„ keyï¼Œè€Œç¬¬äºŒå±‚æµ‹è¯•keyXï¼Œä¸æ‰€å®ç°çš„æ¥å£æœ‰å…³ã€‚<br>å‰©ä¸‹çš„å°†ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;é¦–å…ˆä»£ç†æ¨¡å¼åˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ï¼Œç”±äºJDKé‡‡ç”¨çš„æ˜¯åŠ¨æ€ä»£ç†ï¼Œæ‰€ä»¥é™æ€ä»£ç†åœ¨è¿™é‡Œä¸å†ä»‹ç»ã€‚&lt;/p&gt;
&lt;h2 id=&quot;åŠ¨æ€ä»£ç†&quot;&gt;&lt;a hr
      
    
    </summary>
    
      <category term="Java" scheme="https://somersames.github.io/categories/Java/"/>
    
    
      <category term="åŠ¨æ€ä»£ç†" scheme="https://somersames.github.io/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>é‡æ¸©Javaä¸­String</title>
    <link href="https://somersames.github.io/2020/04/06/%E9%87%8D%E6%B8%A9Java%E4%B8%ADString/"/>
    <id>https://somersames.github.io/2020/04/06/é‡æ¸©Javaä¸­String/</id>
    <published>2020-04-06T13:41:39.000Z</published>
    <updated>2020-04-08T15:55:23.399Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡çš„å†…å®¹éƒ½æ˜¯åŸºäº JDK1.8 æ¥å†™çš„ï¼Œä¸»è¦æ˜¯å¤ä¹ ä¸‹ String ç±»çš„è®¾è®¡ã€‚</p><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>String æ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨å­—ç¬¦ä¸²çš„ç±»ï¼Œå…¶å†…éƒ¨æ˜¯é€šè¿‡ char æ•°ç»„æ¥å®ç°ï¼Œåœ¨ Java ä¸­ï¼Œ1byte = 8bitï¼Œ1char = 2byte, æ‰€ä»¥åœ¨ Java ä¸­ï¼ŒString çš„code pointæ˜¯16ä½ã€‚<br>String ç±»æ˜¯ç”± final å…³é”®å­—æ¥ä¿®é¥°çš„ï¼Œå› æ­¤è¡¨æ˜è¯¥ç±»ä¸å¯ä»¥è¢«ç»§æ‰¿ï¼ŒåŒæ—¶ String åˆå®ç°äº† Serializableã€Comparableã€CharSequenceæ¥å£ï¼Œè¡¨æ˜ String å¯ä»¥è¢«åºåˆ—åŒ–ï¼Œä»¥åŠä½¿ç”¨cpmpareToæ¥æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²çš„å€¼ã€‚</p><h2 id="å­—ç¬¦é›†ç¼–ç "><a href="#å­—ç¬¦é›†ç¼–ç " class="headerlink" title="å­—ç¬¦é›†ç¼–ç "></a>å­—ç¬¦é›†ç¼–ç </h2><h3 id="å†…ç "><a href="#å†…ç " class="headerlink" title="å†…ç "></a>å†…ç </h3><p>å†…ç æŒ‡çš„æ˜¯ç¨‹åºå†…éƒ¨è‡ªå·±ä½¿ç”¨çš„å­—ç¬¦é›†ï¼Œjavaä¸­æ˜¯ä»¥ <code>UTF-16</code> æ¥è¡¨ç¤ºçš„</p><blockquote><p>The Java programming language represents text in sequences of 16-bit code units, using the UTF-16 encoding.</p></blockquote><p>UTF-16æœ€å¤šå¯ä»¥è¡¨ç¤º 65535 ç§å­—ç¬¦ï¼Œé‚£ä¹ˆä¸åœ¨ 65535 ä¹‹å†…çš„å­—ç¬¦ï¼Œè¯¥å¦‚ä½•è¡¨ç¤ºå‘¢ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨ä¸¤ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºè¿™ä¸ªå­—ç¬¦ã€‚ä»¥ğŸ˜è¿™ä¸ªemojeä¸ºä¾‹å­ï¼šå…¶Codeçš„ç¼–ç æ˜¯<code>1F601</code>ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å…·ä½“æ–¹æ³•æ˜¯ï¼š</span><br><span class="line"></span><br><span class="line">Code Pointå‡å»<span class="number">0x10000</span>ï¼Œ å¾—åˆ°çš„å€¼æ˜¯é•¿åº¦ä¸º<span class="number">20</span>bitï¼ˆä¸è¶³çš„è¡¥<span class="number">0</span>ï¼‰ï¼›</span><br><span class="line">å°†å¾—åˆ°æ•°å€¼çš„é«˜ä½çš„<span class="number">10</span>æ¯”ç‰¹çš„å€¼ åŠ ä¸Š<span class="number">0xD800</span>çš„å‰<span class="number">6</span>ä½å¾—åˆ°ç¬¬ä¸€ä¸ªCode Unitã€‚</span><br><span class="line">æ­¥éª¤<span class="number">1</span>å¾—åˆ°æ•°å€¼çš„ä½ä½çš„<span class="number">10</span>æ¯”ç‰¹çš„å€¼ åŠ ä¸Š<span class="number">0xDC00</span>çš„å‰<span class="number">6</span>ä½å¾—åˆ°ç¬¬äºŒä¸ªCode Unitã€‚</span><br></pre></td></tr></table></figure></p><p>äºæ˜¯è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">1F</span>601 - <span class="number">0x10000</span> = <span class="number">1111011000000001</span></span><br><span class="line">ä¸æ»¡<span class="number">20</span>ä½çš„è¡¥<span class="number">0</span>ï¼›</span><br><span class="line">æ‰€ä»¥å¾—åˆ°ï¼š<span class="number">00001111011000000001</span>ã€‚</span><br><span class="line"><span class="number">0xD800</span>ï¼š<span class="number">1101100000000000</span></span><br><span class="line"><span class="number">0xDC00</span>ï¼š<span class="number">1101110000000000</span></span><br><span class="line">äºæ˜¯é«˜ä½çš„ä»£ç†å°±æ˜¯ï¼š<span class="number">1101100000111101</span></span><br><span class="line">äºæ˜¯ä½ä½çš„ä»£ç†å°±æ˜¯ï¼š<span class="number">1101111000000001</span></span><br><span class="line">æœ€ç»ˆå¾—åˆ°ï¼šd83d,de01</span><br></pre></td></tr></table></figure></p><p>åœ¨ String çš„ä»£ç ä¸­ä½“ç°å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">codePointAt</span><span class="params">(CharSequence seq, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c1 = seq.charAt(index);</span><br><span class="line">    <span class="keyword">if</span> (isHighSurrogate(c1) &amp;&amp; ++index &lt; seq.length()) &#123;</span><br><span class="line">        <span class="keyword">char</span> c2 = seq.charAt(index);</span><br><span class="line">        <span class="keyword">if</span> (isLowSurrogate(c2)) &#123;</span><br><span class="line">            <span class="keyword">return</span> toCodePoint(c1, c2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">toCodePoint</span><span class="params">(<span class="keyword">char</span> high, <span class="keyword">char</span> low)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Optimized form of:</span></span><br><span class="line">    <span class="comment">// return ((high - MIN_HIGH_SURROGATE) &lt;&lt; 10)</span></span><br><span class="line">    <span class="comment">//         + (low - MIN_LOW_SURROGATE)</span></span><br><span class="line">    <span class="comment">//         + MIN_SUPPLEMENTARY_CODE_POINT;</span></span><br><span class="line">    <span class="keyword">return</span> ((high &lt;&lt; <span class="number">10</span>) + low) + (MIN_SUPPLEMENTARY_CODE_POINT</span><br><span class="line">                                    - (MIN_HIGH_SURROGATE &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                                    - MIN_LOW_SURROGATE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>æ³¨æ„è¿™ä¸ªhigh &lt;&lt; 10æ˜¯å› ä¸ºcodeè½¬æˆ16è¿›åˆ¶çš„æ—¶å€™ï¼Œè¿˜è¡¥äº†4ä¸ª0<br>å½“ String åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ª code point çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦æ˜¯é«˜ä½ä»£ç†ï¼Œæ˜¯çš„è¯åœ¨åˆ¤æ–­ä¸‹ä¸€ä¸ªå­—èŠ‚æ˜¯å¦æ˜¯ä½ä½ä»£ç†ï¼Œæ˜¯çš„å°±é€šè¿‡<code>toCodePoint</code>æ¥æ¨å¯¼å‡ºåŸæ¥çš„codeã€‚</p></blockquote><h2 id="readResolveæ–¹æ³•"><a href="#readResolveæ–¹æ³•" class="headerlink" title="readResolveæ–¹æ³•"></a>readResolveæ–¹æ³•</h2><p>è¿™ä¸ªæ–¹æ³•æ˜¯ä¸ºäº†ä¿è¯åºåˆ—åŒ–çš„æ—¶å€™ï¼Œé¿å…ç”Ÿæˆå¤šä¸ª String å¯¹è±¡ï¼Œé¦–å…ˆå½“ä¸€ä¸ªå¯¹è±¡è¢«ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå…¶è°ƒç”¨é“¾å¦‚ä¸‹:</p><blockquote><p>ObjectInputStream -&gt; readObject() -&gt; readObject0(boolean unshared) -&gt; readOrdinaryObject(boolean unshared) </p></blockquote><p>åœ¨<code>readOrdinaryObject</code>ä¸­ï¼Œä¸»è¦æ˜¯éœ€è¦æ³¨æ„å¦‚ä¸‹ä¸¤æ®µä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Object obj;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    obj = desc.isInstantiable() ? desc.newInstance() : <span class="keyword">null</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> (IOException) <span class="keyword">new</span> InvalidClassException(</span><br><span class="line">        desc.forClass().getName(),</span><br><span class="line">        <span class="string">"unable to create instance"</span>).initCause(ex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (obj != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">    handles.lookupException(passHandle) == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">    desc.hasReadResolveMethod())</span><br><span class="line">&#123;</span><br><span class="line">    Object rep = desc.invokeReadResolve(obj);</span><br><span class="line">    <span class="keyword">if</span> (unshared &amp;&amp; rep.getClass().isArray()) &#123;</span><br><span class="line">        rep = cloneArray(rep);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rep != obj) &#123;</span><br><span class="line">        <span class="comment">// Filter the replacement object</span></span><br><span class="line">        <span class="keyword">if</span> (rep != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rep.getClass().isArray()) &#123;</span><br><span class="line">                filterCheck(rep.getClass(), Array.getLength(rep));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                filterCheck(rep.getClass(), -<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handles.setObject(passHandle, obj = rep);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ObjectStreamClassï¼š</span><br><span class="line">readResolveMethod = getInheritableMethod(cl, <span class="string">"readResolve"</span>, <span class="keyword">null</span>, Object.class);</span><br></pre></td></tr></table></figure></p><p>å¦‚æœæ²¡æœ‰é‡å†™<code>readResolve</code>çš„è¯ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¾¿ä¼šç›´æ¥è¿”å›<code>newInstance</code> ç”Ÿæˆçš„æ–°å¯¹è±¡äº†ã€‚</p><h2 id="final-çš„ä½¿ç”¨"><a href="#final-çš„ä½¿ç”¨" class="headerlink" title="final çš„ä½¿ç”¨"></a>final çš„ä½¿ç”¨</h2><p>åœ¨ String ä¸­ï¼Œå¯ä»¥çœ‹åˆ°éœ€è¦åœ°æ–¹ä½¿ç”¨åˆ°äº† final å­—æ®µï¼Œä¾‹å¦‚ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">char</span> value[];</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectStreamField[] serialPersistentFields = <span class="keyword">new</span> ObjectStreamField[<span class="number">0</span>];</span><br></pre></td></tr></table></figure></p><p>è¿™äº›éƒ½å¥½ç†è§£ï¼Œä½†æ˜¯å…¶ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•é‡Œé¢çš„å˜é‡åå´ä¹Ÿä½¿ç”¨äº†finalï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">indexOfSupplementary</span><span class="params">(<span class="keyword">int</span> ch, <span class="keyword">int</span> fromIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Character.isValidCodePoint(ch)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">char</span>[] value = <span class="keyword">this</span>.value;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">char</span> hi = Character.highSurrogate(ch);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">char</span> lo = Character.lowSurrogate(ch);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> max = value.length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = fromIndex; i &lt; max; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value[i] == hi &amp;&amp; value[i + <span class="number">1</span>] == lo) &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨è¿™é‡Œæˆ‘ä¸ªäººæ„Ÿè§‰å…¶å®æ˜¯æ²¡ä»€ä¹ˆä½œç”¨çš„ï¼Œå› ä¸ºæ–¹æ³•å†…éƒ¨çš„<code>value</code>ä¼šéšç€<code>this.value</code>çš„å˜åŒ–è€Œå˜åŒ–(ä¸€èˆ¬ä¸å¯èƒ½)ï¼Œæ‰€ä»¥è¿™é‡Œçš„finalï¼Œä¹Ÿå°±<code>hi</code>å’Œ<code>lo</code>ä»¥åŠ<code>max</code>æœ‰ä½œç”¨ï¼Œå¯ä»¥ä¿è¯åŒä¸€ä¸ªæ–¹æ³•å†…éƒ¨ï¼Œ<br>åœ¨å¤šçº¿ç¨‹çš„ç«æ€æ¡ä»¶ä¸‹ä¸æ”¹å˜ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ¬æ–‡çš„å†…å®¹éƒ½æ˜¯åŸºäº JDK1.8 æ¥å†™çš„ï¼Œä¸»è¦æ˜¯å¤ä¹ ä¸‹ String ç±»çš„è®¾è®¡ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;String æ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨å­—ç¬¦ä¸²çš„ç±»ï¼Œå…¶å†…
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>SpringBootä¸­å¼‚æ­¥çº¿ç¨‹çš„å¤„ç†</title>
    <link href="https://somersames.github.io/2020/04/02/SpringBoot%E4%B8%AD%E5%BC%82%E6%AD%A5%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%A4%84%E7%90%86/"/>
    <id>https://somersames.github.io/2020/04/02/SpringBootä¸­å¼‚æ­¥çº¿ç¨‹çš„å¤„ç†/</id>
    <published>2020-04-02T15:46:30.000Z</published>
    <updated>2020-04-02T15:46:59.043Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å·¥ä½œæˆ–è€…å­¦ä¹ çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä¼šæ¥è§¦åˆ°å¼‚æ­¥ç¼–ç¨‹ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯é€šè¿‡æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œç„¶åè°ƒç”¨<code>submit</code>æ–¹æ³•æˆ–è€…<code>execute</code>æ–¹æ³•æ¥æ‰§è¡Œã€‚å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">simpleThreadPool</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ExecutorService executor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">4</span>,<span class="number">5</span>,<span class="number">0</span>, TimeUnit.SECONDS,<span class="keyword">new</span> LinkedBlockingDeque&lt;Runnable&gt;());</span><br><span class="line">        executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"run"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Callable&lt;String&gt; callable = <span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"callable"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Future future = executor.submit(callable);</span><br><span class="line">        System.out.println(future.get());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨Springbootä¸­å…¶å®ä¹Ÿå¯ä»¥è¿™æ ·åšï¼Œä½†æ˜¯ä¸åˆ©äºåæœŸçš„ç»´æŠ¤ï¼ŒåŠ å…¥åæœŸéœ€è¦æŠŠ <code>runable</code> çš„æ–¹æ³•ä¿®æ”¹ä¸ºåŒæ­¥ç±»å‹çš„ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±éœ€è¦å¤§é‡çš„æ”¹åŠ¨ä»£ç ï¼Œå¦‚æœè¯´å¾ˆå¤šåœ°æ–¹éƒ½ç”¨åˆ°çš„äº†çš„è¯ï¼Œå°±ä¼šå¾ˆå®¹æ˜“æ¼æ‰äº†ä¸€å¤„å¯¼è‡´bugçš„äº§ç”Ÿã€‚</p><h2 id="Springçš„è§£å†³æ–¹æ³•"><a href="#Springçš„è§£å†³æ–¹æ³•" class="headerlink" title="Springçš„è§£å†³æ–¹æ³•"></a>Springçš„è§£å†³æ–¹æ³•</h2><h3 id="ä¸éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥"><a href="#ä¸éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥" class="headerlink" title="ä¸éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥"></a>ä¸éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥</h3><p>å…¶å®åœ¨Springä¸­å°±æœ‰ç±»ä¼¼çš„è§£å†³æ–¹æ³•ï¼Œåªä¸è¿‡éœ€è¦æˆ‘ä»¬è‡ªå·±é…ç½®ã€‚<br>é¦–å…ˆæ–°å»ºä¸€ä¸ªé…ç½®ç±»ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">asyncPool</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">100</span>);</span><br><span class="line">        executor.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">30</span>);</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨è¿™é‡Œæœ€å¥½çš„åšæ³•æ˜¯å°†å…¶é…ç½®åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ä»¥åè°ƒæ•´å°±ä¸éœ€è¦æ”¹åŠ¨ä»£ç ï¼Œä¸è¿‡æ­¤å¤„ä¸ºäº†æ¼”ç¤ºï¼Œä¹Ÿå°±ç›´æ¥å›ºå®šäº†ã€‚</p><blockquote><p>æ–°å»ºä¸€ä¸ª <code>Service</code> æµ‹è¯•ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"A"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayB</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.currentThread().sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(<span class="string">"B"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>è°ƒç”¨</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AsyncService asyncService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noReturnAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        asyncService.sayB();</span><br><span class="line">        asyncService.sayA();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ–°å»ºä¸€ä¸ªæµ‹è¯•ç±»</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = AsyncApplication.class)</span><br><span class="line"><span class="meta">@WebAppConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TestService testService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noReturnAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        testService.noReturnAsync();</span><br><span class="line">        Thread.currentThread().sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åœ¨æ§åˆ¶å°ä¼šå‘ç°æ˜¯å…ˆæ‰“å°çš„ Aï¼Œç„¶åå†æ‰“å°çš„ Bï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥è‚¯å®šç¡®è®¤çš„æ˜¯è‚¯å®šæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚</p><p>ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ‰ä¸€ä¸ªä¸šåŠ¡æ–¹æ³•å¹¶ä¸æ˜¯é€šç”¨çš„ï¼Œå‡å¦‚æœ‰ä¸€ä¸ª <code>C</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ TestServcie ç±»é‡Œé¢å•ç‹¬ä¸€ä¸ªäººä½¿ç”¨çš„ï¼Œè¿™ä¸ªæƒ…å†µä¸‹å¦‚æœéœ€è¦åœ¨ TestServicde é‡Œé¢ä½¿ç”¨çš„è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦é€šè¿‡ Aop æ¥è·å–å½“å‰çš„ä»£ç†å¯¹è±¡ã€‚å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AsyncService asyncService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noReturnAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        asyncService.sayB();</span><br><span class="line">        asyncService.sayA();</span><br><span class="line">        C();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">C</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"C"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¦‚æœè¿™æ ·å†™çš„è¯ï¼ŒCæ–¹æ³•å°±ä¼šè¢«å½“æˆä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œäºæ˜¯å°±éœ€è¦é€šè¿‡ <code>AopContext.currentProxy()</code> æ¥åˆ‡æ¢ä»£ç†å¯¹è±¡<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AsyncService asyncService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noReturnAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        asyncService.sayB();</span><br><span class="line">        asyncService.sayA();</span><br><span class="line">        ((TestService) AopContext.currentProxy()).C();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">C</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"C"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¦‚æœæ˜¯ä½¿ç”¨ <code>((TestService) AopContext.currentProxy()).C()</code> çš„è¯ï¼Œåˆ™å¿…é¡»è¦æ–°å¢å¦‚ä¸‹Bean<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        BeanDefinition beanDefinition = beanFactory.getBeanDefinition(org.springframework.scheduling.config.TaskManagementConfigUtils.ASYNC_ANNOTATION_PROCESSOR_BEAN_NAME);</span><br><span class="line">        beanDefinition.getPropertyValues().add(<span class="string">"exposeProxy"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥"><a href="#éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥" class="headerlink" title="éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥"></a>éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥</h3><p>ä¸Šé¢ä»‹ç»çš„éƒ½æ˜¯ä¸éœ€è¦è¿”å›å€¼çš„å¼‚æ­¥æ–¹æ³•ï¼Œé‚£ä¹ˆå…¶å®å¾ˆå¤šåœºæ™¯ä¸‹éƒ½æ˜¯éœ€è¦è¿”å›å€¼çš„ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ¥å®ç°:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">futureA</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.currentThread().sleep(<span class="number">1100</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;String&gt;(<span class="string">"A"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>è°ƒç”¨æ–¹å¼è¿˜æ˜¯å’Œä¹‹å‰ä¸€ç›´ï¼Œå°±æ˜¯æœ€åéœ€è¦ç”¨ä¸€ä¸ª <code>Future</code> æ¥æ¥ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noReturnAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">        Future future = asyncService.futureA();</span><br><span class="line">        asyncService.sayB();</span><br><span class="line">        asyncService.sayA();</span><br><span class="line">        System.out.println(future.get());</span><br><span class="line">        ((TestService) AopContext.currentProxy()).C();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å·¥ä½œæˆ–è€…å­¦ä¹ çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä¼šæ¥è§¦åˆ°å¼‚æ­¥ç¼–ç¨‹ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯é€šè¿‡æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œç„¶åè°ƒç”¨&lt;code&gt;submit&lt;/code&gt;æ–¹æ³•æˆ–è€…&lt;code&gt;execute&lt;/code&gt;æ–¹æ³•æ¥æ‰§è¡Œã€‚å¦‚ä¸‹ï¼š&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;tabl
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://somersames.github.io/categories/SpringBoot/"/>
    
    
      <category term="SpringBoot" scheme="https://somersames.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>ES7ä¸­å¤§å°å†™ä¸æ•æ„Ÿçš„æ¨¡ç³ŠåŒ¹é…</title>
    <link href="https://somersames.github.io/2020/03/20/ES7%E4%B8%AD%E5%A4%A7%E5%B0%8F%E5%86%99%E4%B8%8D%E6%95%8F%E6%84%9F%E7%9A%84%E6%A8%A1%E7%B3%8A%E5%8C%B9%E9%85%8D/"/>
    <id>https://somersames.github.io/2020/03/20/ES7ä¸­å¤§å°å†™ä¸æ•æ„Ÿçš„æ¨¡ç³ŠåŒ¹é…/</id>
    <published>2020-03-20T14:14:24.000Z</published>
    <updated>2020-04-02T15:46:07.017Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ES7.0ä¸­</p><p>å¦‚æœè¦å®ç°å¤§å°å†™çš„æ¨¡ç³ŠæŸ¥è¯¢ï¼Œåˆ™é¦–å…ˆå¿…é¡»è¦è‡ªå®šä¹‰ <code>analysis</code>ï¼Œåœ¨è‡ªå®šä¹‰çš„ <code>analysis</code> é‡Œé¢ï¼Œå¦‚æœæ˜¯é’ˆå¯¹keywordç±»å‹çš„å­—æ®µï¼Œ analysis è¦å®šä¹‰æˆ normalizerï¼Œè€Œå¯¹äºtextç±»å‹çš„è¯ï¼Œåˆ™éœ€è¦ä¸ºanalyzerã€‚å¦‚ä¸‹æ¼”ç¤ºçš„æ˜¯<code>normalizer</code>ç±»å‹çš„å®šä¹‰ã€‚</p><blockquote><p>æ–°å»ºç´¢å¼•<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"normalizer"</span>: &#123;</span><br><span class="line">        <span class="attr">"self_normalizer"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"custom"</span>,</span><br><span class="line">          <span class="attr">"char_filter"</span>: [],</span><br><span class="line">          <span class="attr">"filter"</span>: [</span><br><span class="line">            <span class="string">"lowercase"</span>,</span><br><span class="line">            <span class="string">"asciifolding"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"mappings"</span>:&#123;</span><br><span class="line">    <span class="attr">"properties"</span>:&#123;</span><br><span class="line">      <span class="attr">"field_1"</span>:&#123;</span><br><span class="line">        <span class="attr">"type"</span>:<span class="string">"keyword"</span>,</span><br><span class="line">        <span class="attr">"normalizer"</span>: <span class="string">"self_normalizer"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>æ­¤æ—¶å‘ESä¸­æ–°å¢å‡ æ¡æ•°æ®ï¼š<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"took"</span>: <span class="number">6</span>,</span><br><span class="line"><span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">"_shards"</span>: &#123;</span><br><span class="line"><span class="attr">"total"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="attr">"skipped"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"hits"</span>: &#123;</span><br><span class="line"><span class="attr">"total"</span>: &#123;</span><br><span class="line"><span class="attr">"value"</span>: <span class="number">4</span>,</span><br><span class="line"><span class="attr">"relation"</span>: <span class="string">"eq"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"max_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="attr">"hits"</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="attr">"_id"</span>: <span class="string">"2"</span>,</span><br><span class="line"><span class="attr">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="attr">"_source"</span>: &#123;</span><br><span class="line"><span class="attr">"field_1"</span>: <span class="string">"abc"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line"><span class="attr">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="attr">"_source"</span>: &#123;</span><br><span class="line"><span class="attr">"field_1"</span>: <span class="string">"ABC"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="attr">"_id"</span>: <span class="string">"3"</span>,</span><br><span class="line"><span class="attr">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="attr">"_source"</span>: &#123;</span><br><span class="line"><span class="attr">"field_1"</span>: <span class="string">"aBC"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="attr">"_id"</span>: <span class="string">"4"</span>,</span><br><span class="line"><span class="attr">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="attr">"_source"</span>: &#123;</span><br><span class="line"><span class="attr">"field_1"</span>: <span class="string">"Abc"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„å¯¹äº<code>field_1</code>ï¼Œåœ¨Esä¸­çš„å€¼å¤§å°å†™éƒ½æœ‰çš„ï¼Œæ­¤æ—¶è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢ï¼š<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"bool"</span>: &#123;</span><br><span class="line">            <span class="attr">"must"</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">"wildcard"</span>: &#123;</span><br><span class="line">                  <span class="attr">"field_1"</span>: &#123;</span><br><span class="line">                    <span class="attr">"value"</span>: <span class="string">"*a*"</span>,</span><br><span class="line">                    <span class="attr">"boost"</span>: <span class="number">1</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"adjust_pure_negative"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"boost"</span>: <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"adjust_pure_negative"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"boost"</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>è¿”å›å€¼<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"took"</span>: <span class="number">9</span>,</span><br><span class="line"><span class="string">"timed_out"</span>: <span class="keyword">false</span>,</span><br><span class="line"><span class="string">"_shards"</span>: &#123;</span><br><span class="line"><span class="string">"total"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">"successful"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">"skipped"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="string">"failed"</span>: <span class="number">0</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"hits"</span>: &#123;</span><br><span class="line"><span class="string">"total"</span>: &#123;</span><br><span class="line"><span class="string">"value"</span>: <span class="number">4</span>,</span><br><span class="line"><span class="string">"relation"</span>: <span class="string">"eq"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"max_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="string">"hits"</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="string">"_id"</span>: <span class="string">"2"</span>,</span><br><span class="line"><span class="string">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="string">"_source"</span>: &#123;</span><br><span class="line"><span class="string">"field_1"</span>: <span class="string">"abc"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="string">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line"><span class="string">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="string">"_source"</span>: &#123;</span><br><span class="line"><span class="string">"field_1"</span>: <span class="string">"ABC"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="string">"_id"</span>: <span class="string">"3"</span>,</span><br><span class="line"><span class="string">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="string">"_source"</span>: &#123;</span><br><span class="line"><span class="string">"field_1"</span>: <span class="string">"aBC"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="string">"_id"</span>: <span class="string">"4"</span>,</span><br><span class="line"><span class="string">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="string">"_source"</span>: &#123;</span><br><span class="line"><span class="string">"field_1"</span>: <span class="string">"Abc"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ES7.0ä¸­&lt;/p&gt;
&lt;p&gt;å¦‚æœè¦å®ç°å¤§å°å†™çš„æ¨¡ç³ŠæŸ¥è¯¢ï¼Œåˆ™é¦–å…ˆå¿…é¡»è¦è‡ªå®šä¹‰ &lt;code&gt;analysis&lt;/code&gt;ï¼Œåœ¨è‡ªå®šä¹‰çš„ &lt;code&gt;analysis&lt;/code&gt; é‡Œé¢ï¼Œå¦‚æœæ˜¯é’ˆå¯¹keywordç±»å‹çš„å­—æ®µï¼Œ analysis è¦å®šä¹‰æˆ normalizerï¼Œè€Œ
      
    
    </summary>
    
      <category term="ElasticSearch" scheme="https://somersames.github.io/categories/ElasticSearch/"/>
    
    
      <category term="ElasticSearch" scheme="https://somersames.github.io/tags/ElasticSearch/"/>
    
  </entry>
  
  <entry>
    <title>springbootå¤šæ•°æ®æº-sqlSessionFactory</title>
    <link href="https://somersames.github.io/2020/03/19/springboot%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90-sqlSessionFactory/"/>
    <id>https://somersames.github.io/2020/03/19/springbootå¤šæ•°æ®æº-sqlSessionFactory/</id>
    <published>2020-03-19T11:57:04.000Z</published>
    <updated>2020-03-20T14:08:57.710Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨SpringBootä¸­ï¼ŒåŠ¨æ€çš„åˆ‡æ¢æ•°æ®æºçš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é€šè¿‡<code>AbstractRoutingDataSource</code>æ¥é€šè¿‡æ³¨è§£å®ç°ï¼Œå¦ä¸€ç§åˆ™æ˜¯é€šè¿‡é…ç½®ä¸åŒçš„<code>SqlSessionFactory</code>æ¥è¯»å–ä¸åŒæ–‡ä»¶å¤¹çš„mapperï¼Œä»è€Œå®ç°å¤šæ•°æ®æºã€‚<br>ä»£ç å¦‚ä¸‹ï¼š</p><blockquote><p>DataSourceOneConfig</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = &#123;<span class="string">"xyz.somersames.dao.one"</span>&#125; ,sqlSessionTemplateRef = <span class="string">"dataSourceOneSqlSessionTemplate"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceOneConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceOneT"</span>)</span><br><span class="line">    <span class="comment">// è¿™é‡Œåé¢åŠ ä¸€ä¸ªTæ˜¯é˜²æ­¢Springå‡ºç°skiped mapperFactoryBean é”™è¯¯ï¼Œå¯¼è‡´æ— æ³•æ³¨å…¥</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.one"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceOneSqlSessionFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">setSqlSessionFactory</span><span class="params">(@Qualifier(<span class="string">"dataSourceOneT"</span>)</span> DataSource dataSource) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSource);</span><br><span class="line">        bean.setMapperLocations(<span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string">"classpath:mapper/one/*.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceOneTransactionManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">setTransactionManager</span><span class="params">(@Qualifier(<span class="string">"dataSourceOneT"</span>)</span> DataSource dataSource) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceOneSqlSessionTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionTemplate <span class="title">setSqlSessionTemplate</span><span class="params">(@Qualifier(<span class="string">"dataSourceOneSqlSessionFactory"</span>)</span> SqlSessionFactory sqlSessionFactory) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>DataSourceTwoConfig</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = &#123;<span class="string">"xyz.somersames.dao.two"</span>&#125; ,sqlSessionTemplateRef = <span class="string">"dataSourceTwoSqlSessionTemplate"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceTwoConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceTwoT"</span>)</span><br><span class="line">    <span class="comment">// è¿™é‡Œåé¢åŠ ä¸€ä¸ªTæ˜¯é˜²æ­¢Springå‡ºç°skiped mapperFactoryBean é”™è¯¯ï¼Œå¯¼è‡´æ— æ³•æ³¨å…¥</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.two"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceTwoSqlSessionFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">setSqlSessionFactory</span><span class="params">(@Qualifier(<span class="string">"dataSourceTwoT"</span>)</span> DataSource dataSource) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSource);</span><br><span class="line">        bean.setMapperLocations(<span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string">"classpath:mapper/two/*.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceTwoTransactionManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">setTransactionManager</span><span class="params">(@Qualifier(<span class="string">"dataSourceTwoT"</span>)</span> DataSource dataSource) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceTwoSqlSessionTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionTemplate <span class="title">setSqlSessionTemplate</span><span class="params">(@Qualifier(<span class="string">"dataSourceTwoSqlSessionFactory"</span>)</span> SqlSessionFactory sqlSessionFactory) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ·»åŠ äº†è¿™ä¸¤ä¸ªé…ç½®ä»¥åï¼ŒdataSourceOneT ä¼šæ‰«æ <code>mapper/one</code> ä¸‹é¢çš„ xml æ–‡ä»¶ï¼Œè€Œ dataSourceTwoT ä¼šæ‰«æ <code>mapper/two</code> ä¸‹é¢çš„ xml æ–‡ä»¶ã€‚<br>ç„¶åæ·»åŠ é…ç½®æ–‡ä»¶</p><blockquote><p>application.yml</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8091</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    one:</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      password:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">jdbc:mysql://localhost:3306/test?useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">    two:</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      password:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">jdbc:mysql://localhost:3306/test_lock?useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œé¡ºå¸¦è¯´ä¸€å¥ï¼ŒSqlSessionFactory è´Ÿè´£æ‰“å¼€ SqlSessionï¼Œä¸€ä¸ªSqlSessionä»£è¡¨çš„å°±æ˜¯ä¸€æ¬¡å›è¯ï¼Œä½†æ˜¯å¦‚æœä½ åœ¨æ–¹æ³•ä¸ŠåŠ äº†ä¸€ä¸ª <code>@Transactional</code> æ³¨è§£ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•é‡Œé¢çš„æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½ä¼šè®¤ä¸ºæ˜¯ä¸€ä¸ªSqlSession</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨SpringBootä¸­ï¼ŒåŠ¨æ€çš„åˆ‡æ¢æ•°æ®æºçš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é€šè¿‡&lt;code&gt;AbstractRoutingDataSource&lt;/code&gt;æ¥é€šè¿‡æ³¨è§£å®ç°ï¼Œå¦ä¸€ç§åˆ™æ˜¯é€šè¿‡é…ç½®ä¸åŒçš„&lt;code&gt;SqlSessionFactory&lt;/code&gt;æ¥è¯»å–ä¸åŒæ–‡ä»¶å¤¹çš„mapperï¼Œ
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://somersames.github.io/categories/SpringBoot/"/>
    
    
      <category term="SpringBoot" scheme="https://somersames.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot2.xæ˜¯æ€æ ·åªåˆå§‹åŒ–LettuceConnectionFactoryçš„å‘¢</title>
    <link href="https://somersames.github.io/2020/01/05/SpringBoot2-x%E6%98%AF%E6%80%8E%E6%A0%B7%E5%8F%AA%E5%88%9D%E5%A7%8B%E5%8C%96LettuceConnectionFactory%E7%9A%84%E5%91%A2/"/>
    <id>https://somersames.github.io/2020/01/05/SpringBoot2-xæ˜¯æ€æ ·åªåˆå§‹åŒ–LettuceConnectionFactoryçš„å‘¢/</id>
    <published>2020-01-05T07:22:19.000Z</published>
    <updated>2020-01-05T07:27:44.880Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SpringBoot1-5ä½¿ç”¨Rediså’Œ2-xçš„åŒºåˆ«"><a href="#SpringBoot1-5ä½¿ç”¨Rediså’Œ2-xçš„åŒºåˆ«" class="headerlink" title="SpringBoot1.5ä½¿ç”¨Rediså’Œ2.xçš„åŒºåˆ«"></a>SpringBoot1.5ä½¿ç”¨Rediså’Œ2.xçš„åŒºåˆ«</h2><p>åœ¨ SpringBoot1.5 çš„ç‰ˆæœ¬çš„æ—¶å€™ï¼Œå¦‚æœè¦åˆ›å»ºä¸€ä¸ª RedisTemplate çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä½¿ç”¨å¦‚ä¸‹ä»£ç :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;String,Object&gt; <span class="title">redisTemplate</span><span class="params">(JedisConnectionFactory jedisConnectionFactory)</span></span>&#123;</span><br><span class="line">        RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(jedisConnectionFactory);</span><br><span class="line">        <span class="comment">// æ·»åŠ åºåˆ—åŒ–ä»£ç </span></span><br><span class="line">        <span class="keyword">return</span> redisTemplateï¼›</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç„¶ååœ¨ä¸šåŠ¡ç±»ä¸­ç›´æ¥é€šè¿‡ <code>@Autowired</code> æ³¨è§£æ¥è°ƒç”¨ redisTemplateï¼Œä½†æ˜¯å¦‚æœå°† SpringBoot1.5 å‡çº§åˆ° 2.0 ä¹‹åï¼Œä½ ä¼šå‘ç°è¿™æ ·å†™çš„è¯ï¼ŒSpringBoot å¯åŠ¨çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚æŠ¥é”™å†…å®¹å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The following candidates were found but could not be injected:</span><br><span class="line">- Bean method <span class="string">'redisConnectionFactory'</span> in <span class="string">'JedisConnectionConfiguration'</span> not loaded because <span class="meta">@ConditionalOnBean</span> (types: org.springframework.data.redis.connection.RedisConnectionFactory; SearchStrategy: all) found beans of type <span class="string">'org.springframework.data.redis.connection.RedisConnectionFactory'</span> redisConnectionFactory</span><br><span class="line">    </span><br><span class="line">Consider revisiting the entries above or defining a bean of type <span class="string">'org.springframework.data.redis.connection.jedis.JedisConnectionFactory'</span> in your configuration.</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªæç¤ºè¯´æ˜äº† <code>redisConnectionFactory</code> æ²¡æœ‰è¢«åŠ è½½åˆ°ï¼Œè¿™ä¸ªæ—¶å€™å…ˆå»å®˜æ–¹æ–‡æ¡£ä¸Šçœ‹ä¸‹ changelogï¼Œç„¶ååœ¨çœ‹ä¸‹æ˜¯ä¸æ˜¯æœ‰ä»€ä¹ˆå˜åŒ–ã€‚<br><a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.0-Migration-Guide#redis" target="_blank" rel="noopener">SpringBoot1.xå‡çº§åˆ°2.Xçš„ç®€ä»‹</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Redis</span><br><span class="line">Lettuce is now used instead of Jedis as the Redis driver when you use spring-boot-starter-data-redis. If you are using higher level Spring Data constructs you should find that the change is transparent.</span><br><span class="line"></span><br><span class="line">We still support Jedis. Switch dependencies <span class="keyword">if</span> you prefer Jedis by excluding io.lettuce:lettuce-core and adding redis.clients:jedis instead.</span><br><span class="line"></span><br><span class="line">Connection pooling is optional and, <span class="keyword">if</span> you are using it, you now need to add commons-pool2 yourself as Lettuce, contrary to Jedis, does not bring it transitively.</span><br></pre></td></tr></table></figure></p><p>ä¹Ÿå°±æ˜¯è¯´ SpringBoot2.x å·²ç»å°† LettuceConnectionFactory ä½œä¸ºå®˜æ–¹çš„ Redis è¿æ¥å·¥å…·äº†ï¼Œé‚£ä¹ˆå°è¯•ç€å°† <code>LettuceConnectionFactory</code> ä½œä¸ºé‚£ä¸ª redisTemplate çš„å…¥å‚ï¼Œæœ€åè°ƒæ•´å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;String,Object&gt; <span class="title">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span></span>&#123;</span><br><span class="line">    RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">    redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–ä»£ç </span></span><br><span class="line">    <span class="keyword">return</span> redisTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>äºæ˜¯å¯åŠ¨å°±ä¸å†æŠ¥é”™äº†ã€‚è€Œä¸”ä¹Ÿå¯ä»¥æ­£å¸¸çš„ä½¿ç”¨ã€‚ä½†æ˜¯å¦‚æœä½ è¿˜æ˜¯æƒ³ä½¿ç”¨ Jedis çš„è¯ï¼Œç›´æ¥ exclued <code>io.lettuce:lettuce-core</code> å³å¯ã€‚</p><h2 id="ä¸ºä»€ä¹ˆåœ¨SpringBoot2-xä¸­ä¸¤ä¸ªRedisConnectionFactoryåªä¼šåŠ è½½ä¸€ä¸ª"><a href="#ä¸ºä»€ä¹ˆåœ¨SpringBoot2-xä¸­ä¸¤ä¸ªRedisConnectionFactoryåªä¼šåŠ è½½ä¸€ä¸ª" class="headerlink" title="ä¸ºä»€ä¹ˆåœ¨SpringBoot2.xä¸­ä¸¤ä¸ªRedisConnectionFactoryåªä¼šåŠ è½½ä¸€ä¸ª"></a>ä¸ºä»€ä¹ˆåœ¨SpringBoot2.xä¸­ä¸¤ä¸ªRedisConnectionFactoryåªä¼šåŠ è½½ä¸€ä¸ª</h2><h3 id="SpringBoot2-xä¸­åŠ è½½çš„åŠ è½½æœºåˆ¶redisConnectionFactoryçš„å®ç°"><a href="#SpringBoot2-xä¸­åŠ è½½çš„åŠ è½½æœºåˆ¶redisConnectionFactoryçš„å®ç°" class="headerlink" title="SpringBoot2.xä¸­åŠ è½½çš„åŠ è½½æœºåˆ¶redisConnectionFactoryçš„å®ç°"></a>SpringBoot2.xä¸­åŠ è½½çš„åŠ è½½æœºåˆ¶redisConnectionFactoryçš„å®ç°</h3><p>é¦–å…ˆ Redis çš„ä¸€äº›é…ç½®éƒ½æ˜¯ä¾èµ–äº <code>RedisAutoConfiguration</code>ï¼Œè¿™ä¸ªç±»æ˜¯åœ¨ <code>spring-boot-autoconfigure</code> é‡Œé¢ï¼Œé¦–å…ˆçœ‹ä¸‹è¿™ä¸ªç±»çš„å¤§ä½“ç»“æ„ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(RedisOperations.class)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(RedisProperties.class)</span><br><span class="line"><span class="meta">@Import</span>(&#123; LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"><span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> StringRedisTemplate <span class="title">stringRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">StringRedisTemplate template = <span class="keyword">new</span> StringRedisTemplate();</span><br><span class="line">template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"><span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é¦–å…ˆè¿™ä¸ªç±»ä¸Šé¢æœ‰å››ä¸ªæ³¨è§£ï¼Œé‚£ä¹ˆè¿™å››ä¸ªæ³¨è§£çš„ä½œç”¨å¦‚ä¸‹ï¼š</p><ol><li>@Configuration(proxyBeanMethods = false)ï¼Œå£°æ˜è¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼ŒåŒæ—¶ä¹Ÿè¯´æ˜äº†ä¸è¦è®© SpringBoot ä¸ºè¿™ä¸ªç±»ç”Ÿæˆä»£ç†ç±»</li><li>@ConditionalOnClass(RedisOperations.class)ï¼Œå½“ classPath ä¸­å‡ºç°äº† <code>RedisOperations</code> è¿™ä¸ªç±»ä¹‹åï¼Œè¯¥ç±»æ‰ä¼šåŠ è½½æˆä¸€ä¸ªBean</li><li>@EnableConfigurationProperties(RedisProperties.class)ï¼Œå°†é…ç½®ç±» <code>RedisProperties</code> åŠ è½½è¿›æ¥ï¼Œç”±äº</li><li>@Import({ LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class })</li></ol><p>åœ¨ä¸Šè¿°çš„å‡ ä¸ªæ³¨è§£é‡Œé¢ï¼Œæœ€é‡è¦çš„æ˜¯ <code>@Import</code> æ³¨è§£ï¼Œè¿™ä¸ªæ³¨è§£å¯ä»¥å…è®¸æˆ‘ä»¬åœ¨</p><p>TODO</p><h2 id="LettuceConnectionConfiguration-å’Œ-JedisConnectionConfiguration"><a href="#LettuceConnectionConfiguration-å’Œ-JedisConnectionConfiguration" class="headerlink" title="LettuceConnectionConfiguration å’Œ JedisConnectionConfiguration"></a>LettuceConnectionConfiguration å’Œ JedisConnectionConfiguration</h2><p>å½“æŸ¥çœ‹è¿™ä¸¤ä¸ªç±»é‡Œé¢çš„æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå‘ç°åœ¨åˆ›å»º <code>redisConnectionFactory</code> è¿™ä¸ªBeançš„æ—¶å€™ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ª @ConditionalOnMissingBean(RedisConnectionFactory.class) æ³¨è§£ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(RedisConnectionFactory.class)</span><br><span class="line"><span class="function">LettuceConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ObjectProvider&lt;LettuceClientConfigurationBuilderCustomizer&gt; builderCustomizers,</span></span></span><br><span class="line"><span class="function"><span class="params">        ClientResources clientResources)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">    LettuceClientConfiguration clientConfig = getLettuceClientConfiguration(builderCustomizers, clientResources,</span><br><span class="line">            getProperties().getLettuce().getPool());</span><br><span class="line">    <span class="keyword">return</span> createLettuceConnectionFactory(clientConfig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(RedisConnectionFactory.class)</span><br><span class="line"><span class="function">JedisConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ObjectProvider&lt;JedisClientConfigurationBuilderCustomizer&gt; builderCustomizers)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createJedisConnectionFactory(builderCustomizers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸¤ä¸ªæ³¨è§£éƒ½æ˜¯å½“ <code>RedisConnectionFactory.class</code> è¿™ä¸ª Bean ä¸å­˜åœ¨çš„æ—¶å€™æ‰ä¼šåˆ›å»ºï¼Œè€Œä¸”åœ¨ <code>RedisAutoConfiguration</code> ä¸­ï¼Œé¦–å…ˆ import çš„æ˜¯ <code>LettuceConnectionConfiguration</code>ï¼Œæ‰€ä»¥æœ€åæ‰ä¼šå¯¼è‡´åœ¨ SpringBoot2.x çš„æ—¶å€™ï¼Œé»˜è®¤åŠ è½½çš„ <code>redisConnectionFactory</code> æ˜¯ <code>LettuceConnectionFactory</code>ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;SpringBoot1-5ä½¿ç”¨Rediså’Œ2-xçš„åŒºåˆ«&quot;&gt;&lt;a href=&quot;#SpringBoot1-5ä½¿ç”¨Rediså’Œ2-xçš„åŒºåˆ«&quot; class=&quot;headerlink&quot; title=&quot;SpringBoot1.5ä½¿ç”¨Rediså’Œ2.xçš„åŒºåˆ«&quot;&gt;&lt;/a&gt;Sprin
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://somersames.github.io/categories/SpringBoot/"/>
    
    
      <category term="SpringBoot" scheme="https://somersames.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>æµ…è°ˆå·¥å‚æ¨¡å¼</title>
    <link href="https://somersames.github.io/2019/12/27/%E6%B5%85%E8%B0%88%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"/>
    <id>https://somersames.github.io/2019/12/27/æµ…è°ˆå·¥å‚æ¨¡å¼/</id>
    <published>2019-12-26T16:14:53.000Z</published>
    <updated>2019-12-26T16:45:11.465Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>å·¥å‚æ¨¡å¼è§£å†³çš„æ˜¯é¢‘ç¹çš„ä¿®æ”¹æŸä¸€äº› new æ“ä½œï¼Œéšè—çœŸå®çš„åˆ›å»ºè¿‡ç¨‹ï¼Œæ–¹ä¾¿ä»¥åæ›´åŠ å¿«é€Ÿçš„æ–°å¢å’Œæ‰©å±•ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç»´æŠ¤ä¸€ç±»å…³ç³»ã€‚</p><h3 id="ç®€å•å·¥å‚ï¼š"><a href="#ç®€å•å·¥å‚ï¼š" class="headerlink" title="ç®€å•å·¥å‚ï¼š"></a>ç®€å•å·¥å‚ï¼š</h3><p>æŠŠå¯¹è±¡çš„åˆ›å»ºæ”¾åˆ°ä¸€ä¸ªUtilä¸­ï¼Œé€šè¿‡ä¸åŒçš„å…¥å‚æ¥åˆ›å»ºä¸åŒçš„ç±»ã€‚è¿™ä¹Ÿæ˜¯æ—¥å¸¸ç¼–ç ä¸­ç»å¸¸ç”¨åˆ°çš„ï¼Œä¸è¿‡ç¼ºç‚¹å°±æ˜¯æ¯æ¬¡æ–°å¢ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œéƒ½éœ€è¦ä¿®æ”¹<code>if/else</code>åˆ¤æ–­ï¼Œæœ‰ç‚¹ç¹çã€‚</p><h3 id="å·¥å‚æ–¹æ³•ï¼š"><a href="#å·¥å‚æ–¹æ³•ï¼š" class="headerlink" title="å·¥å‚æ–¹æ³•ï¼š"></a>å·¥å‚æ–¹æ³•ï¼š</h3><p>å°†å«æœ‰ç›¸åŒå±æ€§çš„ç±»æŠ½è±¡æˆä¸€ä¸ªå·¥å‚ï¼Œè¿™ä¸€ä¸ªå·¥å‚åªè´Ÿè´£è‡ªå·±çš„å¯¹è±¡çš„åˆ›å»ºï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾ã€‚</p><h3 id="æŠ½è±¡å·¥å‚ï¼š"><a href="#æŠ½è±¡å·¥å‚ï¼š" class="headerlink" title="æŠ½è±¡å·¥å‚ï¼š"></a>æŠ½è±¡å·¥å‚ï¼š</h3><p>å¯¹ç±»çš„æ“ä½œè¿›ä¸€æ­¥çš„åˆ’åˆ†ï¼Œå°†æŸç§ç±»çš„æ“ä½œå†æ¬¡è¿›è¡ŒæŠ½è±¡åŒ–ã€‚</p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p>å‡è®¾ç°åœ¨è¦å¼€å‘ä¸€ä¸ªé¤å…ç‚¹é¤ç³»ç»Ÿï¼Œé¦–å…ˆè‚¯å®šæ˜¯æœ‰é¡¾å®¢ä»¥åŠé£Ÿç‰©ã€‚ä¸ºäº†ä»¥åçš„æ‰©å±•æ€§ï¼Œåœ¨è¿™é‡Œé€šè¿‡ä¸‰ç§å·¥å‚æ–¹æ³•æ¥å®ç°ä¸åŒçš„éœ€æ±‚</p><h3 id="ç®€å•å·¥å‚"><a href="#ç®€å•å·¥å‚" class="headerlink" title="ç®€å•å·¥å‚"></a>ç®€å•å·¥å‚</h3><p>ç°åœ¨æœ‰ä¸¤ä¸ªç±»ï¼ŒUser å’Œ Foodï¼Œæ­¤æ—¶æœ‰ä¸€ä¸ªéœ€æ±‚æ˜¯äººéœ€è¦åƒé£Ÿç‰©ï¼Œå¯èƒ½ä½ æ¯«ä¸çŠ¹è±«çš„å†™ä¸‹äº†å¦‚ä¸‹ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Potato</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> temperaturel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Potato</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åŠ çƒ­ä¸­"</span>);</span><br><span class="line">        <span class="keyword">this</span>.temperaturel = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> User().dinner();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dinner</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Potato potato = <span class="keyword">new</span> Potato(<span class="string">"åœŸè±†"</span>);</span><br><span class="line">        potato.cook();</span><br><span class="line">        System.out.println(<span class="string">"åƒæ™šé¤"</span> + potato.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åæ¥æœ‰ä¸€å¤©éœ€æ±‚å˜äº†ï¼Œç°åœ¨éœ€è¦å†åŠ ä¸€ä¸ªé£Ÿç‰©ä»¥ä¾›å®¢æˆ·é€‰æ‹©ï¼Œåæ¥ä½ æƒ³äº†ä¸‹ï¼Œå†³å®šå†™ä¸€ä¸ª <code>Util</code> ç±»ã€‚å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getFood</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(name != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"Potato"</span>.equals(name))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Potato(<span class="string">"åœŸè±†"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"Tomato"</span>.equals(name))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tomato(<span class="string">"è¥¿çº¢æŸ¿"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>è¿™æ®µä»£ç æ˜æ˜¾çš„æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œè¿”å›çš„ Object åœ¨å¦ä¸€ä¸ªåœ°æ–¹è¿›è¡Œå¼ºåˆ¶è½¬æ¢çš„æ—¶å€™ï¼Œç”±äºä¸çŸ¥é“è¿”å›çš„æ˜¯ Potato è¿˜æ˜¯ Tomatoï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“æŠ›å‡ºè½¬æ¢å¼‚å¸¸ï¼Œæ‰€ä»¥æ­¤æ—¶ï¼Œå†ç»§ç»­ä¼˜åŒ–è¿™æ®µä»£ç ï¼Œç”±äºåœŸè±†å’Œè¥¿çº¢æŸ¿éƒ½æ˜¯é£Ÿç‰©çš„ä¸€ç§ï¼Œäºæ˜¯å¯ä»¥ç›´æ¥æŠ½è±¡ä¸€ä¸ªæ¥å£å‡ºæ¥ã€‚è¿™æ ·åœŸè±†å’Œé©¬é“ƒè–¯éƒ½å®ç°è¿™ä¸ªæ¥å£ã€‚å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Food</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cook</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Potato</span> <span class="keyword">implements</span> <span class="title">Food</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> temperaturel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Potato</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åŠ çƒ­ä¸­"</span>);</span><br><span class="line">        <span class="keyword">this</span>.temperaturel = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tomato</span> <span class="keyword">implements</span> <span class="title">Food</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> temperaturel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tomato</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"åŠ çƒ­ä¸­"</span>);</span><br><span class="line">        <span class="keyword">this</span>.temperaturel = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªæ—¶å€™å‘¢ï¼Œä¿®æ”¹ Util ç±»ï¼Œè®©å®ƒè¿”å› Food è¿™ä¸ªæŠ½è±¡ï¼Œç„¶åé€šè¿‡å®ä¾‹åŒ–å­ç±»ï¼Œæ¥å®ç°æ¨¡ç‰ˆçš„è°ƒç”¨ï¼Œäºæ˜¯ç»§ç»­ä¿®æ”¹ Util ç±»ã€‚å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FoodUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Food <span class="title">getFood</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(name != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"Potato"</span>.equals(name))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Potato(<span class="string">"åœŸè±†"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"Tomato"</span>.equals(name))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tomato(<span class="string">"è¥¿çº¢æŸ¿"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> User().dinner(<span class="string">"Potato"</span>);</span><br><span class="line">        <span class="keyword">new</span> User().dinner(<span class="string">"Tomato"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dinner</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        Food food = FoodUtil.getFood(name);</span><br><span class="line">        food.cook();</span><br><span class="line">        System.out.println(<span class="string">"åƒæ™šé¤"</span> + food.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯éšç€é£Ÿç‰©ç§ç±»çš„ä¸æ–­å¢åŠ ï¼Œæ¯ä¸€æ¬¡æ–°å¢ä¸€ç§é£Ÿç‰©ï¼Œä½ éƒ½è¦å»ä¿®æ”¹<code>getFood</code>è¿™ä¸ªæ–¹æ³•ï¼Œæ¯æ¬¡ä¿®æ”¹å®Œæ¯•ä¹‹åï¼Œä½ è¿˜å¿…é¡»å¯¹å…¶è¿›è¡Œå›å½’æµ‹è¯•ï¼Œä¸‡ä¸€æ”¹é”™äº†ï¼Œæˆ–è€…<code>equals</code>æ–¹æ³•è°ƒç”¨è€…çš„<code>key</code>é‡å¤äº†ï¼Œé‚£å°±ä¼šå½±å“åˆ°ç³»ç»Ÿçš„è¿è¡Œäº†ã€‚è€Œä¸”è¿™ä¹Ÿä¸ç¬¦åˆè®¾è®¡æ¨¡å¼é‡Œé¢çš„å¼€é—­åŸåˆ™ï¼Œå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚æ‰€ä»¥æ­¤æ—¶ç»§ç»­å¯¹è¿™ä¸ª Util è¿›è¡Œä¿®æ”¹ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Food <span class="title">getFood</span><span class="params">(Class&lt;? extends Food&gt; clazz)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(clazz != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">// åœ¨è¿™é‡Œæ–¹ä¾¿æ¼”ç¤ºæ˜¯è®¾è®¡æ¨¡å¼ï¼Œæ‰€ä»¥åœ¨Tomato å’Œ PotatoåŠ å…¥äº†æ— å‚çš„æ„é€ å™¨</span></span><br><span class="line">            <span class="keyword">return</span> clazz.newInstance();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>è¿™å°±æ˜¯ä¸€ä¸ªç®€å•å·¥å‚æ¨¡å¼ï¼Œç®€å•å·¥å‚æ¨¡å¼ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è®²å¹¶ä¸å±äºè®¾è®¡æ¨¡å¼å…¶ä¸­ä¹‹ä¸€ï¼Œä½†æ˜¯è¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç»å¸¸ä½¿ç”¨çš„ä¸€ç§æ–¹å¼ï¼Œç”¨äºé¿å…ä¸€äº›æ— æ„ä¹‰çš„ new æ“ä½œã€‚<br>æ¥ä¸‹æ¥å°±æ¥è®²ä¸‹å·¥å‚æ–¹æ³•æ¨¡å¼ã€‚</p><h2 id="å·¥å‚æ–¹æ³•æ¨¡å¼"><a href="#å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerlink" title="å·¥å‚æ–¹æ³•æ¨¡å¼"></a>å·¥å‚æ–¹æ³•æ¨¡å¼</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æŠ½è±¡çš„ä¸€ä¸ªå·¥å‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line">    <span class="function">Food <span class="title">createFood</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¥¿çº¢æŸ¿å·¥å‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PotatoFactory</span> <span class="keyword">implements</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">createFood</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Potato();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åœŸè±†å·¥å‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomatoFactory</span> <span class="keyword">implements</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">createFood</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"æ¸…æ´—å¹²å‡€"</span>);</span><br><span class="line">        System.out.println(<span class="string">"åˆ‡å¥½"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Tomato();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼Œå‡è®¾æˆ‘ä»¬è¦ä½¿ç”¨çš„è¯ï¼Œåˆ™ç›´æ¥é€šè¿‡ new ä¸€ä¸ªå­ç±»å³å¯ï¼Œå¦‚ä¸‹ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FoodFactory potatoFactory = <span class="keyword">new</span> PotatoFactory();</span><br><span class="line">        FoodFactory tomatoFactory = <span class="keyword">new</span> TomatoFactory();</span><br><span class="line">        tomatoFactory.createFood().cook();</span><br><span class="line">        potatoFactory.createFood().cook();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¯¹æ‰©å±•å¼€æ”¾ï¼Œå½“éœ€è¦æ·»åŠ å…¶ä»–é£Ÿç‰©çš„æ—¶å€™ï¼Œç›´æ¥æ–°å»ºä¸€ä¸ª<code>Factory</code>ç±»ç„¶åå®ç°<code>FoodFactory</code>æ¥å£å³å¯ï¼Œè¿™å°±æ˜¯å·¥å‚æ¨¡å¼çš„å¥½å¤„ã€‚</p><h2 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h2><p>æŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯å¯¹å·¥å‚çš„æ›´è¿›ä¸€æ­¥æŠ½è±¡ï¼Œä¾‹å¦‚ åœŸè±† å’Œ è¥¿çº¢æŸ¿æ˜¯ä¸€ç»„äº§å“ï¼Œå› ä¸ºå®ƒä»¬éƒ½åŒå±äºé£Ÿç‰©ã€‚ä½†æ˜¯ç°åœ¨æœ‰ä¸¤ä¸ªåœ°æ–¹éƒ½å¯ä»¥ç”Ÿäº§ åœŸè±† å’Œ è¥¿çº¢æŸ¿ï¼ŒAåœ°çš„æ˜¯é‡‘è‰²çš„ï¼ŒBåœ°ç”Ÿäº§çš„æ˜¯é“¶è‰²çš„ï¼Œäºæ˜¯æ­¤æ—¶ A å’Œ B å°±äº§ç”Ÿäº†ä¸€ä¸ªäº§å“ç­‰çº§ã€‚ä½†æ˜¯A å’Œ Béƒ½æ˜¯å…·æœ‰ä¸€ç»„é€šç”¨çš„ç‰¹æ€§ï¼Œå³ä½¿å¯ä»¥ç”Ÿäº§ä¸åŒçš„é¢œè‰² åœŸè±† å’Œ è¥¿çº¢æŸ¿ã€‚</p><pre><code class="java"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlantFactory</span> </span>{    <span class="function">Tomato <span class="title">plantTomato</span><span class="params">()</span></span>;    <span class="function">Potato <span class="title">plantPotato</span><span class="params">()</span></span>;}<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AFactory</span> <span class="keyword">implements</span> <span class="title">PlantFactory</span></span>{    <span class="meta">@Override</span>    <span class="function"><span class="keyword">public</span> Tomato <span class="title">plantTomato</span><span class="params">()</span> </span>{        System.out.println(<span class="string">"plantTomato By A"</span>);        <span class="keyword">return</span> <span class="keyword">new</span> Tomato();    }    <span class="meta">@Override</span>    <span class="function"><span class="keyword">public</span> Potato <span class="title">plantPotato</span><span class="params">()</span> </span>{        System.out.println(<span class="string">"plantPotato By A"</span>);        <span class="keyword">return</span> <span class="keyword">new</span> Potato();    }}<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BFactory</span> <span class="keyword">implements</span> <span class="title">PlantFactory</span> </span>{    <span class="meta">@Override</span>    <span class="function"><span class="keyword">public</span> Tomato <span class="title">plantTomato</span><span class="params">()</span> </span>{        System.out.println(<span class="string">"plantTomato By B"</span>);        <span class="keyword">return</span> <span class="keyword">new</span> Tomato();    }    <span class="meta">@Override</span>    <span class="function"><span class="keyword">public</span> Potato <span class="title">plantPotato</span><span class="params">()</span> </span>{        System.out.println(<span class="string">"plantPotato By B"</span>);        <span class="keyword">return</span> <span class="keyword">new</span> Potato();    }}<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{        PlantFactory plantFactory = <span class="keyword">new</span> AFactory();        plantFactory.plantPotato().cook();    }}</code></pre><p>æ€»çš„æ¥è¯´ï¼Œè¿™ä¸‰ç§è®¾è®¡æ¨¡å¼ä¸­ï¼Œé™¤äº†æŠ½è±¡å·¥å‚æ¨¡å¼å¾ˆå°‘ä½¿ç”¨åˆ°ï¼Œå…¶ä»–ä¸¤ç§åœ¨å¹³å¸¸å¼€å‘çš„é¡¹ç›®ä¸­åŸºæœ¬ä¸Šéƒ½å¯ä»¥çœ‹åˆ°ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;å·¥å‚æ¨¡å¼è§£å†³çš„æ˜¯é¢‘ç¹çš„ä¿®æ”¹æŸä¸€äº› new æ“ä½œï¼Œéšè—çœŸå®çš„åˆ›å»ºè¿‡ç¨‹ï¼Œæ–¹ä¾¿ä»¥åæ›´åŠ å¿«é€Ÿçš„æ–°å¢å’Œæ‰©å±•ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç»´æŠ¤ä¸€ç±»å…³ç³»ã€‚&lt;/p&gt;
&lt;h3
      
    
    </summary>
    
      <category term="è®¾è®¡æ¨¡å¼" scheme="https://somersames.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="è®¾è®¡æ¨¡å¼" scheme="https://somersames.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Mysqlä¸­intç±»å‹çš„ç®€å•æ€»ç»“</title>
    <link href="https://somersames.github.io/2019/12/17/Mysql%E4%B8%ADint%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%AE%80%E5%8D%95%E6%80%BB%E7%BB%93/"/>
    <id>https://somersames.github.io/2019/12/17/Mysqlä¸­intç±»å‹çš„ç®€å•æ€»ç»“/</id>
    <published>2019-12-16T16:33:00.000Z</published>
    <updated>2019-12-16T16:46:20.162Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>é¦–å…ˆé—®ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>int(1)å’Œint(10)æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</li><li>int(3)å¯ä»¥å­˜å‚¨ 10000 è¿™ä¸ªæ•°å­—å—ï¼Ÿ</li><li>int(11)å¯ä»¥ç”¨æ¥å­˜å‚¨æ‰‹æœºå·ä¹ˆï¼Ÿ</li></ol><p>æœ¬æ¬¡çš„æºä»£ç ä»¥åŠæµ‹è¯•çš„ Mysql ç‰ˆæœ¬å‡ä¸º 8.0.17</p><h2 id="è§£é‡Š"><a href="#è§£é‡Š" class="headerlink" title="è§£é‡Š"></a>è§£é‡Š</h2><p>é¦–å…ˆæ–°å»ºä¸€ä¸ªè¡¨ï¼ŒSQLå¦‚ä¸‹ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_int(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> ,</span><br><span class="line">    <span class="keyword">no</span> <span class="built_in">int</span>(<span class="number">5</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    phone <span class="built_in">int</span>(<span class="number">11</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br></pre></td></tr></table></figure></p><p>å½“ä½ æ‰§è¡Œå®Œè¿™ä¸ª SQL ä»¥åï¼ŒMysqlä¼šå‘å‡ºä¸€ä¸ªå¦‚ä¸‹æç¤ºï¼š</p><blockquote><p>[2019-12-16 23:08:24] [HY000][1681] Integer display width is deprecated and will be removed in a future release.<br>é¦–å…ˆä¸ç®¡è¿™ä¸ªæç¤ºï¼Œå¾…ä¼šåæ–‡ä¼šè§£é‡Šçš„ã€‚</p></blockquote><p> ç„¶åæ–°å¢æµ‹è¯•æ•°æ®ï¼š<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test_int`</span> (<span class="string">`id`</span>, <span class="string">`no`</span>, <span class="string">`phone`</span>) <span class="keyword">VALUES</span> (<span class="number">10000</span>, <span class="number">1008611</span>, <span class="number">123124</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test_int`</span> (<span class="string">`id`</span>, <span class="string">`no`</span>, <span class="string">`phone`</span>) <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="number">134</span>, <span class="number">124</span>);</span><br></pre></td></tr></table></figure></p><p> ç„¶åå†è¿›è¡Œ select æŸ¥çœ‹ã€‚<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> mysql&gt; select * from test_int;</span><br><span class="line">+<span class="comment">-------+---------+--------+</span></span><br><span class="line">| id    | no      | phone  |</span><br><span class="line">+<span class="comment">-------+---------+--------+</span></span><br><span class="line">|    10 |     134 |    124 |</span><br><span class="line">| 10000 | 1008611 | 123124 |</span><br><span class="line">+<span class="comment">-------+---------+--------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><p> å¯ä»¥çœ‹åˆ°å…¶å®å¹¶æ²¡æœ‰å½±å“åˆ°ä»»ä½•æ•°æ®çš„æ’å…¥ï¼ŒéšåæŸ¥è¯¢ Mysql çš„å®˜æ–¹æ–‡æ¡£ï¼Œé‡Œé¢æœ‰è¿™æ ·çš„ä¸€æ®µè¯</p><blockquote><p>If you specify ZEROFILL for a numeric column, MySQL automatically adds the UNSIGNED attribute to the column.</p></blockquote><p>éšåå†æ¬¡æ–°å»ºä¸€ä¸ªè¡¨ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_int_zerofill(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">unsigned</span> zerofill <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> ,</span><br><span class="line">    <span class="keyword">no</span> <span class="built_in">int</span>(<span class="number">5</span>) <span class="keyword">unsigned</span> zerofill <span class="keyword">not</span> <span class="literal">null</span> ,</span><br><span class="line">    phone <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> zerofill</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line">The ZEROFILL attribute is deprecated and will be removed in a future release. <span class="keyword">Use</span> the <span class="keyword">LPAD</span> <span class="keyword">function</span> <span class="keyword">to</span> zero-<span class="keyword">pad</span> numbers, <span class="keyword">or</span> <span class="keyword">store</span> the formatted numbers <span class="keyword">in</span> a <span class="built_in">CHAR</span> column.</span><br></pre></td></tr></table></figure></p><p>è™½ç„¶æç¤º ZEROFILL å¿«è¦è¢«åºŸå¼ƒäº†ï¼Œä½†æ˜¯ä¸ºäº†æ¼”ç¤ºåŒºåˆ«ï¼Œæ‰€ä»¥æš‚æ—¶è¿˜æ˜¯ä¸ç®¡äº†ã€‚<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from test_int_zerofill;</span><br><span class="line">+<span class="comment">-------+--------+-------------+</span></span><br><span class="line">| id    | no     | phone       |</span><br><span class="line">+<span class="comment">-------+--------+-------------+</span></span><br><span class="line">|   010 |  00010 | 00000000010 |</span><br><span class="line">| 12345 | 123456 | 00001234567 |</span><br><span class="line">+<span class="comment">-------+--------+-------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><p>æ‰€ä»¥å¯¹äºé—®é¢˜1ï¼Œæ‰€ä»¥ int(1) å’Œ int(10) å…¶å®æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œå”¯ä¸€æœ‰åŒºåˆ«çš„åœ°æ–¹å°±åœ¨äºå¦‚æœä½¿ç”¨äº† <code>unsigned zerofill</code> ä¿®é¥°çš„è¯ï¼Œé‚£ä¹ˆä¸è¶³é•¿åº¦çš„ä¼šåœ¨å·¦è¾¹è¿›è¡Œè¡¥ 0 ï¼Œè€Œå¦‚æœæ²¡æœ‰ç”¨ <code>unsigned zerofill</code> è¿›è¡Œä¿®é¥°çš„è¯ï¼Œå¯ä»¥è¯´åŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚</p><p>å¯¹äºé—®é¢˜2ï¼Œå› ä¸º int æ‹¬å·é‡Œé¢çš„å€¼ä¸ä½æ•°æ— å…³ï¼Œ æ‰€ä»¥æ˜¯å¯ä»¥çš„ã€‚<br>åˆ°æ­¤ï¼Œå¯¹äºæ‰§è¡Œç¬¬ä¸€ä¸ªSQLæ‰€è¿›è¡Œçš„æç¤ºï¼Œæ˜¯å› ä¸º Mysql ä¹Ÿè§‰å¾—å…¶å®æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œè€Œæ˜¯æ›´åŠ æ¨èç”¨ <code>LDAP()</code> è¿™ä¸ªå‡½æ•°æ¥åˆ¤æ–­ã€‚</p><p>å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¯ä»¥å°è¯•ä¸€ä¸ªæ‰‹æœºå·ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test_int_zerofill`</span> (<span class="string">`id`</span>, <span class="string">`no`</span>, <span class="string">`phone`</span>) <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="number">10</span>, <span class="number">13100000000</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">22001</span>][<span class="number">1264</span>] <span class="keyword">Data</span> truncation: <span class="keyword">Out</span> <span class="keyword">of</span> <span class="keyword">range</span> <span class="keyword">value</span> <span class="keyword">for</span> <span class="keyword">column</span> <span class="string">'phone'</span> <span class="keyword">at</span> <span class="keyword">row</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p><p>å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› åœ¨äº int ç±»å‹åœ¨ mysql é‡Œé¢æ˜¯å››ä¸ªå­—èŠ‚ï¼Œè€Œä¸€ä¸ªå­—èŠ‚æ˜¯ 8 ä½ï¼Œæ‰€ä»¥åœ¨ mysql é‡Œé¢ï¼Œä¸€ä¸ªint ç±»å‹æœ€å¤šå¯ä»¥å‚¨å­˜ 2^31(ä¸€ä¸ªç¬¦å·ä½ç½®)ï¼Œä¹Ÿå°±æ˜¯çº¦ 21 äº¿å·¦å³ï¼Œæ— ç¬¦å·çš„ä¹Ÿæœ€å¤š42äº¿ï¼Œä½†æ˜¯æ‰‹æœºå·æœ€ä½ä¹Ÿæ˜¯11ä½ï¼Œä¹Ÿå°±æ˜¯ 130 å¤šäº¿ã€‚æ‰€ä»¥è‚¯å®šæ˜¯æ— æ³•å­˜å‚¨çš„ã€‚<br>ä¸‹é¢æ˜¯ Mysql å®˜æ–¹ç»™å‡ºçš„ num ç±»å‹çš„å­˜å‚¨èŒƒå›´<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%88%AA%E5%B1%8F2019-12-17%E4%B8%8A%E5%8D%8812.25.08.png" alt=""></p><h2 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h2><p>ç”±äºæƒ³çœ‹ä¸‹ Mysql åˆ°åº•æ˜¯å¦‚ä½•å¤„ç† int ç±»å‹çš„æ•°å€¼çš„ï¼Œäºæ˜¯ä¸‹è½½å¹¶ä¸”ç¼–è¯‘äº† Mysql çš„æºç ï¼Œä¸€ç›´è·Ÿç€ debugï¼Œæœ€åæ‰¾åˆ°äº† Mysql åˆ¤æ–­ int æ˜¯å¦è¶…é•¿çš„ä¸€ä¸ªä»£ç ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">type_conversion_status Field_long::store(<span class="keyword">double</span> nr) &#123;</span><br><span class="line">  ASSERT_COLUMN_MARKED_FOR_WRITE;</span><br><span class="line">  type_conversion_status error = TYPE_OK;</span><br><span class="line">  int32 res;</span><br><span class="line">  nr = rint(nr);</span><br><span class="line">  <span class="keyword">if</span> (unsigned_flag) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nr &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      res = <span class="number">0</span>;</span><br><span class="line">      error = TYPE_WARN_OUT_OF_RANGE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr &gt; (<span class="keyword">double</span>)UINT_MAX32) &#123;</span><br><span class="line">      res = UINT_MAX32;</span><br><span class="line">      set_warning(Sql_condition::SL_WARNING, ER_WARN_DATA_OUT_OF_RANGE, <span class="number">1</span>);</span><br><span class="line">      error = TYPE_WARN_OUT_OF_RANGE;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">      res = (int32)(ulong)nr;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nr &lt; (<span class="keyword">double</span>)INT_MIN32) &#123;</span><br><span class="line">      res = (int32)INT_MIN32;</span><br><span class="line">      error = TYPE_WARN_OUT_OF_RANGE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr &gt; (<span class="keyword">double</span>)INT_MAX32) &#123;</span><br><span class="line">      res = (int32)INT_MAX32;</span><br><span class="line">      error = TYPE_WARN_OUT_OF_RANGE;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">      res = (int32)(longlong)nr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (error)</span><br><span class="line">    set_warning(Sql_condition::SL_WARNING, ER_WARN_DATA_OUT_OF_RANGE, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WORDS_BIGENDIAN</span></span><br><span class="line">  <span class="keyword">if</span> (table-&gt;s-&gt;db_low_byte_first) &#123;</span><br><span class="line">    int4store(ptr, res);</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">    longstore(ptr, res);</span><br><span class="line">  <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨è¿™æ®µä»£ç é‡Œé¢ï¼ŒMysqlé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦å¸¦æœ‰ç¬¦å·ä½ï¼Œå¦‚æœæ˜¯æ— ç¬¦å·ä½çš„è¯ï¼Œåˆ™æ˜¯ç›´æ¥åˆ¤æ–­æ˜¯å¦å¤§äº UINT_MAX32ï¼Œè€Œå¦‚æœæ˜¯æœ‰ç¬¦å·çš„è¯ï¼Œåˆ™æ˜¯åˆ¤æ–­æ˜¯å¦å°äº INT_MIN32 æˆ–è€…å¤§äº INT_MAX32ï¼Œå¦åˆ™ç›´æ¥ä¸ºæœ€å°æˆ–è€…æœ€å¤§å€¼ï¼Œç„¶åè®¾ç½®errorã€‚<br>PSï¼šè¿™ä¸€æ®µä»£ç æ˜¯è¿˜æœªè¿›è¡Œ InnoDB å¼•æ“å±‚ï¼Œå¯ä»¥çœ‹åˆ° Mysql æ˜¯åœ¨ Server å±‚è¿›è¡ŒSQLè¯­å¥çš„æ ¡éªŒã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;é—®é¢˜&quot;&gt;&lt;a href=&quot;#é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜&quot;&gt;&lt;/a&gt;é—®é¢˜&lt;/h2&gt;&lt;p&gt;é¦–å…ˆé—®ä¸¤ä¸ªé—®é¢˜ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;int(1)å’Œint(10)æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚&lt;/li&gt;
&lt;li&gt;int(3)å¯ä»¥å­˜å‚¨ 10000 è¿™
      
    
    </summary>
    
      <category term="Mysql" scheme="https://somersames.github.io/categories/Mysql/"/>
    
    
      <category term="Mysql" scheme="https://somersames.github.io/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>java validation çš„å›½é™…åŒ–</title>
    <link href="https://somersames.github.io/2019/12/09/java-validation-%E7%9A%84%E5%9B%BD%E9%99%85%E5%8C%96/"/>
    <id>https://somersames.github.io/2019/12/09/java-validation-çš„å›½é™…åŒ–/</id>
    <published>2019-12-09T14:56:38.000Z</published>
    <updated>2019-12-09T16:18:47.197Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>åœ¨ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®é‡Œé¢ï¼Œè‚¯å®šæ˜¯æœ‰å„ç§å„æ ·çš„å…¥å‚æ ¡éªŒçš„ï¼Œå¦‚æœä¸šåŠ¡ä¸Šçš„ä¸€äº›é€»è¾‘æ ¡éªŒï¼Œå¯ä»¥æ”¾åœ¨ Service å±‚é¢è¿›è¡Œï¼Œä½†æ˜¯å¦‚æœæ˜¯ Controller é‡Œé¢çš„æ ¡éªŒï¼Œç›´æ¥å¯ä»¥ç”¨ validation è¿›è¡ŒéªŒè¯ã€‚é…åˆæ³¨è§£å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°å„ç§å„æ ·çš„å…¥å‚æ ¡éªŒã€‚<br>å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank</span>(message = <span class="string">"ç”¨æˆ·åç§°ä¸èƒ½ä¸ºç©º"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Max</span>(value = <span class="number">18</span>)</span><br><span class="line">    <span class="meta">@Min</span>(value = <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç„¶ååœ¨Controlleré‡Œé¢<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"test"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testError</span><span class="params">(@Valid  @RequestBody User user ,Errors errors)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">for</span> (ObjectError err : errors.getAllErrors()) &#123;</span><br><span class="line">            <span class="keyword">return</span> err.getDefaultMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å½“å…¥å‚çš„ JSON å¦‚æœ name æ˜¯ç©ºçš„è¯ï¼Œå°±ä¼šç›´æ¥è¿”å› <code>ç”¨æˆ·åç§°ä¸èƒ½ä¸ºç©º</code>ï¼Œå½“ç„¶è¿™é‡Œæ˜¯åšäº†ä¸€äº›ç®€åŒ–ï¼Œè¿”å›çš„åº”è¯¥è¿˜æœ‰ Code å’Œ Messageã€‚è¿™æ ·çš„è¯ä¸€ä¸ªç®€å•çš„ Controller æ£€éªŒå…¥å‚å°±å®ç°çš„ï¼Œä½†æ˜¯ä¸ºäº†æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œè¿˜éœ€è¦è€ƒè™‘<code>å›½é™…åŒ–</code>ä»¥åŠ<code>å¯é…ç½®åŒ–</code>ã€‚</p><h2 id="æ‰©å±•æ€§"><a href="#æ‰©å±•æ€§" class="headerlink" title="æ‰©å±•æ€§"></a>æ‰©å±•æ€§</h2><p>å¦‚æœåœ¨ä¹‹åéœ€è¦æ›´æ”¹ä¸€ä¸ªæ ¡éªŒçš„æç¤ºè¯­ï¼Œé‚£ä¹ˆåœ¨ä¸Šé¢çš„ä»£ç é‡Œé¢æ˜¯éœ€è¦ä¿®æ”¹ä»£ç çš„ï¼Œé‚£ä¹ˆæœ€å¥½çš„åŠæ³•å°±æ˜¯æŠŠè¿™äº›æç¤ºä¿¡æ¯éƒ½åŠ åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆä»¥åéœ€è¦ä¿®æ”¹æŸäº›æç¤ºçš„è¯ï¼Œç›´æ¥æ”¹é…ç½®æ–‡ä»¶å³å¯ã€‚<br>åœ¨ Spring å®˜æ–¹æ–‡æ¡£çš„ <strong>4.7.1</strong> ä¸­æœ‰ä¸€ä¸ªç±» <code>MessageCodesResolver</code> å¯ä»¥ç”¨æ¥å®ç°é”™è¯¯ä¿¡æ¯çš„å¯é…ç½®åŒ–</p><h3 id="MessageCodesResolver"><a href="#MessageCodesResolver" class="headerlink" title="MessageCodesResolver"></a>MessageCodesResolver</h3><p>è¿™ä¸ªç±»éœ€è¦å’Œ<code>spring.mvc.message-codes-resolver-format</code>ä¸€èµ·æ¥ä½¿ç”¨ï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£çš„æç¤ºï¼ŒæŸ¥çœ‹<code>DefaultMessageCodesResolver.Format</code>ï¼Œä¼šå‘ç°è¿™ä¸ªå‚æ•°æœ‰ä¸¤ä¸ªæšä¸¾ï¼Œä¸€ä¸ªæ˜¯ PREFIX_ERROR_CODEï¼Œå¦ä¸€ä¸ªæ˜¯ POSTFIX_ERROR_CODEã€‚<br>è¿™ä¸¤ä¸ªä»€ä¹ˆæ„æ€å‘¢ï¼Œç®€å•æ¥è®²ï¼Œæ ¹æ®ä¸Šé¢çš„ User ç±»ï¼Œå¦‚æœæˆ‘è¦é…ç½®å½“ name ä¸ä¸ºç©ºçš„æç¤ºè¯­ï¼Œä¸‹é¢ä¸¤ç§æšä¸¾å¯¹åº”åœ¨é…ç½®æ–‡ä»¶ä¸­çš„é”®å€¼æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><ol><li>PREFIX_ERROR_CODE<blockquote><p>NotBlank.user.name = ç”¨æˆ·åç§°ä¸èƒ½ä¸ºç©º</p></blockquote></li><li>POSTFIX_ERROR_CODEã€‚<blockquote><p>user.name.NotBlank = ç”¨æˆ·åç§°ä¸èƒ½ä¸ºç©º</p></blockquote></li></ol><p>ä¸ªäººåå‘äºç¬¬äºŒç§å†™æ³•çš„ï¼Œå› ä¸ºæ„Ÿè§‰ç¬¬äºŒç§æ›´åŠ ç¬¦åˆé˜…è¯»ä¹ æƒ¯ã€‚</p><h2 id="messgaeé…ç½®æ–‡ä»¶"><a href="#messgaeé…ç½®æ–‡ä»¶" class="headerlink" title="messgaeé…ç½®æ–‡ä»¶"></a>messgaeé…ç½®æ–‡ä»¶</h2><p>æ—¢ç„¶éœ€è¦åšæˆé…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆåœ¨ application.yml é‡Œé¢æŠŠä¸€äº›å±æ€§éƒ½é…ç½®å¥½ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  mvc:</span></span><br><span class="line"><span class="attr">    message-codes-resolver-format:</span> <span class="string">postfix_error_code</span></span><br><span class="line"><span class="attr">  messages:</span></span><br><span class="line"><span class="attr">    basename:</span> <span class="string">i18n/validation</span></span><br></pre></td></tr></table></figure></p><p>ç„¶ååœ¨ Resources ä¸‹é¢æ–°å»ºä¸€ä¸ª validation.properties<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user.name.NotBlank = ç”¨æˆ·åç§°ä¸èƒ½ä¸ºç©º</span><br><span class="line">user.age.Max = å¹´é¾„æœ€é«˜ä¸èƒ½é«˜äº<span class="number">18</span></span><br><span class="line">user.age.Min = å¹´é¾„æœ€é«˜ä¸èƒ½ä½äº<span class="number">10</span></span><br></pre></td></tr></table></figure></p><h3 id="Controller-æ ¡éªŒ"><a href="#Controller-æ ¡éªŒ" class="headerlink" title="Controller æ ¡éªŒ"></a>Controller æ ¡éªŒ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MessageSource messageSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"test/cn"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testErrorCn</span><span class="params">(@Valid  @RequestBody User user ,Errors errors)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">for</span> (ObjectError err : errors.getAllErrors()) &#123;</span><br><span class="line">            String msg = messageSource.getMessage(err, Locale.CHINA);</span><br><span class="line">            <span class="keyword">return</span> msg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œæš‚æ—¶å…ˆä¸ç®¡ <code>Locale.CHINA</code> è¿™ä¸ªå‚æ•°çš„å«ä¹‰ï¼Œé¦–å…ˆé€šè¿‡ errors å…ˆåˆ¤æ–­å…¥å‚æ˜¯å¦æœ‰é—®é¢˜ï¼Œæœ‰çš„è¯ç›´æ¥é€šè¿‡ messageSource.getMessage() æ–¹æ³•ç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯å³å¯ã€‚</p><h3 id="PsotManæµ‹è¯•"><a href="#PsotManæµ‹è¯•" class="headerlink" title="PsotManæµ‹è¯•"></a>PsotManæµ‹è¯•</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /test/cn HTTP/<span class="number">1.1</span></span><br><span class="line">Host: localhost:<span class="number">8071</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"age"</span>:<span class="number">15</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›ï¼šç”¨æˆ·åç§°ä¸èƒ½ä¸ºç©º</p><p>é‚£ä¹ˆä»¥åå¦‚æœéœ€è¦ä¿®æ”¹è¿”å›æç¤ºçš„è¯ï¼Œç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ï¼Œä»è€Œä¸éœ€è¦ä¿®æ”¹ä»£ç ã€‚</p><h3 id="å›½é™…åŒ–"><a href="#å›½é™…åŒ–" class="headerlink" title="å›½é™…åŒ–"></a>å›½é™…åŒ–</h3><p>å¦‚æœéœ€è¦å°†è¯¥æç¤ºå›½é™…åŒ–ï¼Œç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ï¼Œæ–°å»ºä¸¤ä¸ªé…ç½®æ–‡ä»¶<code>validation_zh_CN.properties</code>ï¼Œ<code>validation_en_US.properties</code>ï¼Œç„¶ååˆ†åˆ«æ–°å»ºæç¤ºé…ç½®å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">validation_zh_CN.propertiesï¼š</span><br><span class="line">user.name.NotBlank = ç”¨æˆ·åç§°ä¸èƒ½ä¸ºç©º</span><br><span class="line">user.age.Max = å¹´é¾„æœ€é«˜ä¸èƒ½é«˜äº18</span><br><span class="line">user.age.Min = å¹´é¾„æœ€é«˜ä¸èƒ½ä½äº10</span><br><span class="line"></span><br><span class="line">validation_en_US.propertiesï¼š</span><br><span class="line">user.name.NotBlank = user name can not be null</span><br><span class="line">user.age.Max = the max gae can not grater than 18</span><br><span class="line">user.age.Min = the max gae can not less than 10</span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶åœ¨Controlleré‡Œé¢ä»£å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MessageSource messageSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testError</span><span class="params">(@Valid  @RequestBody User user ,Errors errors)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">            <span class="keyword">for</span> (ObjectError err : errors.getAllErrors()) &#123;</span><br><span class="line">                <span class="keyword">return</span> err.getDefaultMessage();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"test/cn"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testErrorCn</span><span class="params">(@Valid  @RequestBody User user ,Errors errors)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">            <span class="keyword">for</span> (ObjectError err : errors.getAllErrors()) &#123;</span><br><span class="line">                String msg = messageSource.getMessage(err, Locale.CHINA);</span><br><span class="line">                <span class="keyword">return</span> msg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"test/en"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testErrorEn</span><span class="params">(@Valid  @RequestBody User user ,Errors errors)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">            <span class="keyword">for</span> (ObjectError err : errors.getAllErrors()) &#123;</span><br><span class="line">                String msg = messageSource.getMessage(err, Locale.US);</span><br><span class="line">                <span class="keyword">return</span> msg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Userçš„ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Max</span>(value = <span class="number">18</span>)</span><br><span class="line">    <span class="meta">@Min</span>(value = <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å½“æˆ‘ä»¬è¯·æ±‚ <code>test/en</code> å’Œ <code>test/cn</code>çš„æ—¶å€™å°±ä¼šå‡ºç°ä¸åŒçš„æç¤ºï¼Œ</p><ol><li>test/en<blockquote><p>user name can not be null</p></blockquote></li><li>test/cn<blockquote><p>ç”¨æˆ·åç§°ä¸èƒ½ä¸ºç©º</p></blockquote></li></ol><p>è¿™å…¶ä¸­é‡è¦çš„å®ç°å°±æ˜¯ Locale.US å’Œ Locale.CHINAï¼Œåœ¨è¿™é‡Œå®ç°çš„è¯ï¼Œæœ€å¥½æ˜¯æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©è¯­è¨€æ¥åŠ¨æ€çš„åˆ‡æ¢å®ç°Localçš„è½¬æ¢ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;åœ¨ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®é‡Œé¢ï¼Œè‚¯å®šæ˜¯æœ‰å„ç§å„æ ·çš„å…¥å‚æ ¡éªŒçš„ï¼Œå¦‚æœä¸šåŠ¡ä¸Šçš„ä¸€äº›é€»è¾‘æ ¡éªŒï¼Œå¯ä»¥æ”¾åœ¨ Service å±‚é¢è¿›è¡Œï¼Œä½†æ˜¯å¦‚æœæ˜¯ Control
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>javaä¿¡å·é‡çš„ç®€å•äº†è§£</title>
    <link href="https://somersames.github.io/2019/12/04/java%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3/"/>
    <id>https://somersames.github.io/2019/12/04/javaä¿¡å·é‡çš„ç®€å•äº†è§£/</id>
    <published>2019-12-03T16:20:45.000Z</published>
    <updated>2019-12-04T15:57:42.276Z</updated>
    
    <content type="html"><![CDATA[<!-- ä¿¡å·é‡åœ¨è®¡ç®—æœºçš„æ“ä½œç³»ç»Ÿä»¥åŠå¹¶å‘çš„æ—¶å€™ç»å¸¸ä½¿ç”¨åˆ°ï¼Œç”¨äºå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚ï¼ˆå¾…å®šï¼‰ --><p>åœ¨Javaè¯­è¨€é‡Œé¢ï¼ŒSemaphore çš„ä½œç”¨æ˜¯å¯ä»¥æ§åˆ¶å¯¹äºåŒä¸€ä¸ªä¸´ç•Œèµ„æºï¼Œå…è®¸å¤šå°‘ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚<br>å½“çº¿ç¨‹æ‰§è¡Œåˆ°ä¸´ç•ŒåŒºåŸŸçš„æ—¶å€™ï¼Œéœ€è¦å…ˆå‘ Semaphore ç”³è¯·ä¸€ä¸ªä»¤ç‰Œï¼Œæ­¤æ—¶ Semaphore ä¼šåˆ¤æ–­ç°æœ‰çš„çš„ä»¤ç‰Œæ˜¯ä¸æ˜¯å°äº0ï¼Œå¦‚æœå°äº0ï¼Œåˆ™é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´è‡³æœ‰çº¿ç¨‹å°†ä»¤ç‰Œå½’è¿˜å›æ¥ã€‚</p><h2 id="ç”³è¯·åˆ°äº†permits"><a href="#ç”³è¯·åˆ°äº†permits" class="headerlink" title="ç”³è¯·åˆ°äº†permits"></a>ç”³è¯·åˆ°äº†permits</h2><p>å¦‚æœä¸€ä¸ªçº¿ç¨‹ç›´æ¥ç”³è¯·åˆ°äº†permitsï¼Œåˆ™æ˜¯ç›´æ¥é€šè¿‡CASæ“ä½œå°† state å‡ä¸€å³å¯ï¼Œç„¶åçº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚</p><h2 id="æ— æ³•ç”³è¯·åˆ°permits"><a href="#æ— æ³•ç”³è¯·åˆ°permits" class="headerlink" title="æ— æ³•ç”³è¯·åˆ°permits"></a>æ— æ³•ç”³è¯·åˆ°permits</h2><p>å½“æ— æ³•ç”³è¯·åˆ° Semaphore çš„ permits çš„æ—¶å€™ï¼Œåˆ™ä¼šå°†å½“å‰çš„çº¿ç¨‹è¿›è¡Œé˜»å¡ï¼Œç›´åˆ°æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œé‡Šæ”¾äº† permitã€‚</p><h3 id="Semaphore-çš„ç±»å…³ç³»"><a href="#Semaphore-çš„ç±»å…³ç³»" class="headerlink" title="Semaphore çš„ç±»å…³ç³»"></a>Semaphore çš„ç±»å…³ç³»</h3><p>é‚£ä¹ˆåœ¨ <code>Semaphore</code> é‡Œé¢ï¼Œå¦‚æœ <code>permits</code> å·²ç»è¢«é™åˆ°0ä»¥ä¸‹ï¼ŒæŒ‰ç…§ä¿¡å·é‡çš„è§„åˆ™ï¼Œåº”å½“å°†å½“å‰çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ° <code>permits</code> å¤§äº 0ã€‚æŸ¥çœ‹ Semaphore çš„ç±»ç»„ç»‡ç»“æ„ï¼Œä¼šå‘ç°å®ƒçš„ä¸€äº›æ“ä½œå…¨éƒ¨éƒ½æ˜¯ä¾èµ–äºè‡ªå·±çš„ä¸€ä¸ª Sync å˜é‡ï¼Œæ­¤å¤–è¿˜æœ‰ä¸¤ä¸ªå˜é‡ç”¨äºå®ç°å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œéƒ½æ˜¯ç»§æ‰¿è‡ª <code>Sync</code>ï¼Œè€Œ <code>Sync</code> åˆ™æ˜¯ç»§æ‰¿è‡ª <code>AbstractQueuedSynchronizer</code> (ä¸‹æ–‡ç®€ç§°AQS)ã€‚æ‰€ä»¥ Semaphore çš„å®ç°å…¨éƒ¨æ˜¯ä¾èµ–äº AQSã€‚<br>ä»¥ä¸‹ä¸º Semaphore çš„ç±»å›¾ï¼š<br> <img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/Semphore%E7%9A%84%E9%9D%9E%E5%85%AC%E5%B9%B3%E4%BE%9D%E8%B5%96.png" alt=""></p><!-- åœ¨è¿™é‡Œå½“è·å–çš„èµ„æºæ•°å·²ç»æˆä¸ºäº†è´Ÿæ•°ï¼Œé‚£ä¹ˆé¦–å…ˆä¼šå°†ä¸Šä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸º`SINGLE`(-1)ï¼Œè¿™æ ·çš„è¯ï¼Œå½“ä¸Šä¸€ä¸ªèŠ‚ç‚¹è¢«é‡Šæ”¾æˆ–è€…è¢«å–æ¶ˆçš„è¯ï¼Œé‚£ä¹ˆå®ƒçš„åç»­èŠ‚ç‚¹å°±ä¼šè¿è¡Œï¼Œ --><!-- AQSé‡Œé¢ï¼Œç‹¬å é”çš„è¯æ˜¯åœ¨é‡Šæ”¾é”çš„æ—¶å€™ä¼šè¿›è¡Œé€šçŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†æ˜¯å…±äº«é”å´ä¸æ˜¯ï¼Œå®ƒæ˜¯åœ¨å¼€å§‹è¿è¡Œçš„æ—¶å€™å°±ç›´æ¥é€šçŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ --><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ Semaphore æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><p>å¦‚ä¸‹Demo<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> no;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span> ;i&lt; <span class="number">2</span> ;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> SemaphoreTest(i)).start();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.currentThread().sleep(<span class="number">1000000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(no + <span class="string">"start"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            semaphore.acquire();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(no);</span><br><span class="line">        System.out.println(<span class="string">"semaphore"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.currentThread().sleep(<span class="number">10000</span>);</span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SemaphoreTest</span><span class="params">(<span class="keyword">int</span> no)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.no = no;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé¦–å…ˆè·å–åˆ° permits çš„çº¿ç¨‹ä¼šæ‰§è¡Œï¼Œè€Œç¬¬äºŒä¸ªçº¿ç¨‹åˆ™ä¼šè¢«é˜»å¡ï¼Œç›´åˆ° permits è¢«é‡Šæ”¾ã€‚è¿™ä¹Ÿæ˜¯ Semaphore çš„ç›®çš„ï¼Œæ§åˆ¶æœ‰å¤šå°‘ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶çš„è®¿é—®æŸä¸€ä¸ªèµ„æºã€‚</p><h4 id="è®¾ç½®permits"><a href="#è®¾ç½®permits" class="headerlink" title="è®¾ç½®permits"></a>è®¾ç½®permits</h4><p>åœ¨ Semaphore é‡Œé¢ï¼Œç›´æ¥ä½¿ç”¨ AQS é‡Œé¢çš„<code>state</code>å˜é‡æ¥å†³å®šå…è®¸å¤šå°‘ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä¸ªèµ„æºï¼Œé€šè¿‡ Semaphore çš„æ„é€ å‡½æ•°å°±å¯ä»¥å‘ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Semaphore</span><span class="params">(<span class="keyword">int</span> permits)</span> </span>&#123;</span><br><span class="line">    sync = <span class="keyword">new</span> NonfairSync(permits);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2694183684443567898L</span>;</span><br><span class="line"></span><br><span class="line">    NonfairSync(<span class="keyword">int</span> permits) &#123;</span><br><span class="line">        <span class="keyword">super</span>(permits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquireShared(acquires);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¯¥superå°±æ˜¯è°ƒç”¨ Sync çš„æ„é€ å‡½æ•°ï¼Œç„¶åè°ƒç”¨ AQS é‡Œé¢çš„ <code>setStateæ–¹æ³•</code>ï¼Œæœ€åè®¾ç½® AQS çš„ stateã€‚</p><h4 id="è·å–permits"><a href="#è·å–permits" class="headerlink" title="è·å–permits"></a>è·å–permits</h4><p>å½“ä¸€ä¸ªçº¿ç¨‹å°è¯•è°ƒç”¨ acquire æ–¹æ³•çš„æ—¶å€™ï¼Œæœ€ç»ˆä¼šé€šè¿‡ NonfairSync çš„ tryAcquireShared æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ï¼Œä¼šè·å–å½“å‰çº¿ç¨‹çš„ stateï¼Œç„¶åå‡å»å…¥å‚å¸¦è¿‡æ¥çš„å‚æ•°ï¼ˆé»˜è®¤æ˜¯ 1 ï¼‰ï¼Œæœ€ååˆ¤æ–­æ˜¯å¦å°äº 0ï¼Œè‹¥å¤§äº 0 çš„è¯ï¼Œåˆ™ç›´æ¥é‡‡ç”¨ CAS çš„æ“ä½œå°†å‰©ä½™çš„ state æ›¿æ¢æ‰ã€‚å°äº 0 çš„è¯ï¼Œç›´æ¥è¿”å›å¹¶ä¸”ä¼šè¿›å…¥å¦ä¸€ä¸ªæ–¹æ³•ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">nonfairTryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> available = getState();</span><br><span class="line">        <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">        <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            <span class="keyword">return</span> remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetState</span><span class="params">(<span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// See below for intrinsics setup to support this</span></span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, stateOffset, expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç”±äº state æ˜¯ç”± <code>volatile</code> ä¿®é¥°çš„ï¼Œæ‰€ä»¥è¯´å½“ä¸€ä¸ªçº¿ç¨‹åŸå­æ€§çš„ä¿®æ”¹äº† stateï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿä¼šç«‹å³è·å–åˆ° state çš„æœ€æ–°çŠ¶æ€çš„ã€‚<br>è¿™ä¸ªæ–¹æ³•ä¸æ˜¯ä¸€ä¸ªåŸå­æ€§çš„ï¼Œä½†æ˜¯ç”±äº CAS æ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œé‚£ä¹ˆæœ€ç»ˆè¿˜æ˜¯èƒ½ä¿è¯ä¸€è‡´æ€§çš„ã€‚å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨è·å–åˆ°äº† available æ°å¥½ä¸º 1ï¼Œ å‡†å¤‡å‡å» 1 çš„æ—¶å€™ï¼Œæ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹æ°å¥½ CAS æ‰§è¡Œå®Œæ¯•ï¼Œå°† state æ›´æ–°ä¸º 0 äº†ï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œ CAS çš„æ—¶å€™ï¼Œç”±äº expect å·²ç»ä¿®æ”¹ä¸º 0 äº†ï¼Œæ‰€ä»¥æ­¤æ—¶ CAS æ“ä½œä¸€å®šä¸æˆåŠŸã€‚</li><li>å¦‚æœåœ¨ getState ä¹‹å‰ï¼Œstate å·²ç»è¢«ä¿®æ”¹æˆ 0 çš„ï¼Œé‚£ä¹ˆç”±äº <code>remaining &lt; 0</code>ï¼Œæ‰€ä»¥ç›´æ¥è¿”å› remainingã€‚</li></ol><h4 id="çº¿ç¨‹é˜»å¡"><a href="#çº¿ç¨‹é˜»å¡" class="headerlink" title="çº¿ç¨‹é˜»å¡"></a>çº¿ç¨‹é˜»å¡</h4><p>åœ¨è¿™é‡Œå…ˆç®€å•ä»‹ç»ä¸‹çº¿ç¨‹çš„é˜»å¡æ–¹å¼ï¼š<br>é¦–å…ˆç”Ÿæˆä¸€ä¸ª Nodeï¼Œç„¶åå†åˆ¤æ–­ä¸‹é˜Ÿåˆ—çš„å°¾éƒ¨ tail æ˜¯ä¸æ˜¯ä¸º nullï¼Œå¦‚æœæ˜¯çš„è¯åˆå§‹åŒ– head å’Œ tailï¼Œå¹¶ä¸”å°†å½“å‰çº¿ç¨‹çš„ Node çš„å‰ç½®èŠ‚ç‚¹æŒ‡å‘ headï¼Œç„¶åé€šè¿‡ CAS æ“ä½œå°† tail è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºçš„ nodeï¼Œ æœ€åå°† head çš„åç½®èŠ‚ç‚¹æŒ‡å‘è¯¥èŠ‚ç‚¹ã€‚</p><p>ç„¶åå†åˆ¤æ–­å‰ç½®èŠ‚ç‚¹æ˜¯ä¸æ˜¯ headï¼Œæ˜¯çš„è¯å°±å†æ¬¡å°è¯•è·å– stateï¼Œè‹¥è·å–ä¸åˆ°åˆ™ç›´æ¥å°†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ waitStatus ä¿®æ”¹ä¸º -1ï¼ˆå³åç½®èŠ‚ç‚¹çš„çº¿ç¨‹éœ€è¦è¢«å”¤é†’ï¼‰ç„¶åç›´æ¥é€šè¿‡<code>LockSupport.park(this)</code>å°†å…¶é˜»å¡ã€‚</p><p>å½“ CAS æ“ä½œå¤±è´¥ï¼Œä¸€èˆ¬éƒ½æ˜¯ state å·²ç»å°äº 0 äº†ï¼Œæ­¤æ—¶å°±ä¼šè¿›å…¥ doAcquireSharedInterruptibly æ–¹æ³•é‡Œé¢ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šä½¿ç”¨ AQS é‡Œé¢çš„ FIFO é˜Ÿåˆ—ï¼Œæ¥å®ç°å¯¹äºä¸´ç•Œèµ„æºçš„æ§åˆ¶ã€‚</p><h5 id="è¯¦ç»†"><a href="#è¯¦ç»†" class="headerlink" title="è¯¦ç»†"></a>è¯¦ç»†</h5><p>Semaphore é¦–å…ˆä¼šè¿›è¡Œåˆ›å»ºä¸€ä¸ª Nodeï¼Œåœ¨é¦–æ¬¡é˜»å¡æŸä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œç”±äº tail ä¸ºnullï¼Œæ‰€ä»¥ä¼šç›´æ¥è¿›å…¥ enq æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ä¼šå°† tail å’Œ head éƒ½è®¾ç½®ä¸ºä¸€ä¸ªæ–°çš„ nodeï¼Œç„¶åå±•å¼€ç¬¬äºŒæ¬¡çš„å¾ªç¯ï¼Œæœ€ååœ¨å°†å½“å‰çº¿ç¨‹çš„ node çš„ prev æŒ‡å‘ headï¼Œé€šè¿‡CASæ“ä½œå°† tail æŒ‡å®šä¸ºè¯¥nodeï¼Œæœ€åå°† head çš„ next æŒ‡å‘ è¯¥nodeï¼ˆæ³¨æ„è¿™ä¸€æ­¥ä¸ºéåŸå­æ€§çš„ï¼Œæ‰€ä»¥ä¼šå½±å“åˆ°åé¢çš„releaseæ–¹æ³•çš„ä¸€ä¸ªåˆ¤æ–­ï¼‰<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node t = tail;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åˆ°è¿™é‡Œï¼Œä¸€ä¸ª FIFO é˜Ÿåˆ—å°±ç”Ÿæˆäº†ï¼Œæ­¤æ—¶ head ä¸ºä¸€ä¸ªnodeï¼ˆwaitStatusä¸º0ï¼Œnextä¸ºè¢«é˜»å¡çš„çº¿ç¨‹ï¼‰ï¼Œå½“ä» addWaiter æ–¹æ³•è¿”å›çš„æ—¶å€™ï¼ŒSemaphore è¿˜ä¼šè¿›è¡Œä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹çš„å‰ç½®èŠ‚ç‚¹æ˜¯ headï¼Œå°±å†æ¬¡å°è¯•ä¸€æ¬¡è·å– stateï¼Œå¦‚æœè·å–ä¸åˆ°çš„è¯å°±å°†å‰ç½®èŠ‚ç‚¹çš„ waitStatus è®¾ç½®æˆ -1ï¼Œç„¶åé€šè¿‡<code>LockSupport.park(this)</code>å°†æœ¬çº¿ç¨‹ä¸­æ–­ï¼Œè‡³æ­¤è¯¥çº¿ç¨‹è¢«é˜»å¡äº†ã€‚</p><p><strong>å¦‚æœåœ¨åˆ¤æ–­å‰ç½®èŠ‚ç‚¹æ˜¯ head ä¹‹åï¼Œç„¶åé€šè¿‡ tryAcquireShared è·å–åˆ°äº† state</strong> é‚£ä¹ˆæ­¤æ—¶å°±ä¼šè°ƒç”¨ setHeadAndPropagate å°†è‡ªå·±è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼ŒåŒæ—¶åˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’åç»­çš„èŠ‚ç‚¹</p><h2 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h2><p>å‡å¦‚ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæ˜¯ä¼šè°ƒç”¨ release æ–¹æ³•æ¥é‡Šæ”¾èµ„æºçš„ï¼Œé¦–å…ˆè¿˜æ˜¯ä»¥ CAS æ“ä½œåŸå­æ€§çš„å¢åŠ  stateï¼Œ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> current = getState();</span><br><span class="line">        <span class="keyword">int</span> next = current + releases;</span><br><span class="line">        <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum permit count exceeded"</span>);</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReleaseShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Ensure that a release propagates, even if there are other</span></span><br><span class="line"><span class="comment">        * in-progress acquires/releases.  This proceeds in the usual</span></span><br><span class="line"><span class="comment">        * way of trying to unparkSuccessor of head if it needs</span></span><br><span class="line"><span class="comment">        * signal. But if it does not, status is set to PROPAGATE to</span></span><br><span class="line"><span class="comment">        * ensure that upon release, propagation continues.</span></span><br><span class="line"><span class="comment">        * Additionally, we must loop in case a new node is added</span></span><br><span class="line"><span class="comment">        * while we are doing this. Also, unlike other uses of</span></span><br><span class="line"><span class="comment">        * unparkSuccessor, we need to know if CAS to reset status</span></span><br><span class="line"><span class="comment">        * fails, if so rechecking.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="keyword">int</span> ws = h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;            <span class="comment">// loop to recheck cases</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;                <span class="comment">// loop on failed CAS</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h == head)                   <span class="comment">// loop if head changed</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">        * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">        * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">        * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">        * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">        * non-cancelled successor.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å½“ CAS æ“ä½œæˆåŠŸä¹‹åè¿”å› trueï¼Œç„¶åè°ƒç”¨ doReleaseShared æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•é‡Œé¢ï¼Œä¼šé¦–å…ˆå°† head çš„çŠ¶æ€æ›´æ”¹ä¸º 0ï¼Œç„¶åç„¶åé€šè¿‡ unparkSuccessor æ¥å”¤é†’åé¢çš„çº¿ç¨‹ï¼Œåœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯é‚£ä¸€ä¸ª for å¾ªç¯é‡Œé¢çš„ä»£ç ã€‚</p><h3 id="ä¸ºä»€ä¹ˆforå¾ªç¯çš„æ—¶å€™éœ€è¦ä»å°¾èŠ‚ç‚¹å¼€å§‹"><a href="#ä¸ºä»€ä¹ˆforå¾ªç¯çš„æ—¶å€™éœ€è¦ä»å°¾èŠ‚ç‚¹å¼€å§‹" class="headerlink" title="ä¸ºä»€ä¹ˆforå¾ªç¯çš„æ—¶å€™éœ€è¦ä»å°¾èŠ‚ç‚¹å¼€å§‹"></a>ä¸ºä»€ä¹ˆforå¾ªç¯çš„æ—¶å€™éœ€è¦ä»å°¾èŠ‚ç‚¹å¼€å§‹</h3><p>åœ¨è¿™é‡Œå…¶å®æ˜¯ç”±äºå‰é¢åœ¨è®¾ç½®å°¾èŠ‚ç‚¹çš„æ—¶å€™ CAS è™½ç„¶æ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œï¼Œä½†æ˜¯åœ¨ CAS æ“ä½œä¹‹åï¼Œç´§è·Ÿç€ <code>pred.next = node</code> è¿™ä¸€æ­¥ä¸ºéåŸå­æ€§çš„ï¼Œæ‰€ä»¥å°±å¯¼è‡´äº†æœ‰å¯èƒ½ä»å¤´éå†çš„æ—¶å€™ä¼šæ–­å¼€æ‰ï¼Œæ‰€ä»¥æ­¤æ—¶å°±éœ€è¦ä»å°¾èŠ‚ç‚¹å¼€å§‹ï¼Œå› ä¸ºè¿™æ ·ä¸€å®šä¸ä¼šæ–­å¼€çš„ï¼Œä¹Ÿæ˜¯æœ€æœ‰ä¿è¯çš„ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ä¿¡å·é‡åœ¨è®¡ç®—æœºçš„æ“ä½œç³»ç»Ÿä»¥åŠå¹¶å‘çš„æ—¶å€™ç»å¸¸ä½¿ç”¨åˆ°ï¼Œç”¨äºå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚ï¼ˆå¾…å®šï¼‰ --&gt;
&lt;p&gt;åœ¨Javaè¯­è¨€é‡Œé¢ï¼ŒSemaphore çš„ä½œç”¨æ˜¯å¯ä»¥æ§åˆ¶å¯¹äºåŒä¸€ä¸ªä¸´ç•Œèµ„æºï¼Œå…è®¸å¤šå°‘ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚&lt;br&gt;å½“çº¿ç¨‹æ‰§è¡Œåˆ°ä¸´ç•ŒåŒºåŸŸçš„æ—¶å€™ï¼Œéœ€è¦å…ˆå‘ Semaphore ç”³è¯·ä¸€
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Java8ä¸­çš„æµå¼ç®€å•æ€»ç»“</title>
    <link href="https://somersames.github.io/2019/11/22/Java8%E4%B8%AD%E7%9A%84%E6%B5%81%E5%BC%8F%E7%AE%80%E5%8D%95%E6%80%BB%E7%BB%93/"/>
    <id>https://somersames.github.io/2019/11/22/Java8ä¸­çš„æµå¼ç®€å•æ€»ç»“/</id>
    <published>2019-11-21T16:03:01.000Z</published>
    <updated>2019-11-21T16:16:13.769Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å¤§é‡ä½¿ç”¨Java8ä¸­çš„æµå¼æ“ä½œä¹‹åï¼Œè§‰å¾—ç”¨èµ·æ¥è¿˜æŒºèˆ’æœçš„ï¼Œæ‰€ä»¥æ­£å¥½è¶è¿™ä¸ªæœºä¼šæ€»ç»“ä¸‹ã€‚</p><p>ä½¿ç”¨Java8çš„lambdaè¡¨è¾¾å¼çš„æ—¶å€™ï¼Œéœ€è¦å…ˆæŠŠé›†åˆè½¬ä¸ºä¸€ç§æµï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ stream æ–¹æ³•ï¼Œä½†æ˜¯ stream å´æ˜¯ Collection ç±»é‡Œé¢çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ Collection çš„å­ç±»æ‰å¯ä»¥ä½¿ç”¨ï¼Œæ‰€ä»¥ Map é›†åˆæ˜¯ä½¿ç”¨ä¸äº†çš„ï¼ŒåŒç†ï¼Œå¯¹äºæ•°ç»„ï¼Œå¯ä»¥é€šè¿‡<code>Arrays.stream()</code> æ–¹æ³•æ¥è®²æ•°ç»„è½¬ä¸ºä¸€ä¸ªStreamï¼Œè¿™æ ·ä¹Ÿå¯ä»¥ä½¿ç”¨Streamé‡Œé¢çš„æ–¹æ³•äº†ï¼Œ</p><h2 id="å°†é›†åˆè½¬ä¸ºæµ"><a href="#å°†é›†åˆè½¬ä¸ºæµ" class="headerlink" title="å°†é›†åˆè½¬ä¸ºæµ"></a>å°†é›†åˆè½¬ä¸ºæµ</h2><p>ä¸‹é¢ä»‹ç»å‡ ä¸ªå¾ˆå¸¸ç”¨çš„æ–¹æ³•æ¥ä»‹ç»æµå¼æ“ä½œçš„ä¾¿æ·æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stringList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">stringList.add(<span class="string">"a1"</span>);</span><br><span class="line">stringList.add(<span class="string">"b1"</span>);</span><br><span class="line">stringList.add(<span class="string">"a2"</span>);</span><br><span class="line">stringList.add(<span class="string">"b2"</span>);</span><br><span class="line">stringList.stream();</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°äº†ä¸€ä¸ªæµå¼æ“ä½œï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ä½¿ç”¨Streamé‡Œé¢å®šä¹‰å¥½çš„æ–¹æ³•äº†</p><h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>è¯¥æ–¹æ³•ç”¨äºè¿‡æ»¤æˆ‘ä»¬è®¾ç½®çš„ä¸€äº›åˆ¤æ–­æ¡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">streamFilter</span><span class="params">(List&lt;String&gt; list)</span></span>&#123;</span><br><span class="line">        List&lt;String&gt; result = list.stream().filter(item -&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"a"</span>.equals(item))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåªæ˜¯ä¸€ä¸ªæ™®é€šçš„Stringæ•°ç»„éå†ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœæˆ‘ä»¬é€šè¿‡Java8ä¹‹å‰çš„ä»£ç å†™çš„è¯ï¼Œä¼šé¦–å…ˆ newä¸€ä¸ªListï¼Œç„¶åé€šè¿‡addæ–¹æ³•æ¥è¿›è¡Œæ’å…¥ï¼Œè¿™æ ·è™½ç„¶ä¸ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ä¼šæ˜¾å¾—ä¸æ˜¯é‚£ä¹ˆæ•´æ´ï¼Œä½†æ˜¯ç”¨æµå¼æ“ä½œçš„è¯ï¼Œæ„Ÿè§‰ä¼šæ–¹ä¾¿ä¸å°‘ã€‚</p><p>å¦‚æœæˆ‘ä»¬æœ‰å¤šä¸ªæ¡ä»¶è¦è¿›è¡Œè¿‡æ»¤çš„è¯ï¼Œfilterä¹Ÿæ˜¯æ”¯æŒé“¾å¼è°ƒç”¨çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">streamFilter</span><span class="params">(List&lt;String&gt; list)</span></span>&#123;</span><br><span class="line">        List&lt;String&gt; result = list.stream().filter(item -&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"a1"</span>.equals(item))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">        .filter(item -&gt; (item.startsWith(<span class="string">"a"</span>)))</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">        result.stream().forEach(item -&gt; System.out.println(item));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>mapå¸¸ç”¨äºä¸€äº›éå†æ¡ä»¶ï¼Œä¾‹å¦‚å–å‡ºæŸäº›JavaBeançš„å±æ€§å¹¶ä½œä¸ºé›†åˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†ä¸€ä¸ªPersoné›†åˆçš„æ‰€æœ‰å§“åå–å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å–å‡ºé›†åˆå†…æ‰€æœ‰çš„å§“å</span></span><br><span class="line">List&lt;String&gt; nameList = list.stream().map(Person::getName).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="comment">//å»é‡å–å‡ºé›†åˆå†…æ‰€æœ‰çš„å§“å</span></span><br><span class="line">List&lt;String&gt; nameDistinctList = list.stream().map(Person::getName).distinct().collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰¾å‡ºæ‰€æœ‰æˆå¹´çš„äºº</span></span><br><span class="line">List&lt;String&gt; ageList = list.stream().filter(</span><br><span class="line">                item -&gt; (Objects.nonNull(item.getAge()) &amp;&amp; item.getAge() &gt; <span class="number">18</span>)</span><br><span class="line">        ).map(Person::getName).distinct().collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†æ‰€æœ‰å·²ç»æˆå¹´çš„äººæŒ‰ç…§å¹´é¾„è¿›è¡Œåˆ†ç»„</span></span><br><span class="line">Map&lt;Integer, List&lt;Person&gt;&gt; ageSameList = list.stream().filter(</span><br><span class="line">                item -&gt; (Objects.nonNull(item.getAge()) &amp;&amp; item.getAge() &gt; <span class="number">18</span>)</span><br><span class="line">        ).collect(Collectors.groupingBy(Person::getAge));</span><br></pre></td></tr></table></figure><h3 id="findFirst"><a href="#findFirst" class="headerlink" title="findFirst"></a>findFirst</h3><p>åœ¨æˆ‘çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæ„Ÿè§‰è¿™ä¸ªæ–¹æ³•é…åˆæšä¸¾ç±»ç›¸å½“çš„å¥½ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ProvinceEnum &#123;</span><br><span class="line">    BEIJING(<span class="string">"åŒ—äº¬å¸‚"</span>,<span class="string">"110000"</span>),</span><br><span class="line">    TIANJIN(<span class="string">"å¤©æ´¥å¸‚"</span>,<span class="string">"120000"</span>),</span><br><span class="line">    HEBEI(<span class="string">"æ²³åŒ—çœ"</span>,<span class="string">"130000"</span>),</span><br><span class="line">    SHANXI(<span class="string">"å±±è¥¿çœ"</span>,<span class="string">"140000"</span>),</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">private</span> String cn;</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    ProvinceEnum(String cn, String code) &#123;</span><br><span class="line">        <span class="keyword">this</span>.cn = cn;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCnByCode</span><span class="params">(String code)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(ProvinceEnum.values()).filter(</span><br><span class="line">                item -&gt; (StringUtils.isNotEmpty(item) &amp;&amp; item.getCn().equals(code))</span><br><span class="line">        ).map(ProvinceEnum::getCn).findFirst().orElse(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ç”±äºå…¶ä»–çš„æ–¹æ³•å¤§è‡´ä¸è¿™ä¸Šé¢å‡ ä¸ªæ–¹æ³•ç›¸ä¼¼ï¼Œæ‰€ä»¥å°±ä¸å†å†™demoäº†</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å¤§é‡ä½¿ç”¨Java8ä¸­çš„æµå¼æ“ä½œä¹‹åï¼Œè§‰å¾—ç”¨èµ·æ¥è¿˜æŒºèˆ’æœçš„ï¼Œæ‰€ä»¥æ­£å¥½è¶è¿™ä¸ªæœºä¼šæ€»ç»“ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨Java8çš„lambdaè¡¨è¾¾å¼çš„æ—¶å€™ï¼Œéœ€è¦å…ˆæŠŠé›†åˆè½¬ä¸ºä¸€ç§æµï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ stream æ–¹æ³•ï¼Œä½†æ˜¯ stream å´æ˜¯ Collection ç±»é‡Œé¢çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åª
      
    
    </summary>
    
      <category term="Java" scheme="https://somersames.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://somersames.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JDK1.7ä¸­çš„ConcurrentHashMapå®ç°ç»†èŠ‚(äºŒ)</title>
    <link href="https://somersames.github.io/2019/09/15/JDK1-7%E4%B8%AD%E7%9A%84ConcurrentHashMap%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/"/>
    <id>https://somersames.github.io/2019/09/15/JDK1-7ä¸­çš„ConcurrentHashMapå®ç°ç»†èŠ‚/</id>
    <published>2019-09-15T12:35:02.000Z</published>
    <updated>2019-09-15T12:48:37.657Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>åœ¨JDK1.7å‘JDK1.8å‡çº§çš„è¿‡ç¨‹ä¸­ï¼Œ<code>ConcurrentHashMap</code>ç”±åŸæ¥çš„å¯é‡å…¥é”å’Œ<code>CAS</code>é”ç›´æ¥è¢«æ›¿æ¢ä¸º<code>synchronized</code>å…³é”®å­—äº†ï¼Œè™½ç„¶è¯´åœ¨åŠŸèƒ½ä¸Šéƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œä½†æ˜¯åœ¨è¿™é‡Œä¸€ç›´éƒ½æœ‰ä¸€ä¸ªç–‘æƒ‘ï¼Œæ—¢ç„¶åœ¨1.7çš„ä½¿ç”¨è¿‡ç¨‹ä¸­æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œé‚£åˆ°åº•æ˜¯å‡ºäºä»€ä¹ˆåŸå› è¦å°†å…¶æ›¿æ¢å‘¢ã€‚</p><h2 id="JDK1-7ä¸­çš„ConcurrentHashMap"><a href="#JDK1-7ä¸­çš„ConcurrentHashMap" class="headerlink" title="JDK1.7ä¸­çš„ConcurrentHashMap"></a>JDK1.7ä¸­çš„ConcurrentHashMap</h2><p>åœ¨JDK1.7ä¸­ï¼Œå…¶ç»“æ„æ˜¯ç”±ä¸€ä¸ªå¯é‡å…¥é”<code>Segment</code>æ•°ç»„å’Œæ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸‹çš„<code>HashEntry</code>æ•°ç»„æ¥å®ç°çš„ã€‚ç»“æ„å›¾å¦‚ä¸‹:<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/1.7ConcurrentHashMap.png" alt=""></p><p>ç”±äº segment æ˜¯ä¸€ä¸ªé”ï¼Œæ‰€ä»¥å¦‚æœåœ¨å¹¶å‘çš„è¿‡ç¨‹ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹å°è¯•å‘ä¸€ä¸ª segment ä¸­çš„ HashEntry è¿›è¡Œæ’å…¥çš„æ—¶å€™ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè·å–åˆ°é”ï¼Œå…¶ä»–çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ç›´è‡³é”è¢«é‡Šæ”¾ï¼Œæ‰€ä»¥è¿™ä¸ªå®¹å™¨æ˜¯ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„ã€‚</p><!--é‚£ä¹ˆä¸ºä»€ä¹ˆæ˜¯ä¸€ä¸ªå¯é‡å…¥é”å‘¢ï¼Œ--><p>æŸ¥çœ‹ put æ–¹æ³•çš„è°ƒç”¨é“¾çš„æ—¶å€™ï¼Œå¯ä»¥å‘ç°æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨çš„æ˜¯<code>Segment</code>çš„<code>put</code>æ–¹æ³•ã€‚</p><p><code>segment</code> ç±»åœ¨ <code>ConCurrentHashMap</code> ä¸­çš„å˜é‡æ˜¯ä»¥ä¸€ä¸ªæ•°ç»„çš„å½¢å¼æ‰€å­˜åœ¨çš„ï¼Œç”±äº<code>segment</code>ç»§æ‰¿äº† ReentrantLock ï¼Œæ‰€ä»¥æ˜¯å®ƒä¹Ÿæ˜¯ä¸€ä¸ªå¯é‡å…¥é”ï¼Œå› æ­¤åœ¨<code>JDK1.7</code>é‡Œé¢ï¼Œæ˜¯é€šè¿‡ <code>segment</code>çš„ é‡å…¥é”æœºåˆ¶æ¥å®ç°å¹¶å‘çš„å†™å…¥ã€‚åŒæ—¶ä¹Ÿå¯ä»¥å‘ç°å¦‚æœè°ƒç”¨çš„æ˜¯<code>ConcurrentHashMap</code>çš„æ— å‚æ„é€ å‡½æ•°çš„è¯ï¼Œé‚£ä¹ˆåˆå§‹åŒ–<code>Segment</code>æ•°ç»„å¤§å°å°±æ˜¯16ï¼Œå½“ç„¶è¿™ä¸ªæ•°ç»„å¤§å°å…¶å®æ˜¯å¯ä»¥è¢«è°ƒæ•´çš„ï¼Œä½†æ˜¯æ— è®ºæ€æ ·è¿›è¡Œè°ƒæ•´ï¼Œæœ€ç»ˆ segment æ•°ç»„çš„å¤§å°æ°¸è¿œéƒ½æ˜¯2çš„næ¬¡æ–¹ã€‚</p><h2 id="Segment"><a href="#Segment" class="headerlink" title="Segment"></a>Segment</h2><p>åœ¨<code>ConcurrentHashMap</code>é‡Œé¢ï¼Œä¸€ä¸ª<code>segment</code>å°±æ˜¯ä¸€ä¸ª<code>HashEntry</code>çš„æ•°ç»„ï¼Œè€Œä¸€ä¸ª<code>HashEntry</code>å°±æ˜¯ä¸€ä¸ª<code>bucket</code>ã€‚</p><blockquote><p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒConcurrentHashMap é»˜è®¤çš„ segment æ•°ç»„çš„å¤§å°æ˜¯16ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å¤šåªå¯èƒ½æœ‰16ä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œå¤„ç†</p></blockquote><p>å½“è°ƒç”¨ put æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ä¸€ä¸ªå¯é‡å…¥é”çš„ CAS æ“ä½œæ¥å°è¯•è·å–è¯¥ segment é”ï¼Œå¦‚æœè·å–åˆ°äº†åˆ™ç›´æ¥æ–°å»ºä¸€ä¸ª Node èŠ‚ç‚¹ï¼Œå¦‚æœè¿˜æœªè·å–åˆ°åˆ™ç›´æ¥è°ƒç”¨<code>scanAndLockForPut</code>æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> HashEntry&lt;K,V&gt; <span class="title">scanAndLockForPut</span><span class="params">(K key, <span class="keyword">int</span> hash, V value)</span> </span>&#123;</span><br><span class="line">    HashEntry&lt;K,V&gt; first = entryForHash(<span class="keyword">this</span>, hash);</span><br><span class="line">    HashEntry&lt;K,V&gt; e = first;</span><br><span class="line">    HashEntry&lt;K,V&gt; node = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> retries = -<span class="number">1</span>; <span class="comment">// negative while locating node</span></span><br><span class="line">    <span class="keyword">while</span> (!tryLock()) &#123;</span><br><span class="line">        HashEntry&lt;K,V&gt; f; <span class="comment">// to recheck first below</span></span><br><span class="line">        <span class="keyword">if</span> (retries &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node == <span class="keyword">null</span>) <span class="comment">// speculatively create node</span></span><br><span class="line">                    node = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                retries = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(e.key))</span><br><span class="line">                retries = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                e = e.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (++retries &gt; MAX_SCAN_RETRIES) &#123;</span><br><span class="line">            lock();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((retries &amp; <span class="number">1</span>) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                 (f = entryForHash(<span class="keyword">this</span>, hash)) != first) &#123;</span><br><span class="line">            e = first = f; <span class="comment">// re-traverse if entry changed</span></span><br><span class="line">            retries = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="scanAndLockForPutæ–¹æ³•çš„ä½œç”¨"><a href="#scanAndLockForPutæ–¹æ³•çš„ä½œç”¨" class="headerlink" title="scanAndLockForPutæ–¹æ³•çš„ä½œç”¨"></a>scanAndLockForPutæ–¹æ³•çš„ä½œç”¨</h3><p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œä¼šåœ¨ while å¾ªç¯é‡Œé¢å°è¯• 64 æ¬¡ï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸ªå¾ªç¯è¯­å¥é‡Œé¢æœ‰ä¸€äº›ç»†èŠ‚çš„æ“ä½œã€‚å…·ä½“å¦‚ä¸‹ï¼š</p><ul><li>åˆ¤æ–­å½“å‰å¤´èŠ‚ç‚¹ first æ˜¯å¦ä¸º nullï¼Œæ˜¯çš„è¯åˆ™åˆå§‹åŒ– node </li><li>å¦‚æœ first ä¸æ˜¯ nullï¼Œåˆ¤æ–­å½“å‰çš„ key æ˜¯å¦å’Œ first ç›¸ç­‰</li><li>å¦‚æœ first å³ä¸ä¸ºnullï¼Œå¹¶ä¸”å½“å‰çš„ key åˆä¸å’Œå…¥å‚çš„keyç›¸åŒï¼Œåˆ™ç›´æ¥å¯»æ‰¾å…¶ next èŠ‚ç‚¹ï¼Œç›´è‡³ next ä¸ºnullï¼Œç„¶åè¿›è¡Œç¬¬ä¸€æ­¥</li></ul><p>å…¶å®ä¸Šé¢çš„ä¸€äº›æ­¥éª¤ä»…ä»…æ˜¯è¯¥æ–¹æ³•å¾ªç¯çš„ç¬¬ä¸€æ­¥è¦åšçš„ï¼Œå½“ä¸Šè¿°ä¸‰ä¸ªæ­¥éª¤éƒ½è¿›è¡Œå®Œæ¯•ä¹‹åï¼Œé¦–å…ˆä¼šåˆ¤æ–­å¾ªç¯çš„æ¬¡æ•°æ˜¯å¦å·²ç»å¤§äº <code>MAX_SCAN_RETRIES</code> å¦‚æœæ˜¯çš„è¯ï¼Œåˆ™ç›´æ¥è°ƒç”¨ <code>lock</code> æ–¹æ³•ï¼Œå¦‚æœä¸æ˜¯çš„è¯åˆ™è°ƒç”¨ç¬¬ä¸‰ä¸ªåˆ¤æ–­ã€‚</p><p>ç¬¬ä¸‰ä¸ªåˆ¤æ–­ä¸­ä¼šåˆ¤æ–­å½“å‰å¾ªç¯æ¬¡æ•°æ˜¯ä¸æ˜¯å¶æ•°ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™ä¼šåˆ¤æ–­å½“å‰çš„å¤´èŠ‚ç‚¹è¿˜æ˜¯ä¸æ˜¯ä¹‹å‰çš„firstï¼Œå¦‚æœä¸æ˜¯çš„è¯åˆ™éœ€è¦é‡æ–°å°†æ–°çš„å¤´èŠ‚ç‚¹èµ‹å€¼ç»™ first ç„¶åå°†å¾ªç¯æ¬¡æ•°æ”¹æˆ1ï¼Œå†æ¬¡é‡è¯•ã€‚</p><p>å…¶å®è¿™ä¸ªæ–¹æ³•å¦‚æœä»”ç»†çœ‹çœ‹ï¼Œä½ ä¼šå‘ç°è²Œä¼¼æ²¡å•¥ä½œç”¨ï¼Œå› ä¸ºè¿”å›çš„æ˜¯ nodeï¼Œä½†æ˜¯ node ä¸€æ—¦ç¬¬ä¸€æ¬¡è¢«èµ‹å€¼ä¹‹åï¼Œä»¥åä¾¿ä¸ä¼šåšä»»ä½•çš„æ›´æ”¹ï¼Œæ‰€ä»¥æ­£å¦‚è¯¥æ–¹æ³•çš„æ³¨é‡Šæ‰€è¯´çš„ä¸€æ ·ï¼Œ<strong>è¿™ä¸ªæ–¹æ³•ä»…ä»…æ˜¯ä¸º JVM åšä¸€ä¸ªé¢„çƒ­è€Œå·²</strong>ã€‚</p><h3 id="ç»§ç»­è·å–é”"><a href="#ç»§ç»­è·å–é”" class="headerlink" title="ç»§ç»­è·å–é”"></a>ç»§ç»­è·å–é”</h3><p>å¦‚æœåœ¨ 64 æ¬¡ä»¥å†…è¿˜æ˜¯æœªè·å–åˆ°è¯¥é”ï¼Œåˆ™ä¼šè°ƒç”¨<code>lock</code>æ–¹æ³•ï¼Œç”±äº ConcurrentHashMap åœ¨åˆå§‹åŒ– segment çš„æ—¶å€™ï¼Œå¹¶æœªæ˜¾å¼è°ƒç”¨<code>ReentrantLock</code>çš„æ„é€ æ–¹æ³•ï¼Œè€Œ ReentrantLock åˆæ˜¯é»˜è®¤åˆå§‹åŒ–éå…¬å¹³é”ï¼Œæ‰€ä»¥æ­¤æ—¶åœ¨ scanAndLockForPut é‡Œé¢çš„ lock å…¶å®è°ƒç”¨çš„æ˜¯ NonfairSync é‡Œé¢çš„ lock æ–¹æ³•ï¼Œå³å†æ¬¡ä»¥éå…¬å¹³é”çš„æ–¹å¼æ¥å°è¯•è·å–é”<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å½“æœ€åä¸€æ¬¡å¦‚æœ CAS æ“ä½œè¿˜æœªè·å–åˆ°é”çš„æ—¶å€™ï¼Œsegment å°±ä¼šè°ƒç”¨<strong>acquire(1)</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°çš„æ˜¯ if åˆ¤æ–­é‡Œé¢è¿˜æ˜¯ä¼šå†æ¬¡å°è¯•è·å–é”ï¼Œå½“è¿˜æœªè·å–åˆ°é”çš„æ—¶å€™ï¼Œå°±å°†è¯¥ Node æ”¾å…¥åˆ° FIFO é˜Ÿåˆ—çš„æœ«å°¾ï¼Œç„¶åç­‰å¾…ç€è¢«å”¤é†’æ‰§è¡Œ</p><p>ä»ä¸Šé¢çš„ä¸€ä¸ªæµç¨‹ä¸éš¾çœ‹å‡ºï¼Œåœ¨ segment é¦–å…ˆä¼šä»¥å¯é‡å…¥é”çš„æ–¹å¼æ¥å°è¯•æ€§çš„è·å–é”ï¼Œå½“æ²¡å–åˆ°çš„æ—¶å€™ä¼š<strong>whileå¾ªç¯</strong>64æ¬¡åšä¸€ä¸ªé¢„çƒ­ï¼Œå¦‚æœåœ¨å¾ªç¯çš„è¿‡ç¨‹ä¸­è¿˜æ˜¯æœªè·å–åˆ°é”ï¼Œåˆ™ä¼šè¿›è¡Œä¸¤æ¬¡<code>CAS</code>æ“ä½œ(åˆ†åˆ«åœ¨ä¸¤ä¸ªä¸åŒçš„æ–¹æ³•é‡Œé¢)ï¼Œå¦‚æœæœ€ç»ˆè¿˜æ˜¯æ— æ³•è·å–åˆ°é”çš„è¯ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šå°†è‡ªå·±æ”¾å…¥åˆ° AQS ä¸­çš„ FIFO é˜Ÿåˆ—ã€‚</p><p>å›è¿‡å¤´æ¥å†çœ‹ segment é‡Œé¢çš„ç¬¬ä¸€è¡Œä»£ç ï¼š</p><blockquote><p>HashEntry&lt;K,V&gt; node = tryLock() ? null : scanAndLockForPut(key, hash, value);</p></blockquote><p>é‚£ä¹ˆå¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œåœ¨JDK1.7é‡Œé¢ï¼Œputæ–¹æ³•å¦‚æœåœ¨å¤§é‡å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¦‚æœè¦è·å–ä¸€ä¸ªé”ä¼šè¿›è¡Œéå¸¸å¤šçš„æ“ä½œï¼Œè€Œä¸”å®ƒé»˜è®¤çš„ segment æ•°ç»„å¤§å°è¿˜æ˜¯ 16 ï¼Œä¹Ÿå°±æ˜¯è¯´mapçš„æ‰€æœ‰é”®å€¼ï¼Œå‡ºç°ç¢°æ’çš„æ¦‚ç‡ä¸æ˜¯ 1/map.size()ï¼Œè€Œæ°¸è¿œæ˜¯ 1/16ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;åœ¨JDK1.7å‘JDK1.8å‡çº§çš„è¿‡ç¨‹ä¸­ï¼Œ&lt;code&gt;ConcurrentHashMap&lt;/code&gt;ç”±åŸæ¥çš„å¯é‡å…¥é”å’Œ&lt;code&gt;CAS&lt;
      
    
    </summary>
    
      <category term="Java" scheme="https://somersames.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://somersames.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Leetcodeæ•°ç»„ä¸­è¿ç»­åˆ†ç»„</title>
    <link href="https://somersames.github.io/2019/09/08/Leetcode%E6%95%B0%E7%BB%84%E4%B8%AD%E8%BF%9E%E7%BB%AD%E5%88%86%E7%BB%84/"/>
    <id>https://somersames.github.io/2019/09/08/Leetcodeæ•°ç»„ä¸­è¿ç»­åˆ†ç»„/</id>
    <published>2019-09-08T15:19:58.000Z</published>
    <updated>2019-09-08T15:35:54.872Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨Leetcodeä¸Šæœ‰ä¸€é“é¢˜ç›®ï¼Œå¦‚ä¸‹ï¼š</p><blockquote><p>In a deck of cards, each card has an integer written on it.<br>  Return true if and only if you can choose X &gt;= 2 such that it is possible to split the entire deck into 1 or more groups of cards, where:<br>  Each group has exactly X cards.<br>  All the cards in each group have the same integer.</p></blockquote><p>è¿™ä¸€é¢˜å°±æ˜¯ä¸€ä¸ªæ±‚æœ€å¤§å…¬çº¦æ•°çš„é¢˜ç›®ï¼Œå½“ä»»æ„ä¸¤ç»„çš„å…¬çº¦æ•°ä¸º1çš„æ—¶å€™ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±è¯´æ˜ï¼Œä»–ä»¬çš„åˆ†ç»„æ•°é‡ä¸ç›¸ç­‰å°±å¯ä»¥ç›´æ¥è¿”å›falseäº†ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasGroupsSizeX</span><span class="params">(<span class="keyword">int</span>[] deck)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] count = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10000</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> val : deck)&#123;</span><br><span class="line">            count[val]++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> sum = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> val: deck)&#123;</span><br><span class="line">            <span class="keyword">if</span>(sum == -<span class="number">1</span>)&#123;</span><br><span class="line">                sum = count[val];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sum = getGcd(sum,count[val]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(sum == <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨Leetcodeä¸Šæœ‰ä¸€é“é¢˜ç›®ï¼Œå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In a deck of cards, each card has an integer written on it.&lt;br&gt;  Return true if and only if you c
      
    
    </summary>
    
      <category term="ç®—æ³•" scheme="https://somersames.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="leetcode" scheme="https://somersames.github.io/tags/leetcode/"/>
    
  </entry>
  
  <entry>
    <title>mysqlçš„å¹»è¯»(äºŒ)</title>
    <link href="https://somersames.github.io/2019/08/27/mysql%E7%9A%84%E5%B9%BB%E8%AF%BB-%E4%BA%8C/"/>
    <id>https://somersames.github.io/2019/08/27/mysqlçš„å¹»è¯»-äºŒ/</id>
    <published>2019-08-27T15:48:53.000Z</published>
    <updated>2019-08-27T16:06:02.829Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><p>åœ¨InnoDBé‡Œé¢ï¼Œæ˜¯é€šè¿‡å¿«ç…§è¯»æ¥å®ç°<code>RC</code>å’Œ<code>PR</code>éš”ç¦»çº§åˆ«çš„åŒºåˆ†ï¼Œå› ä¸ºåœ¨<code>RC</code>éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ¯ä¸€æ¬¡çš„selectéƒ½æ˜¯ä¸€ä¸ªå¿«ç…§è¯»ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥è¯»å–åˆ°å·²ç»æäº¤çš„æ•°æ®ï¼Œä»è€Œå¯¼è‡´å¹»è¯»ã€‚æ‰€ä»¥åœ¨<code>RC</code>éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¿«ç…§è¯»å’Œå½“å‰è¯»éƒ½æ˜¯å¯ä»¥å‡ºç°å¹»è¯»ã€‚</p><p>ä½†æ˜¯åœ¨<code>PR</code>çš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œç”±äºå¿«ç…§è¯»ä»…ä»…åªç”Ÿæˆä¸€æ¬¡ï¼Œæ‰€ä»¥åœ¨<code>PR</code>çº§åˆ«ä¸‹çš„å¿«ç…§è¯»æ˜¯æ— æ³•å‡ºç°å¹»è¯»çš„ï¼Œä½†æ˜¯å½“å‰è¯»ç¡®å®å¯ä»¥å‡ºç°å¹»è¯»ã€‚</p><p>æŸ¥çœ‹Mysqlå®˜æ–¹å¯¹äº<code>å¹»è¯»</code>çš„å®šä¹‰ã€‚</p><blockquote><p>The so-called phantom problem occurs within a transaction when the same query produces different sets of rows at different times. </p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªäº‹ç‰©åŒä¸€æ¡æŸ¥è¯¢è¯­å¥æŸ¥è¯¢å‡ºæ¥äº†ä¸¤ä¸ªä¸åŒçš„é›†åˆå°±å¯ä»¥ç§°ä¹‹ä¸ºå¹»è¯»ã€‚</p><h3 id="ANSI-SQL-éš”ç¦»çº§åˆ«"><a href="#ANSI-SQL-éš”ç¦»çº§åˆ«" class="headerlink" title="ANSI SQL éš”ç¦»çº§åˆ«"></a>ANSI SQL éš”ç¦»çº§åˆ«</h3><p>åœ¨<code>ANSI SQL éš”ç¦»çº§åˆ«</code>çš„å®šä¹‰ä¸­<code>PR</code>çº§åˆ«æ˜¯å¯ä»¥å‡ºç°å¹»è¯»çš„ã€‚<br>ä½†æ˜¯åœ¨InnoDBå¼•æ“é‡Œé¢è‡ªå·±é€šè¿‡<code>GAPé”</code>å’Œ<code>Next-Keyé”</code>ä½¿å¾—<code>PR</code>éš”ç¦»çº§åˆ«ä¸‹æ— æ³•å‡ºç°å¹»è¯»ã€‚åŸå› å°±åœ¨äºInnoDBçš„<code>GAP</code>é”</p><h2 id="GAPé”"><a href="#GAPé”" class="headerlink" title="GAPé”"></a>GAPé”</h2><p>åœ¨<code>InnoDB</code>é‡Œé¢ï¼ŒGAPé”æ˜¯ç”¨äºé˜²æ­¢å¹»è¯»çš„ä¸€ä¸ªæ‰‹æ®µï¼Œå…·ä½“çš„æ“ä½œæ˜¯é¦–å…ˆå½“æˆ‘ä»¬æ–°å¢ä¸€ä¸ªæ•°æ®çš„æ—¶å€™ï¼Œ<code>InnoDB</code>ä¼šåœ¨æ­¤æ—¶åŠ ä¸€ä¸ª<code>GAP</code>é”ä»è€Œé˜²æ­¢å…¶ä»–äº‹åŠ¡å¯¹è¯¥åŒºé—´çš„ä¸€äº›æ•°æ®æ“ä½œï¼Œå¯¼è‡´å¹»è¯»çš„å‡ºç°ã€‚</p><h3 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><h4 id="PRçº§åˆ«ï¼š"><a href="#PRçº§åˆ«ï¼š" class="headerlink" title="PRçº§åˆ«ï¼š"></a><code>PR</code>çº§åˆ«ï¼š</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from test_lock.test;</span><br><span class="line">+---------+-----------+----------------+------------+-------------+</span><br><span class="line">| user_id | user_name | user_password  | is_deleted | phone       |</span><br><span class="line">+---------+-----------+----------------+------------+-------------+</span><br><span class="line">| a       | zhangsan  | 123456         |          0 | 15112345678 |</span><br><span class="line">| b       | lisi      | lisi123456     |          0 | 15112345678 |</span><br><span class="line">| c       | wangwu    | wangwu123456   |          0 | 15112345678 |</span><br><span class="line">| d       | caocao    | caocao123456   |          0 | 15112345678 |</span><br><span class="line">| e       | liubei    | liubei123456   |          0 | 15112345678 |</span><br><span class="line">| f       | zhangfei  | zhangfei123456 |          0 | 15112345678 |</span><br><span class="line">| g       | guanyu    | guanyu123456   |          0 | 15112345678 |</span><br><span class="line">| h       | daqiao    | daqiao123456   |          0 | 15112345678 |</span><br><span class="line">| m       | xiaoqiao  | xiaoqiao123456 |          0 | 15112345678 |</span><br><span class="line">+---------+-----------+----------------+------------+-------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><em>äº‹ç‰©ä¸€</em>ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test_lock.test where  user_id &gt; &apos;g&apos; and user_id &lt; &apos;m&apos; for update ;</span><br><span class="line">+---------+-----------+---------------+------------+-------------+</span><br><span class="line">| user_id | user_name | user_password | is_deleted | phone       |</span><br><span class="line">+---------+-----------+---------------+------------+-------------+</span><br><span class="line">| h       | daqiao    | daqiao123456  |          0 | 15112345678 |</span><br><span class="line">+---------+-----------+---------------+------------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><em>äº‹ç‰©äºŒ</em>ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test_lock.`test` values(&apos;i&apos;,&apos;daqiao&apos;,&apos;daqiao123456&apos;,0,&apos;15112345678&apos;);</span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶åœ¨<code>PR</code>éš”ç¦»çº§åˆ«ä¸‹ä¼šé˜»å¡ã€‚</p><p>æ­¤æ—¶æŸ¥çœ‹æ•°æ®åº“ä¸­çš„é”ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ysql&gt; select * from performance_schema.data_locks;</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+</span><br><span class="line">| ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE              | LOCK_STATUS | LOCK_DATA |</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+</span><br><span class="line">| INNODB | 140169161014704:1068:140169076344152   |                235275 |        50 |       16 | test_lock     | test        | NULL           | NULL              | NULL       |       140169076344152 | TABLE     | IX                     | GRANTED     | NULL      |</span><br><span class="line">| INNODB | 140169161014704:7:4:14:140169076341272 |                235275 |        50 |       16 | test_lock     | test        | NULL           | NULL              | PRIMARY    |       140169076341272 | RECORD    | X,GAP,INSERT_INTENTION | WAITING     | &apos;m&apos;       |</span><br><span class="line">| INNODB | 140169161013840:1068:140169076338200   |                235274 |        47 |       20 | test_lock     | test        | NULL           | NULL              | NULL       |       140169076338200 | TABLE     | IX                     | GRANTED     | NULL      |</span><br><span class="line">| INNODB | 140169161013840:7:4:14:140169076335256 |                235274 |        47 |       20 | test_lock     | test        | NULL           | NULL              | PRIMARY    |       140169076335256 | RECORD    | X                      | GRANTED     | &apos;m&apos;       |</span><br><span class="line">| INNODB | 140169161013840:7:4:15:140169076335256 |                235274 |        47 |       20 | test_lock     | test        | NULL           | NULL              | PRIMARY    |       140169076335256 | RECORD    | X                      | GRANTED     | &apos;h&apos;       |</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°åœ¨<code>m</code>åˆ—ç”±äº<code>GAP</code>é”å’Œ<code>INSERT_INTENTION</code>äº’ç›¸å†²çªï¼Œå¯¼è‡´<code>äº‹ç‰©äºŒ</code>æ— æ³•è¿›è¡Œæ’å…¥</p><blockquote><p>äº‹ç‰©ä¸€ç”±äºè¿›è¡Œ<code>for update</code>æŸ¥è¯¢ï¼Œæ‰€ä»¥ä¼šå¯¹åŒºé—´åŠ ä¸€ä¸ªGAPé”<br>äº‹ç‰©äºŒç”±äºæ˜¯æ–°å¢ï¼Œæ‰€ä»¥ä¼šåŠ ä¸€ä¸ªæ’å…¥æ„å‘é”<br>ç”±äº<code>GAP</code>é”é˜»å¡ä½äº†æ’å…¥æ„å‘é”ï¼Œå¯¼è‡´<code>äº‹ç‰©äºŒ</code>æ— æ³•è¿›è¡Œæ’å…¥</p></blockquote><p>æ­¤æ—¶<code>äº‹ç‰©äºŒ</code>ä¹Ÿä¼šåœ¨è¿™é‡Œé˜»å¡ä½ï¼Œè€Œåœ¨<code>RC</code>éš”ç¦»çº§åˆ«ä¸‹ï¼Œ<code>äº‹ç‰©äºŒ</code>æ˜¯ä¸ä¼šç­‰å¾…çš„ã€‚<br>ä½†æ˜¯å¦‚æœä»”ç»†ä¸€ç‚¹ï¼Œå…¶å®è¿™é‡Œè¿˜å¯ä»¥å‘ç°å¦ä¸€ä¸ªé”ï¼Œå°±æ˜¯æ’å…¥æ„å‘é”<code>INSERT_INTENTION LOCK</code></p><h2 id="INSERT-INTENTION-LOCK"><a href="#INSERT-INTENTION-LOCK" class="headerlink" title="INSERT_INTENTION_LOCK"></a>INSERT_INTENTION_LOCK</h2><p>Mysqlå®˜æ–¹æ–‡æ¡£ä¸­å°†<code>INSERT_INTENTION</code>å®šä¹‰ä¸ºä¸€ä¸ª<code>GAP</code>é”ï¼Œä½†æ˜¯å®ƒçš„æ„ä¹‰å’ŒçœŸæ­£çš„<code>GAP</code>é”ä¹‹é—´æ˜¯æœ‰å¤©å¤§çš„å·®åˆ«çš„ï¼Œ<code>INSERT_INTENTION_LOCK</code>å¹¶ä¸ä¼šé˜»å¡<code>GAP</code>é”ï¼Œä½†ç›¸å<code>GAP</code>ä¼šé˜»å¡<code>INSERT_INTENTION_LOCK</code>ï¼Œå¹¶ä¸”è¯¥é”çš„é”å®šèŒƒå›´æ˜¯æ’å…¥è¡Œä¸€ç›´åˆ°ä¸‹ä¸€ä¸ªç´¢å¼•ï¼Œè¿™ä¸€æ•´ä¸ªåŒºé—´<br>å¦‚ä¸‹ä¾‹å­ï¼š<br><em>äº‹ç‰©ä¸€</em>ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test_lock.`test` values(&apos;i&apos;,&apos;daqiao&apos;,&apos;daqiao123456&apos;,0,&apos;15112345678&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><em>äº‹ç‰©äºŒ</em>ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_lock.`test` set user_id=&apos;l&apos;  where  user_id = &apos;k&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 0  Changed: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶æŸ¥çœ‹äº‹ç‰©ä¸­é”ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance_schema.data_locks;</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+</span><br><span class="line">| ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+</span><br><span class="line">| INNODB | 140169161014704:1068:140169076344152   |                235293 |        50 |       48 | test_lock     | test        | NULL           | NULL              | NULL       |       140169076344152 | TABLE     | IX        | GRANTED     | NULL      |</span><br><span class="line">| INNODB | 140169161014704:7:4:14:140169076341272 |                235293 |        50 |       48 | test_lock     | test        | NULL           | NULL              | PRIMARY    |       140169076341272 | RECORD    | X,GAP     | GRANTED     | &apos;m&apos;       |</span><br><span class="line">| INNODB | 140169161013840:1068:140169076338200   |                235288 |        47 |       32 | test_lock     | test        | NULL           | NULL              | NULL       |       140169076338200 | TABLE     | IX        | GRANTED     | NULL      |</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°<code>äº‹ç‰©äºŒ</code>ç¡®å®å·²ç»æ‰§è¡ŒæˆåŠŸäº†ï¼Œè€Œä¸”<code>äº‹ç‰©ä¸€</code>çš„æ’å…¥æ„å‘é”å¹¶æœªé˜»å¡äº‹ç‰©äºŒçš„æ’å…¥è¯­å¥<br>ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨Mysqlçš„<code>InnoDB</code>ä¸­ï¼Œå¹»è¯»çš„è§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨äº†ä¸€ä¸ªé—´éš™é”<code>GAP</code>é”æ¥å®ç°çš„</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å®šä¹‰&quot;&gt;&lt;a href=&quot;#å®šä¹‰&quot; class=&quot;headerlink&quot; title=&quot;å®šä¹‰&quot;&gt;&lt;/a&gt;å®šä¹‰&lt;/h2&gt;&lt;p&gt;åœ¨InnoDBé‡Œé¢ï¼Œæ˜¯é€šè¿‡å¿«ç…§è¯»æ¥å®ç°&lt;code&gt;RC&lt;/code&gt;å’Œ&lt;code&gt;PR&lt;/code&gt;éš”ç¦»çº§åˆ«çš„åŒºåˆ†ï¼Œå› ä¸ºåœ¨&lt;code&gt;RC&lt;
      
    
    </summary>
    
      <category term="Mysql" scheme="https://somersames.github.io/categories/Mysql/"/>
    
    
      <category term="Mysql" scheme="https://somersames.github.io/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>Mysqlä¸­çš„å¹»è¯»(ä¸€)</title>
    <link href="https://somersames.github.io/2019/08/18/Mysql%E4%B8%AD%E7%9A%84%E5%B9%BB%E8%AF%BB-%E4%B8%80/"/>
    <id>https://somersames.github.io/2019/08/18/Mysqlä¸­çš„å¹»è¯»-ä¸€/</id>
    <published>2019-08-18T12:41:54.000Z</published>
    <updated>2019-08-18T13:53:34.790Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯å¹»è¯»"><a href="#ä»€ä¹ˆæ˜¯å¹»è¯»" class="headerlink" title="ä»€ä¹ˆæ˜¯å¹»è¯»"></a>ä»€ä¹ˆæ˜¯å¹»è¯»</h2><p>å¹»è¯»è¡¨ç¤ºçš„æ˜¯åœ¨ä¸€ä¸ªäº‹ç‰©é‡Œé¢ åŒä¸€ä¸ª<code>select</code>è¯­å¥ï¼Œå‰åä¸¤æ¬¡æŸ¥è¯¢å‡ºæ¥çš„ç»“æœæ˜¯ä¸ç›¸åŒçš„ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨InnoDBé‡Œé¢ï¼Œå¹»è¯»è·Ÿäº‹ç‰©çš„éš”ç¦»çº§åˆ«æœ‰å…³ï¼Œæ›´åŠ å‡†ç¡®çš„è¯´æ˜¯è·Ÿä¸€ä¸ªäº‹ç‰©çš„å¿«ç…§å’Œå½“å‰è¯»æœ‰å…³</p><p>ä¸‹é¢æ˜¯åœ¨Mysql8.0.11ç‰ˆæœ¬ä¸‹è¿›è¡Œå¹»è¯»çš„å¤ç°ï¼š</p><ul><li>å¼•æ“ï¼šInnoDB</li><li>äº‹ç‰©éš”ç¦»çº§åˆ«ï¼šRead Commited</li></ul><h3 id="MVCCå’Œå¿«ç…§è¯»ä»¥åŠå½“å‰è¯»"><a href="#MVCCå’Œå¿«ç…§è¯»ä»¥åŠå½“å‰è¯»" class="headerlink" title="MVCCå’Œå¿«ç…§è¯»ä»¥åŠå½“å‰è¯»"></a>MVCCå’Œå¿«ç…§è¯»ä»¥åŠå½“å‰è¯»</h3><h4 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h4><p>åœ¨ä»‹ç»MVCCä¹‹å‰å…ˆæ¥ä»‹ç»ä¸‹MVCCä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Œé¦–å…ˆæ•°æ®åº“ä½œä¸ºä¸€ä¸ªæ•°æ®å­˜å‚¨å·¥å…·ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯å­˜åœ¨å¹¶å‘çš„æƒ…å†µï¼Œ<br>åœ¨Mysqlçš„InnoDBé‡Œé¢æœ€å¸¸è§çš„å°±æ˜¯<code>x</code>é”ï¼Œè¿™æ˜¯ä¸€ç§å†™é”ï¼Œåœ¨å¹¶å‘çš„æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªäº‹åŠ¡ä¼šè·å–è¯¥é”ï¼Œå…¶ä»–äº‹åŠ¡åˆ™ä¼šä¸€ç›´ç­‰å¾…ç›´è‡³è·å–åˆ°è¯¥é”ã€‚</p><p>é‚£ä¹ˆåœ¨è¯»å–çš„æ—¶å€™å¦‚ä½•ä¿è¯å¹¶å‘çš„äº‹ç‰©éƒ½èƒ½æ­£ç¡®çš„è¯»å–åˆ°è‡ªå·±æ­£ç¡®çš„æ•°æ®å‘¢ï¼Ÿ</p><p>åœ¨MVCCçš„æ¦‚å¿µé‡Œé¢ï¼Œå¦‚æœäº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ˜¯<code>Read Commited</code>çš„è¯ï¼Œé‚£ä¹ˆæ¯ä¸€æ¬¡çš„å¿«ç…§éƒ½éƒ½ä¼šè¯»å–è¯¥è¡Œçš„æœ€è¿‘ä¸€æ¬¡<code>commited</code>æ•°æ®ï¼Œè€Œå¦‚æœæ˜¯<code>Repeatable Read</code>çš„è¯ï¼Œåˆ™æ˜¯ä¼šè¯»å–å½“å‰äº‹åŠ¡IDå¼€å§‹ä¹‹å‰çš„ä¸€æ¬¡<code>commited</code>æ•°æ®ã€‚</p><p>æ‰€ä»¥MVCCä»…ä»…æ˜¯ä½œä¸ºä¸€ä¸ªä¿è¯æ•°æ®åº“å¹¶å‘è¯»æƒ…å†µä¸‹çš„ä¸€ä¸ªæ•°æ®æ­£ç¡®çš„æ‰‹æ®µè€Œå·²ï¼Œåœ¨ä¸åŒçš„æ•°æ®åº“é‡Œé¢ï¼Œæœ‰ä¸åŒçš„å®ç°ï¼Œä¾‹å¦‚åœ¨<code>OceanBase</code>é‡Œé¢ï¼Œæ˜¯é€šè¿‡æ“ä½œé“¾æ¥è§£å†³å¹¶å‘è¯»çš„é—®é¢˜</p><h4 id="å¿«ç…§è¯»"><a href="#å¿«ç…§è¯»" class="headerlink" title="å¿«ç…§è¯»"></a>å¿«ç…§è¯»</h4><p>å¿«ç…§è¯»æ˜¯åˆ©ç”¨MVCCå’Œ <code>undo log</code> æ¥å®ç°çš„ï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯å½“æˆ‘ä»¬å¯¹æŸè¡Œæ•°æ®ä¿®æ”¹ä¹‹åï¼Œå¹¶ä¸ä¼šå°†åŸå€¼ä¿®æ”¹ï¼Œè€Œæ˜¯åœ¨ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸Šé¢å†æ–°å»ºä¸€ä¸ªç‰ˆæœ¬(ä¿®æ”¹InnoDBçš„éšè—ä¸¤åˆ—)ã€‚<br>æ‰€ä»¥åœ¨ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„<code>äº‹ç‰©ID</code>æ¥è·å–è‡ªå·±æ‰€éœ€è¦çš„æ•°æ®ã€‚å½“ç¬¬ä¸€æ¡ä¸æ»¡è¶³çš„æ—¶å€™ï¼Œä¼šæ²¿ç€<code>undo log</code>ä¸€ç›´å¯»æ‰¾ï¼Œåœ¨<code>Read Commited</code>éš”ç¦»çº§åˆ«ä¸‹å°±æ˜¯ç›´æ¥æ‰¾å‡ºè¯¥è¡Œæ•°æ®æœ€åä¸€æ¬¡æäº¤çš„ç‰ˆæœ¬</p><h4 id="å½“å‰è¯»"><a href="#å½“å‰è¯»" class="headerlink" title="å½“å‰è¯»"></a>å½“å‰è¯»</h4><p>å½“å‰è¯»æ˜¯å¯¹æ•°æ®çš„åŠ é”è¯»å–ï¼Œè¯»å–çš„éƒ½æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œä¾‹å¦‚å¦‚ä¸‹SQLï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select ... for update</span><br><span class="line">select ... in share mode</span><br><span class="line">insert</span><br><span class="line">update</span><br><span class="line">delete</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>åŒæ—¶ä¹Ÿéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå½“å‰è¯»ä¼šå¯¹æ¶‰åŠåˆ°çš„è¡Œéƒ½è¿›è¡ŒåŠ é”</p><h4 id="ä¸ºä»€ä¹ˆä¼šæœ‰å½“å‰è¯»å’Œå¿«æ‰¾è¯»"><a href="#ä¸ºä»€ä¹ˆä¼šæœ‰å½“å‰è¯»å’Œå¿«æ‰¾è¯»" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæœ‰å½“å‰è¯»å’Œå¿«æ‰¾è¯»"></a>ä¸ºä»€ä¹ˆä¼šæœ‰å½“å‰è¯»å’Œå¿«æ‰¾è¯»</h4><p>æŒ‰ç…§Mysqlå®˜æ–¹çš„è§£é‡Šï¼Œå½“å‰è¯»æ˜¯ä¸ºäº†é˜²æ­¢å…¶ä»–äº‹ç‰©ä¿®æ”¹ä½ å³å°†è¿›è¡Œçš„æ“ä½œ</p><blockquote><p>If you query data and then insert or update related data within the same transaction, the regular SELECT statement does not give enough protection. Other transactions can update or delete the same rows you just queried. InnoDB supports two types of locking reads that offer extra safety</p></blockquote><h3 id="å¹»è¯»å‘ç”Ÿçš„æ¡ä»¶"><a href="#å¹»è¯»å‘ç”Ÿçš„æ¡ä»¶" class="headerlink" title="å¹»è¯»å‘ç”Ÿçš„æ¡ä»¶"></a>å¹»è¯»å‘ç”Ÿçš„æ¡ä»¶</h3><p>é¦–å…ˆè§£é‡Šä¸‹Mysqlå®˜æ–¹å¯¹äºå¹»è¯»çš„è§£é‡Šï¼š</p><blockquote><p>The so-called phantom problem occurs within a transaction when the same query produces different sets of rows at different times. For example, if a SELECT is executed twice, but returns a row the second time that was not returned the first time, the row is a â€œphantomâ€ row.</p></blockquote><p>è¿™é‡ŒMysqlå®˜æ–¹è™½ç„¶åªæ˜¯ç»™å‡ºäº†å¯¹äº<code>å¹»è¡Œ</code>çš„å®šä¹‰ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ç®€å•è§£é‡Šä¸‹ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸¤æ¬¡çš„<code>select</code>å‰åå¾—åˆ°çš„ç»“æœé›†æ˜¯ä¸åŒçš„ï¼Œé‚£ä¹ˆæ–°å¤šå‡ºæ¥çš„ä¸€è¡Œå°±å¯ä»¥ç§°ä¹‹ä¸º<code>å¹»è¡Œ</code></p><p><strong>åœ¨è¿™é‡Œç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨PRéš”ç¦»ç•Œåˆ«ä¸‹ï¼Œåªæœ‰å½“å‰è¯»æ‰ä¼šå‡ºç°å¹»è¯»</strong></p><h4 id="Read-Commited"><a href="#Read-Commited" class="headerlink" title="Read Commited"></a>Read Commited</h4><p>åœ¨<code>Read Commited</code>éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ¯ä¸€æ¬¡çš„<code>select</code> éƒ½æ˜¯ä¸€æ¬¡å¿«ç…§è¯»ï¼Œæ‰€ä»¥åœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¹»è¯»å¯ä»¥åœ¨å¿«ç…§è¯»å’Œå½“å‰è¯»å‘ç”Ÿã€‚</p><blockquote><p>äº‹åŠ¡ä¸€<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set session transaction isolation level read committed;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START TRANSACTION;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from szh.t1</span><br><span class="line">    -&gt; ;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from `szh`.`t1`;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>äº‹åŠ¡äºŒ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `szh`.`t1`(`area_id`, `order_num`) VALUES (3, 22);</span><br></pre></td></tr></table></figure></p></blockquote><p>æ­¤æ—¶<code>äº‹åŠ¡ä¸€</code>å†è¿›è¡Œselect<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from `szh`.`t1`;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">|       3 |        22 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>äºæ˜¯å¹»è¯»å‘ç”Ÿäº†</p><h4 id="Repeatable-Read"><a href="#Repeatable-Read" class="headerlink" title="Repeatable Read"></a>Repeatable Read</h4><p>é‚£ä¹ˆå¦‚æœåœ¨<code>Repeatable Read</code>éš”ç¦»çº§åˆ«ä¸‹ï¼Œä¸Šé¢çš„SQLåœ¨æ‰§è¡Œä¸€éä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p><blockquote><p>äº‹åŠ¡ä¸€<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START TRANSACTION;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `t1`</span><br><span class="line">    -&gt; ;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">|       3 |        22 |</span><br><span class="line">|       4 |        33 |</span><br><span class="line">|       5 |        55 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>äº‹åŠ¡äºŒ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `szh`.`t1`(`area_id`, `order_num`) VALUES (6, 66);</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>äº‹åŠ¡ä¸€å†æ¬¡select<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM `t1`;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">|       3 |        22 |</span><br><span class="line">|       4 |        33 |</span><br><span class="line">|       5 |        55 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></blockquote><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯åœ¨å¿«ç…§è¯»ä¸‹é¢ï¼Œæ˜¯æ²¡æœ‰å¹»è¯»å‡ºç°çš„ï¼Œé‚£ä¹ˆä¿®æ”¹selectä¸ºå½“å‰è¯»å‘¢ï¼Ÿ<br>åœ¨äº‹åŠ¡ä¸€é‡Œé¢å†æ¬¡æ‰§è¡Œä»¥ä¸‹SQL<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM `t1` for update;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">|       3 |        22 |</span><br><span class="line">|       4 |        33 |</span><br><span class="line">|       5 |        55 |</span><br><span class="line">|       6 |        66 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°ç¡®å®å‡ºç°äº†ä¸¤æ¬¡çš„selectä¸åŒçš„æƒ…å†µã€‚<br>æ‰€ä»¥éœ€è¦å¼ºè°ƒä¸€ç‚¹çš„æ˜¯ï¼Œåœ¨<code>Repeatable Read</code>éš”ç¦»çº§åˆ«ä¸‹ï¼Œåªæœ‰å½“å‰è¯»æ‰ä¼šå‡ºç°å¹»è¯»ï¼Œå› ä¸ºåœ¨è¯¥çº§åˆ«ä¸‹ï¼Œå¿«ç…§è¯»æ˜¯ä»<code>begin</code>å¼€å§‹çš„ç¬¬ä¸€ä¸ªæ™®é€š<code>select</code>å»ºç«‹çš„<code>Read View</code>ï¼Œä»¥åçš„æ™®é€š<code>select</code>éƒ½æ˜¯åŸºäºç¬¬ä¸€æ¬¡çš„<code>select</code>ï¼Œè‡ªç„¶è€Œç„¶ä¸ä¼šå‡ºç°å¹»è¯»äº† </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ä»€ä¹ˆæ˜¯å¹»è¯»&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯å¹»è¯»&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯å¹»è¯»&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯å¹»è¯»&lt;/h2&gt;&lt;p&gt;å¹»è¯»è¡¨ç¤ºçš„æ˜¯åœ¨ä¸€ä¸ªäº‹ç‰©é‡Œé¢ åŒä¸€ä¸ª&lt;code&gt;select&lt;/code&gt;è¯­å¥ï¼Œå‰åä¸¤æ¬¡æŸ¥è¯¢å‡ºæ¥çš„ç»“æœæ˜¯ä¸ç›¸åŒçš„ï¼Œéœ€è¦
      
    
    </summary>
    
      <category term="Mysql" scheme="https://somersames.github.io/categories/Mysql/"/>
    
    
      <category term="Mysql" scheme="https://somersames.github.io/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>Mysqlæ•°æ®åº“å‡ºç°æ­»é”çš„æƒ…å†µ(ä¸€)</title>
    <link href="https://somersames.github.io/2019/08/04/Mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%BA%E7%8E%B0%E6%AD%BB%E9%94%81%E7%9A%84%E6%83%85%E5%86%B5-%E4%B8%80/"/>
    <id>https://somersames.github.io/2019/08/04/Mysqlæ•°æ®åº“å‡ºç°æ­»é”çš„æƒ…å†µ-ä¸€/</id>
    <published>2019-08-04T08:32:31.000Z</published>
    <updated>2019-08-04T08:49:05.600Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸´è¿‘ä¸Šçº¿ä¹‹å‰ï¼Œæˆ‘ä»¬ç³»ç»Ÿåšäº†ä¸€æ¬¡å‹åŠ›æµ‹è¯•ï¼Œå‘ç°æœ‰ä¸€ä¸ªæ¥å£åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ä¼šå‡ºç°ä¸€ä¸ªæ­»é”çš„æƒ…å†µã€‚ã€‚é¦–å…ˆç”³æ˜â€¦ä¸æ˜¯æˆ‘å†™çš„ï¼Œæˆ‘åªæ˜¯å¸®å¿™æ’æŸ¥ä¸‹ã€‚</p><p>éšç€å¯¹Mysqlé”çš„æ·±å…¥äº†è§£ï¼Œäºæ˜¯å°±å‡†å¤‡å†™å‡ ç¯‡æ–‡ç« æ¥è®°å½•ä¸‹Mysqlå„ç§äº‹ç‰©å’Œç´¢å¼•çš„æƒ…å†µä¸‹å‡ºç°æ­»é”çš„æƒ…å†µã€‚</p><p>ä»Šå¤©å°±ä»‹ç»ä¸‹åœ¨å¹¶å‘æ’å…¥çš„æƒ…å†µä¸‹ï¼Œå“ªå‡ ç§æƒ…å†µä¼šå‡ºç°æ­»é”ï¼š</p><h2 id="INNODBä¸‹çš„å„ç§é”"><a href="#INNODBä¸‹çš„å„ç§é”" class="headerlink" title="INNODBä¸‹çš„å„ç§é”"></a>INNODBä¸‹çš„å„ç§é”</h2><p>åœ¨ä»‹ç»é”çš„æ—¶å€™åªä¼šä»‹ç»è·Ÿæœ¬èŠ‚ç›¸å…³çš„é”ï¼Œè€Œä¸”åªä¼šè®²è¿°å¤§æ¦‚æ˜¯ä»€ä¹ˆï¼Œè‡³äºé”çš„æ›´åŠ è¯¦ç»†çš„è®²è§£å¯èƒ½ä¼šåˆ°ä»¥åå†è¯¦ç»†ä»‹ç»ã€‚</p><h3 id="è¡Œé”"><a href="#è¡Œé”" class="headerlink" title="è¡Œé”"></a>è¡Œé”</h3><p>è¡Œé”åˆ†ä¸ºå†™é”å’Œè¯»å–é”ï¼Œ</p><blockquote><p>è¯»é”ï¼ˆSé”ï¼‰ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸º <code>å…±äº«é”</code> ï¼Œ å®ƒè¡¨ç¤ºçš„æ˜¯ä»»ä½•ä¸€ä¸ªäº‹ç‰©éƒ½å¯ä»¥è¯»å–è¯¥è¡Œæ•°æ®(å¯ä»¥è¢«å¤šä¸ªäº‹ç‰©è·å–åˆ°)ã€‚</p></blockquote><blockquote><p>å†™é”ï¼ˆXé”ï¼‰ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºæ’å®ƒé”ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯è¯¥è¡Œæ•°æ®ä¸å…è®¸ä»»ä½•äººè¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶ä¹Ÿä¸å…è®¸ä»»ä½•äº‹ç‰©è·å–è¯¥è¡Œäº‹ç‰©çš„Sé”ï¼Œä½†æ˜¯æ™®é€šçš„ <code>select</code> è¯­å¥æ˜¯å¯ä»¥çš„ã€‚</p></blockquote><h2 id="èƒŒæ™¯ä¿¡æ¯ä¸€"><a href="#èƒŒæ™¯ä¿¡æ¯ä¸€" class="headerlink" title="èƒŒæ™¯ä¿¡æ¯ä¸€"></a>èƒŒæ™¯ä¿¡æ¯ä¸€</h2><h3 id="æ³¨æ„ï¼šä»¥ä¸‹æµ‹è¯•éƒ½æ˜¯åŸºäºè¯¥äº‹ç‰©éš”ç¦»çº§åˆ«å’Œæ•°æ®åº“ç‰ˆæœ¬"><a href="#æ³¨æ„ï¼šä»¥ä¸‹æµ‹è¯•éƒ½æ˜¯åŸºäºè¯¥äº‹ç‰©éš”ç¦»çº§åˆ«å’Œæ•°æ®åº“ç‰ˆæœ¬" class="headerlink" title="æ³¨æ„ï¼šä»¥ä¸‹æµ‹è¯•éƒ½æ˜¯åŸºäºè¯¥äº‹ç‰©éš”ç¦»çº§åˆ«å’Œæ•°æ®åº“ç‰ˆæœ¬"></a>æ³¨æ„ï¼šä»¥ä¸‹æµ‹è¯•éƒ½æ˜¯åŸºäºè¯¥äº‹ç‰©éš”ç¦»çº§åˆ«å’Œæ•°æ®åº“ç‰ˆæœ¬</h3><p>æ•°æ®åº“ç‰ˆæœ¬ï¼š8.0.11</p><p>äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šREPEATABLE-READ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE 'transaction_isolation';</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line">| Variable_name         | Value           |</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line">| transaction_isolation | REPEATABLE-READ |</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="SQLå‡†å¤‡"><a href="#SQLå‡†å¤‡" class="headerlink" title="SQLå‡†å¤‡:"></a>SQLå‡†å¤‡:</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> test_lock  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_lock.<span class="string">`test`</span> (</span><br><span class="line">    <span class="string">`user_id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`user_name`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`user_password`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`is_deleted`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`phone`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`user_id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`t1_god`</span> (<span class="string">`user_name`</span>,<span class="string">`user_password`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure><p>å‡†å¤‡æ•°æ®ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'a'</span>,<span class="string">'zhangsan'</span>,<span class="string">'123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'b'</span>,<span class="string">'lisi'</span>,<span class="string">'lisi123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'c'</span>,<span class="string">'wangwu'</span>,<span class="string">'wangwu123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'d'</span>,<span class="string">'caocao'</span>,<span class="string">'caocao123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'e'</span>,<span class="string">'liubei'</span>,<span class="string">'liubei123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'f'</span>,<span class="string">'zhangfei'</span>,<span class="string">'zhangfei123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'g'</span>,<span class="string">'guanyu'</span>,<span class="string">'guanyu123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'h'</span>,<span class="string">'xiaoqiao'</span>,<span class="string">'xiaoqiao123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br></pre></td></tr></table></figure><h3 id="æƒ…å†µä¸€ï¼š"><a href="#æƒ…å†µä¸€ï¼š" class="headerlink" title="æƒ…å†µä¸€ï¼š"></a>æƒ…å†µä¸€ï¼š</h3><blockquote><p> ä¸‰ä¸ªäº‹ç‰©éƒ½æ‰§è¡ŒåŒä¸€ä¸ªInsertè¯­å¥ï¼Œç¬¬ä¸€ä¸ªäº‹ç‰©ç„¶åå›æ»š</p></blockquote><p>æ­¤æ—¶ç¬¬ä¸‰ä¸ªäº‹ç‰©ä¼šæç¤ºæ­»é”ï¼Œç¬¬äºŒä¸ªäº‹ç‰©æ­£å¸¸æ’å…¥ã€‚</p><h4 id="å¤ç°æ­¥éª¤ï¼š"><a href="#å¤ç°æ­¥éª¤ï¼š" class="headerlink" title="å¤ç°æ­¥éª¤ï¼š"></a>å¤ç°æ­¥éª¤ï¼š</h4><p>å¼€å¯ä¸‰ä¸ªäº‹ç‰©ï¼Œæ¯ä¸€ä¸ªäº‹ç‰©åˆ†åˆ«æ‰§è¡Œå¦‚ä¸‹SQLï¼Œç„¶åå†å°†ç¬¬ä¸€ä¸ªäº‹ç‰©è¿›è¡Œå›æ»šæˆ–è€…æäº¤ï¼Œç„¶åä½ å°±ä¼šå‘ç°ç¬¬ä¸‰ä¸ªäº‹ç‰©å‘ç”Ÿäº†æ­»é”ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## DeadLock</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'i'</span>,<span class="string">'daqiao'</span>,<span class="string">'daqiao123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br></pre></td></tr></table></figure><p>Mysqlæç¤ºå¦‚ä¸‹ï¼š</p><blockquote><p>[2019-08-04 14:33:48] Connected<br>sql&gt; start transaction<br>[2019-08-04 14:33:49] completed in 4 ms<br>sql&gt; begin<br>[2019-08-04 14:33:49] completed in 6 ms<br>sql&gt; insert into test_lock.<code>test</code> values(â€˜iâ€™,â€™daqiaoâ€™,â€™daqiao123456â€™,0,â€™15112345678â€™)<br>[2019-08-04 14:34:00] [40001][1213] Deadlock found when trying to get lock; try restarting transaction<br>[2019-08-04 14:34:00] [40001][1213] Deadlock found when trying to get lock; try restarting transaction</p></blockquote><p>é‚£ä¹ˆæ‰“å°å‡ºMysqlå‡ºç°æ­»é”çš„æ—¥å¿—ï¼šé‡ç‚¹æ—¥å¿—å¦‚ä¸‹</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line"><span class="number">2019</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">06</span>:<span class="number">33</span>:<span class="number">59</span> <span class="number">0</span>x7f1818599700</span><br><span class="line">*** (<span class="number">1</span>) TRANSACTION:</span><br><span class="line">TRANSACTION <span class="number">231690</span>, ACTIVE <span class="number">34</span> sec inserting</span><br><span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">4</span> lock <span class="keyword">struct</span>(s), heap size <span class="number">1136</span>, <span class="number">2</span> row lock(s)</span><br><span class="line">MySQL thread id <span class="number">9</span>, OS thread handle <span class="number">139741464762112</span>, query id <span class="number">95</span> <span class="number">172</span><span class="variable">.17</span><span class="variable">.0</span><span class="variable">.1</span> root update</span><br><span class="line"><span class="comment">/* ApplicationName=IntelliJ IDEA 2019.1.3 */</span> insert into test_lock.<span class="meta">`test` values('i','daqiao','daqiao123456',0,'15112345678')</span></span><br><span class="line">*** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id <span class="number">7</span> page no <span class="number">4</span> n bits <span class="number">80</span> index PRIMARY of <span class="keyword">table</span> <span class="meta">`test_lock`.`test` trx id 231690 lock_mode X insert intention waiting</span></span><br><span class="line">Record lock, heap no <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">8</span>; hex <span class="number">73757072656</span>d756d; asc supremum;;</span><br><span class="line"></span><br><span class="line">*** (<span class="number">2</span>) TRANSACTION:</span><br><span class="line">TRANSACTION <span class="number">231691</span>, ACTIVE <span class="number">10</span> sec inserting</span><br><span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line"><span class="number">4</span> lock <span class="keyword">struct</span>(s), heap size <span class="number">1136</span>, <span class="number">2</span> row lock(s)</span><br><span class="line">MySQL thread id <span class="number">10</span>, OS thread handle <span class="number">139741464467200</span>, query id <span class="number">139</span> <span class="number">172</span><span class="variable">.17</span><span class="variable">.0</span><span class="variable">.1</span> root update</span><br><span class="line"><span class="comment">/* ApplicationName=IntelliJ IDEA 2019.1.3 */</span> insert into test_lock.<span class="meta">`test` values('i','daqiao','daqiao123456',0,'15112345678')</span></span><br><span class="line">*** (<span class="number">2</span>) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id <span class="number">7</span> page no <span class="number">4</span> n bits <span class="number">80</span> index PRIMARY of <span class="keyword">table</span> <span class="meta">`test_lock`.`test` trx id 231691 lock mode S</span></span><br><span class="line">Record lock, heap no <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">8</span>; hex <span class="number">73757072656</span>d756d; asc supremum;;</span><br><span class="line"></span><br><span class="line">*** (<span class="number">2</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id <span class="number">7</span> page no <span class="number">4</span> n bits <span class="number">80</span> index PRIMARY of <span class="keyword">table</span> <span class="meta">`test_lock`.`test` trx id 231691 lock_mode X insert intention waiting</span></span><br><span class="line">Record lock, heap no <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">8</span>; hex <span class="number">73757072656</span>d756d; asc supremum;;</span><br><span class="line"></span><br><span class="line">*** WE ROLL BACK TRANSACTION (<span class="number">2</span>)</span><br><span class="line">------------</span><br></pre></td></tr></table></figure><p>ä»ä»¥ä¸Šæ—¥å¿—æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œäº‹ç‰©ä¸€æ­£åœ¨è¯·æ±‚è¯¥è¡Œè®°å½•çš„ <code>Xé”</code> ï¼Œäº‹ç‰©äºŒæŒæœ‰è¯¥è¡Œçš„<code>Sé”</code>ï¼Œä½†æ˜¯ä¹Ÿåœ¨ç­‰å¾…è·å–è¯¥è¡Œçš„<code>Xé”</code>ã€‚</p><p>å…³äºMysqlçš„ <code>insert</code> é€»è¾‘ï¼Œå¯ä»¥å¤§è‡´ç†è§£ä¸ºå¦‚æœä¸€ä¸ªäº‹ç‰©æ­£åœ¨å¯¹ä¸€ä¸ªè®°å½•è¿›è¡Œ <code>insert</code>ï¼Œæ­¤æ—¶ InnoDB å¹¶ä¸ä¼šä¸»åŠ¨çš„å°†å…¶åŠ ä¸€ä¸ªé”ï¼Œè€Œæ˜¯åœ¨ä¸»é”®ç´¢å¼•ä¸ŠåŠ ä¸€ä¸ª <code>trx_id</code>ï¼Œ</p><p>å½“ç¬¬äºŒä¸ªäº‹ç‰©æ£€æµ‹åˆ°è¯¥è¡Œè®°å½•æ­£åœ¨è¢«ä¸€ä¸ªæ´»è·ƒçš„äº‹ç‰©æŒæœ‰çš„æ—¶å€™ï¼Œæ­¤æ—¶ç¬¬äºŒä¸ªäº‹ç‰©ä¼šå¸®ç¬¬ä¸€ä¸ªäº‹ç‰©çš„éšå¼é”ä½è½¬ä¸ºæ˜¾å¼é”ã€‚å¦‚ä¸‹ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## DeadLock</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'i'</span>,<span class="string">'daqiao'</span>,<span class="string">'daqiao123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æŸ¥çœ‹Mysqlä¸­é”çš„æƒ…å†µï¼š</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/insert%E6%AD%BB%E9%94%81%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%BA%8B%E7%89%A9.png" alt=""></p><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶Mysqlä»…ä»…æ˜¯åœ¨è¡¨ä¸ŠåŠ å…¥äº†ä¸€ä¸ªæ’å…¥æ„å‘é”ï¼ˆIXé”ï¼‰ï¼ŒæŒæœ‰è¯¥é”è¡¨ç¤ºè¯¥äº‹ç‰©åœ¨æ¥ä¸‹æ¥æœ‰å¯èƒ½ä¼šå¯¹è‡ªå·±è®¾è®¡åˆ°çš„è¡ŒåŠ å…¥æ’å®ƒé”ï¼ˆXé”ï¼‰</p><p><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html" target="_blank" rel="noopener">Mysqlå…³äºæ„å‘é”çš„ä»‹ç»</a></p><blockquote><p>The intention locking protocol is as follows:</p><ul><li>Before a transaction can acquire a shared lock on a row in a table, it must first acquire an <code>IS</code> lock or stronger on the table.</li><li>Before a transaction can acquire an exclusive lock on a row in a table, it must first acquire an <code>IX</code> lock on the table.</li></ul></blockquote><p>å¤§æ„å°±æ˜¯å¦‚æœä½ æƒ³è·å¾—ä¸€ä¸ªè¡Œçš„ <code>Xé”</code>ï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»å…ˆè·å–è¡¨çš„ <code>IXé”</code></p><p>é‚£ä¹ˆæ­¤æ—¶å†è¿›è¡Œç¬¬äºŒä¸ªäº‹ç‰©çš„æ’å…¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## DeadLock</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'i'</span>,<span class="string">'daqiao'</span>,<span class="string">'daqiao123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br></pre></td></tr></table></figure><p>å†æ¬¡æŸ¥çœ‹æ•°æ®åº“ä¸­çš„é”ï¼š</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/Mysql%E7%AC%AC%E4%BA%8C%E4%B8%AA%E4%BA%8B%E7%89%A9.png" alt=""></p><p>æ­¤æ—¶ä¼šå‘ç°ç¬¬ä¸€ä¸ªäº‹ç‰©å·²ç»è·å–åˆ°äº†è¡Œçº§åˆ«çš„<code>Xé”</code>ï¼Œç¬¬äºŒä¸ªäº‹ç‰©è·å–åˆ°äº† <code>IX</code> é”ä»¥åŠ <code>Sé”</code> ã€‚</p><p>é‚£ä¹ˆæ­¤æ—¶ç¬¬ä¸‰ä¸ªäº‹ç‰©å¼€å¯ä¹‹åæ•°æ®åº“ä¸­çš„é”åˆä¼šæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/Mysql%E7%AC%AC%E4%B8%89%E4%B8%AA%E4%BA%8B%E7%89%A9.png" alt=""></p><p>å¯ä»¥å‘ç°å¦å¤–ä¸¤ä¸ªäº‹ç‰©éƒ½åœ¨ç­‰å¾…è·å–è¯¥è¡Œçš„<code>Sé”</code>ã€‚ç„¶åæ­¤æ—¶ç¬¬ä¸€ä¸ªäº‹ç‰©è¿›è¡Œå›æ»šï¼Œæ­¤æ—¶ç¬¬ä¸‰ä¸ªäº‹ç‰©å°±ä¼šæç¤ºæ­»é”ã€‚</p><h2 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h2><h4 id="å‰æç»“è®º"><a href="#å‰æç»“è®º" class="headerlink" title="å‰æç»“è®º"></a>å‰æç»“è®º</h4><ol><li><code>Sé”</code>æ˜¯å¯ä»¥å‡çº§åˆ°<code>Xé”</code>çš„</li><li>ä¸€ä¸ª<code>Sé”</code>éœ€è¦å‡çº§åˆ°<code>X</code>é”å¿…é¡»ä¿è¯åªæœ‰å½“å‰äº‹ç‰©æŒæœ‰<code>Sé”</code></li></ol><h4 id="æ­»é”åŸå› "><a href="#æ­»é”åŸå› " class="headerlink" title="æ­»é”åŸå› "></a>æ­»é”åŸå› </h4><p>å½“ç¬¬ä¸€ä¸ªäº‹ç‰©å›æ»šä¹‹åï¼Œç¬¬äºŒä¸ªäº‹ç‰©å’Œç¬¬ä¸‰ä¸ªäº‹ç‰©éƒ½ä¼šè·å¾—åˆ°è¯¥è¡Œçš„<code>Sé”</code>ï¼Œä½†æ˜¯æ­¤æ—¶ç¬¬äºŒä¸ªäº‹ç‰©å°†è¦æ‰§è¡Œ insert è¯­å¥ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªäº‹ç‰©æ­£åœ¨ç­‰å¾…è·å–è¯¥è¡Œçš„<code>Xé”</code>ï¼Œä½†æ˜¯æ­¤æ—¶ç¬¬ä¸‰ä¸ªäº‹ç‰©ä¹Ÿæ­£åœ¨å‡†å¤‡ insertï¼Œå®ƒä¹Ÿåœ¨å‡†å¤‡è·å– <code>Xé”</code>ï¼Œç›®å‰è¿™ä¸¤ä¸ªäº‹ç‰©éƒ½æŒæœ‰è¯¥è¡Œçš„ <code>Sé”</code> ï¼Œè€Œå¦‚æœéœ€è¦è·å– <code>Xé”</code>ï¼Œåˆ™æ˜¯éœ€è¦å¯¹æ–¹é‡Šæ”¾<code>S</code>é”ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/TwoTrxLock.png" alt=""></p><h3 id="ç®€å•å¤ç°æ­¥éª¤ï¼š"><a href="#ç®€å•å¤ç°æ­¥éª¤ï¼š" class="headerlink" title="ç®€å•å¤ç°æ­¥éª¤ï¼š"></a>ç®€å•å¤ç°æ­¥éª¤ï¼š</h3><p>ä¸ºäº†éªŒè¯ä¸Šé¢çš„æƒ…å†µï¼Œæˆ‘å‡†å¤‡å¦‚ä¸‹å‡ ä¸ªSQLï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">## äº‹ç‰©ä¸€</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test_lock.test <span class="keyword">where</span> user_id=<span class="string">'h'</span>  <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## äº‹ç‰©äºŒ</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test_lock.test <span class="keyword">where</span> user_id=<span class="string">'h'</span>  <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"></span><br><span class="line">## äº‹ç‰©ä¸€å†æ‰§è¡Œ</span><br><span class="line"><span class="keyword">update</span> test_lock.<span class="string">`test`</span> <span class="keyword">set</span> user_name=<span class="string">'abc'</span>  <span class="keyword">where</span>  user_id = <span class="string">'h'</span>;</span><br><span class="line"></span><br><span class="line">## äº‹ç‰©äºŒå†æ‰§è¡Œ</span><br><span class="line"><span class="keyword">update</span> test_lock.<span class="string">`test`</span> <span class="keyword">set</span> user_name=<span class="string">'abc'</span>  <span class="keyword">where</span>  user_id = <span class="string">'h'</span>;</span><br><span class="line"></span><br><span class="line">## æ­¤æ—¶äº‹ç‰©äºŒå°±ä¼šæç¤ºæ­»é”</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºäº‹ç‰©ä¸€å’Œäº‹ç‰©äºŒéƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾<code>Sé”</code>ï¼Œä½†æ˜¯éƒ½ä¸è‚¯é‡Šæ”¾ï¼Œäºæ˜¯æ­»é”å‘ç”Ÿäº†ã€‚</p><h3 id="æƒ…å†µäºŒ"><a href="#æƒ…å†µäºŒ" class="headerlink" title="æƒ…å†µäºŒ"></a>æƒ…å†µäºŒ</h3><blockquote><p> ä¸‰ä¸ªäº‹ç‰©éƒ½æ‰§è¡ŒåŒä¸€ä¸ªInsertè¯­å¥ï¼Œç¬¬ä¸€ä¸ªäº‹ç‰©ç„¶åæäº¤</p></blockquote><p>æ­¤æ—¶ç¬¬äºŒä¸ªäº‹ç‰©å’Œç¬¬ä¸‰ä¸ªäº‹ç‰©éƒ½ä¼šæç¤ºä¸»é”®å†²çªï¼Œå¹¶æ— æ­»é”å‡ºç°ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç§æƒ…å†µä¸‹çš„æ­»é”æ˜¯ç”±äº <code>Sé”</code> å‡çº§åˆ° <code>Xé”</code>å¯¼è‡´çš„ä¸€ç§æ­»é”ï¼Œåœ¨å¹³å¸¸çš„ä¸šåŠ¡ä»£ç ä¸­åº”è¯¥å°½é‡é¿å…å¹¶å‘æ’å…¥ä¸€ä¸ªä¸»é”®ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨ä¸´è¿‘ä¸Šçº¿ä¹‹å‰ï¼Œæˆ‘ä»¬ç³»ç»Ÿåšäº†ä¸€æ¬¡å‹åŠ›æµ‹è¯•ï¼Œå‘ç°æœ‰ä¸€ä¸ªæ¥å£åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ä¼šå‡ºç°ä¸€ä¸ªæ­»é”çš„æƒ…å†µã€‚ã€‚é¦–å…ˆç”³æ˜â€¦ä¸æ˜¯æˆ‘å†™çš„ï¼Œæˆ‘åªæ˜¯å¸®å¿™æ’æŸ¥ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;éšç€å¯¹Mysqlé”çš„æ·±å…¥äº†è§£ï¼Œäºæ˜¯å°±å‡†å¤‡å†™å‡ ç¯‡æ–‡ç« æ¥è®°å½•ä¸‹Mysqlå„ç§äº‹ç‰©å’Œç´¢å¼•çš„æƒ…å†µä¸‹å‡ºç°æ­»é”çš„æƒ…å†µã€‚&lt;/p&gt;
&lt;p&gt;ä»Š
      
    
    </summary>
    
      <category term="Mysql" scheme="https://somersames.github.io/categories/Mysql/"/>
    
    
      <category term="Mysql" scheme="https://somersames.github.io/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>Vueé‡Œé¢ç›¸åŒé¡µé¢ä¸åŒURLçš„åˆ·æ–°è§£å†³æ–¹æ¡ˆ</title>
    <link href="https://somersames.github.io/2019/07/24/Vue%E9%87%8C%E9%9D%A2%E7%9B%B8%E5%90%8C%E9%A1%B5%E9%9D%A2%E4%B8%8D%E5%90%8CURL%E7%9A%84%E5%88%B7%E6%96%B0%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <id>https://somersames.github.io/2019/07/24/Vueé‡Œé¢ç›¸åŒé¡µé¢ä¸åŒURLçš„åˆ·æ–°è§£å†³æ–¹æ¡ˆ/</id>
    <published>2019-07-23T16:09:58.000Z</published>
    <updated>2019-08-02T15:37:07.145Z</updated>
    
    <content type="html"><![CDATA[<p>éšç€é¡¹ç›®çš„æ”¶å°¾ï¼Œä½¿ç”¨<code>Vue</code>ä¹Ÿæœ‰å¤§æ¦‚ä¸¤ä¸ªæœˆæ—¶é—´äº†ï¼Œåœ¨è¿™æœŸé—´ä¹Ÿæ‰é‡åˆ°è¿‡äº†ä¸å°‘çš„é—®é¢˜ï¼Œä»Šå¤©å°±æ¥è¯´ä¸‹ <code>Vue</code> ä¸­URLä¸åŒä½†æ˜¯é¡µé¢ç›¸åŒçš„è§£å†³åŠæ³•ã€‚</p><h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><p>å‡è®¾æœ‰ä¸¤ä¸ªURLï¼Œéƒ½å¯¹åº”çš„æ˜¯ä¸€ä¸ªç›¸åŒçš„ Vue é¡µé¢ï¼ŒURLåˆ†åˆ«æ˜¯ <code>view/account/1</code> å’Œ <code>edit/account/1</code>ï¼Œæ­¤æ—¶å¦‚æœç”± <code>view/account/1</code> è·³è½¬è‡³ <code>edit/account/1</code>ï¼Œä½ ä¼šå‘ç°é¡µé¢æ˜¯ä¸ä¼šåˆ·æ–°çš„ï¼Œ ä»è€Œç›´æ¥å½±å“äº†æ•´ä½“çš„åŠŸèƒ½ã€‚</p><p>äºæ˜¯å»ç½‘ä¸Šå¯»æ‰¾è§£å†³æ–¹æ¡ˆï¼Œåœ¨ä¸€ä¸ª github çš„ issue é‡Œé¢ï¼Œçœ‹åˆ°ä¹Ÿæœ‰äººåæ˜ è¿‡è¿™ä¸ªé—®é¢˜ï¼Œä¸è¿‡ä½œè€…çš„å›å¤æ˜¯é‡‡ç”¨</p><p><code>reload</code> æ–¹å¼è¿›è¡Œå¼ºåˆ¶åˆ·æ–°ï¼Œä¹Ÿå°±æ˜¯ç±»ä¼¼äº F5 é‚£æ ·ï¼Œé¡µé¢é¦–å…ˆä¼šç™½ä¸€ä¸‹ï¼Œç„¶åå°±å†å‡ºç°å…ƒç´ ã€‚è¿™æ ·è™½ç„¶å¯ä»¥å®ç°é¡µé¢ä¸Šå…ƒç´ çš„ä¸€äº›åŠ è½½ï¼Œä½†æ˜¯åŒæ—¶å®ƒçš„å¼Šç«¯ä¹Ÿä½“ç°å‡ºæ¥äº†ï¼Œå°±æ˜¯å¯¹ç”¨æˆ·æåº¦çš„ä¸å‹å¥½ï¼Œæ‰€ä»¥æœ€åæˆ‘ä»¬æ‰ç”¨äº†ä¸€ç§Reloadçš„æ–¹å¼æ¥è¿›è¡Œåˆ·æ–°çš„ã€‚</p><p>é¦–å…ˆæ˜¯åœ¨<code>App.vue</code>é‡Œé¢æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">    &lt;router-view v-<span class="keyword">if</span>=<span class="string">'isAlive'</span>/&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'App'</span>,</span><br><span class="line">  provide () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      reload: <span class="keyword">this</span>.reload</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      isAlive: <span class="literal">true</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    reload () &#123;</span><br><span class="line">      <span class="keyword">this</span>.isAlive = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">this</span>.$nextTick(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.isAlive = <span class="literal">true</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;style&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>style&gt;</span><br></pre></td></tr></table></figure><p>ç„¶åå†éœ€è¦åˆ·æ–°çš„ Vue é¡µé¢ç›´æ¥é€šè¿‡ <code>inject</code> æ¥è¿›è¡Œä½¿ç”¨å³å¯ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> &lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;el-form :model=<span class="string">"account"</span>&gt;</span><br><span class="line">        &lt;el-form-item label=<span class="string">"å§“å"</span> prop=<span class="string">"name"</span> &gt;</span><br><span class="line">          &lt;el-input v-model=<span class="string">"account.name"</span> placeholder=<span class="string">"è¯·è¾“å…¥"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">el-form-item</span>&gt;</span></span></span><br><span class="line">          &lt;el-form-item label="å¹´é¾„" prop="age" &gt;</span><br><span class="line">          &lt;el-input v-model="account.age" placeholder="è¯·è¾“å…¥"&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">          &lt;el-form-item label="æ€§åˆ«" prop="gender" &gt;</span><br><span class="line">          &lt;el-input v-model="account.gender" placeholder="è¯·è¾“å…¥"&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">      &lt;/el-form&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  inject: ['reload'],</span><br><span class="line">  data () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      account: &#123;</span><br><span class="line">        name: null,</span><br><span class="line">        age: null,</span><br><span class="line">        gender: null</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  watch: &#123;</span><br><span class="line">    '$route' (to, from) &#123;</span><br><span class="line">      this.reload();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p>æœ€åä¾¿å¯ä»¥å®ç°é¡µé¢çŠ¶æ€çš„é‡æ–°åŠ è½½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;éšç€é¡¹ç›®çš„æ”¶å°¾ï¼Œä½¿ç”¨&lt;code&gt;Vue&lt;/code&gt;ä¹Ÿæœ‰å¤§æ¦‚ä¸¤ä¸ªæœˆæ—¶é—´äº†ï¼Œåœ¨è¿™æœŸé—´ä¹Ÿæ‰é‡åˆ°è¿‡äº†ä¸å°‘çš„é—®é¢˜ï¼Œä»Šå¤©å°±æ¥è¯´ä¸‹ &lt;code&gt;Vue&lt;/code&gt; ä¸­URLä¸åŒä½†æ˜¯é¡µé¢ç›¸åŒçš„è§£å†³åŠæ³•ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ç°è±¡&quot;&gt;&lt;a href=&quot;#ç°è±¡&quot; class=&quot;head
      
    
    </summary>
    
      <category term="Vue" scheme="https://somersames.github.io/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://somersames.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆSpringå®˜æ–¹æ¨èé€šè¿‡æ„é€ å™¨æ³¨å…¥</title>
    <link href="https://somersames.github.io/2019/07/22/%E4%B8%BA%E4%BB%80%E4%B9%88Spring%E5%AE%98%E6%96%B9%E6%8E%A8%E8%8D%90%E9%80%9A%E8%BF%87%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5/"/>
    <id>https://somersames.github.io/2019/07/22/ä¸ºä»€ä¹ˆSpringå®˜æ–¹æ¨èé€šè¿‡æ„é€ å™¨æ³¨å…¥/</id>
    <published>2019-07-21T16:16:15.000Z</published>
    <updated>2019-07-21T16:21:56.585Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€"><a href="#ä¸€" class="headerlink" title="ä¸€"></a>ä¸€</h2><p>æˆ‘ä»¬åœ¨ä½¿ç”¨Springçš„æ—¶å€™ï¼Œæœ€æ–¹ä¾¿çš„å°±æ˜¯å®ƒçš„IOCï¼ˆæ§åˆ¶åè½¬ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„Beanéƒ½äº¤ç”±</p><p>Springè¿›è¡Œç®¡ç†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨çœ‹ç½‘ä¸Šçš„æ–‡ç« æˆ–è€…è‡ªå·±åœ¨å†™ä»£ç çš„æ—¶å€™ç»å¸¸ä¼šåƒè¿™æ ·å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   TestDao TestDao;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> TestDao TestDao;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">TestService</span><span class="params">(TestDao TestDao)</span></span>&#123;</span><br><span class="line">     <span class="keyword">this</span>.TestDao = TestDao;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è²Œä¼¼è®¸å¤šäººéƒ½ä¼šä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œå› ä¸ºè¿™æ ·ç®€å•æ–¹ä¾¿ï¼Œå¦‚æœæ˜¯é‡‡ç”¨ç¬¬äºŒç§çš„è¯ï¼Œæ¯ä¸€æ¬¡æ–°å¢åŠ ä¸€ä¸ªbeanï¼Œéƒ½éœ€è¦åœ¨æ„é€ å™¨çš„å…¥å‚ä¸Šé¢åŠ ä¸€ä¸ªå‚æ•°ï¼Œå°±ä¼šæ˜¾å¾—æœ‰ç‚¹éº»çƒ¦ã€‚</p><p>ä½†æ˜¯å¦‚æœé‡‡ç”¨ç¬¬ä¸€ä¸ªå†™æ³•ï¼Œå°±ä¼šåœ¨IDEAé‡Œé¢å‡ºç°ä¸€ä¸ªæç¤ºï¼š</p><blockquote><p> springå®˜æ–¹å»ºè®®é€šè¿‡æ„é€ å™¨çš„æ–¹å¼è¿›è¡Œæ³¨å…¥</p></blockquote><p>è¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p><a href="https://spring.io/blog/2007/07/11/setter-injection-versus-constructor-injection-and-the-use-of-required/" target="_blank" rel="noopener">Springå®˜æ–¹å¯¹äºSetteræ³¨å…¥å’Œæ„é€ å™¨æ³¨å…¥çš„çœ‹æ³•</a></p><h2 id="äºŒ"><a href="#äºŒ" class="headerlink" title="äºŒ"></a>äºŒ</h2><p>åœ¨springbooté‡Œé¢ï¼Œæœ€å¸¸ç”¨çš„æ³¨å…¥æ–¹å¼æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯æ„é€ å™¨æ³¨å…¥ï¼Œä¸€ç§æ˜¯fieldæ³¨å…¥</p><p>åœ¨ä¸Šä¸€éƒ¨åˆ†çš„ä»£ç é‡Œé¢ï¼Œç¬¬ä¸€ä¸ªæ˜¯ Field æ³¨å…¥ï¼Œç¬¬äºŒä¸ªæ˜¯æ„é€ å™¨æ³¨å…¥ï¼Œæ—¢ç„¶è¿™ä¸¤ç§æ–¹å¼Springéƒ½æ”¯æŒï¼Œé‚£ä¹ˆåˆ°åº•è¿™ä¸¤ç§æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><h3 id="Fieldæ³¨å…¥"><a href="#Fieldæ³¨å…¥" class="headerlink" title="Fieldæ³¨å…¥"></a>Fieldæ³¨å…¥</h3><p>è¿™è¾¹æ–°å»ºä¸¤ä¸ªæµ‹è¯•ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"A"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    A a;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">()</span></span>&#123;</span><br><span class="line">        a.sayA();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ä½ å¯åŠ¨Springçš„è¯ï¼Œå°±ä¼šå‡ºç°ä¸€ä¸ªç©ºæŒ‡é’ˆçš„å¼‚å¸¸ï¼Œå¦‚æœéœ€è¦é¿å…çš„è¯ï¼Œåˆ™å¿…é¡»æ˜¯ç±» <code>A</code> å…ˆè¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åå†åˆå§‹åŒ– <code>B</code> ã€‚ï¼ˆå½“ç„¶Springå®˜æ–¹ä¹Ÿæä¾›äº†å¾ˆå¤šæ–¹å¼æ¥æ§åˆ¶ Bean çš„åˆå§‹åŒ–é¡ºåºï¼Œä½†æ˜¯å’Œæœ¬ç¯‡æ–‡ç« æ— å…³ï¼‰</p><h3 id="æ„é€ å™¨æ³¨å…¥"><a href="#æ„é€ å™¨æ³¨å…¥" class="headerlink" title="æ„é€ å™¨æ³¨å…¥"></a>æ„é€ å™¨æ³¨å…¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> A a;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">(A a)</span></span>&#123;</span><br><span class="line">        a.sayA();</span><br><span class="line">        <span class="keyword">this</span>.a = a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶Springçš„é¡¹ç›®å°±ä¼šæ­£å¸¸çš„å¯åŠ¨ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆåŒæ ·çš„ä»£ç ï¼Œä¸€ä¸ªé€šè¿‡æ„é€ å™¨æ³¨å…¥ï¼Œä¸€ä¸ªé€šè¿‡Fieldæ³¨å…¥ï¼Œä¸¤è€…çš„ç»“æœç›¸å·®è¿™ä¹ˆå¤§å‘¢ï¼Ÿ</p><h2 id="ä¸‰"><a href="#ä¸‰" class="headerlink" title="ä¸‰"></a>ä¸‰</h2><p>å®˜æ–¹ä¹‹æ‰€ä»¥ç°åœ¨æ¨èä½¿ç”¨æ„é€ å™¨æ³¨å…¥ï¼Œæ˜¯å› ä¸ºé€šè¿‡æ„é€ å™¨æ³¨å…¥æ˜¯å¯ä»¥é˜²æ­¢ <code>ç©ºæŒ‡é’ˆå¼‚å¸¸</code>ï¼ŒåŒæ—¶å¯ä»¥ç¡®ä¿çš„æ˜¯è¢«å¼•ç”¨çš„ <code>Bean</code> ï¼Œå®ƒçš„å¼•ç”¨æ˜¯ä¸å¯ä»¥å˜çš„ï¼Œæ‰€ä»¥è¿™å¯èƒ½æ˜¯Springå®˜æ–¹å›¢é˜Ÿçš„ä¸€äº›æƒè¡¡ç‚¹å§<br>å½“ç„¶æ—©æœŸçš„æ—¶å€™ï¼ŒSpringæ›¾æ¨èè¿‡ä½¿ç”¨Setteræ³¨å…¥ï¼Œä¸å¤Ÿç°åœ¨å¯èƒ½Springå¯èƒ½è§‰å¾—æ„é€ å™¨æ³¨å…¥æ¯”è¾ƒå¥½ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ä¸€&quot;&gt;&lt;a href=&quot;#ä¸€&quot; class=&quot;headerlink&quot; title=&quot;ä¸€&quot;&gt;&lt;/a&gt;ä¸€&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬åœ¨ä½¿ç”¨Springçš„æ—¶å€™ï¼Œæœ€æ–¹ä¾¿çš„å°±æ˜¯å®ƒçš„IOCï¼ˆæ§åˆ¶åè½¬ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„Beanéƒ½äº¤ç”±&lt;/p&gt;
&lt;p&gt;Springè¿›è¡Œç®¡ç†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨çœ‹ç½‘ä¸Šçš„
      
    
    </summary>
    
      <category term="Spring" scheme="https://somersames.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="https://somersames.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>2019å¹´07æœˆç¬¬ä¸€å‘¨æ€»ç»“</title>
    <link href="https://somersames.github.io/2019/07/07/2019%E5%B9%B407%E6%9C%88%E7%AC%AC%E4%B8%80%E5%91%A8%E6%80%BB%E7%BB%93/"/>
    <id>https://somersames.github.io/2019/07/07/2019å¹´07æœˆç¬¬ä¸€å‘¨æ€»ç»“/</id>
    <published>2019-07-07T13:57:49.000Z</published>
    <updated>2019-07-07T14:15:37.690Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸€å‘¨ä¸»è¦å­¦ä¹ å¦‚ä¸‹ï¼š</p><h2 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h2><p>åœ¨ä½¿ç”¨ElementUIçš„æ—¶å€™æœ‰ä¸€ä¸ª<code>el-select</code>æ ‡ç­¾ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªéœ€æ±‚å°±æ˜¯éœ€è¦åœ¨ä¸‹æ‹‰åˆ—è¡¨çš„æ—¶å€™è¿˜éœ€è¦è¿‡æ»¤å‡ºç‰¹å®šçš„é€‰é¡¹ï¼Œä½†æ˜¯<code>ElementUI</code>å®˜æ–¹é»˜è®¤çš„è¿‡æ»¤å´åªèƒ½æ”¯æŒ label çš„ç­›é€‰ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±éœ€è¦é‡æ–°<code>filter-method</code>æ–¹æ³•æ¥è¿‡æ»¤å‡ºæ‰€éœ€è¦çš„é€‰é¡¹ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-form</span> <span class="attr">v-model</span>=<span class="string">"selectData"</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">el-select</span> <span class="attr">v-model</span>=<span class="string">"selectData.value"</span> <span class="attr">placeholder</span>=<span class="string">"è¯·é€‰æ‹©"</span> <span class="attr">filterable</span> <span class="attr">:filter-method</span>=<span class="string">"search"</span> <span class="attr">prop</span>=<span class="string">"value"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-option</span></span></span><br><span class="line"><span class="tag">      <span class="attr">v-for</span>=<span class="string">"item in options"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:key</span>=<span class="string">"item.value"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:label</span>=<span class="string">"item.label"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:value</span>=<span class="string">"item.value"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"float: left"</span>&gt;</span>&#123;&#123; item.label &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"float: right; font-size: 15px"</span>&gt;</span>&#123;&#123; item.value &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-option</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-select</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">el-form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">export default &#123;</span></span><br><span class="line"><span class="undefined">  data () &#123;</span></span><br><span class="line"><span class="undefined">    return &#123;</span></span><br><span class="line"><span class="undefined">      options: [&#123;</span></span><br><span class="line"><span class="undefined">        value: 'é€‰é¡¹1',</span></span><br><span class="line"><span class="undefined">        label: 'é»„é‡‘ç³•'</span></span><br><span class="line"><span class="undefined">      &#125;, &#123;</span></span><br><span class="line"><span class="undefined">        value: 'é€‰é¡¹2',</span></span><br><span class="line"><span class="undefined">        label: 'åŒçš®å¥¶'</span></span><br><span class="line"><span class="undefined">      &#125;, &#123;</span></span><br><span class="line"><span class="undefined">        value: 'é€‰é¡¹3',</span></span><br><span class="line"><span class="undefined">        label: 'èšµä»”ç…'</span></span><br><span class="line"><span class="undefined">      &#125;, &#123;</span></span><br><span class="line"><span class="undefined">        value: 'é€‰é¡¹4',</span></span><br><span class="line"><span class="undefined">        label: 'é¾™é¡»é¢'</span></span><br><span class="line"><span class="undefined">      &#125;, &#123;</span></span><br><span class="line"><span class="undefined">        value: 'é€‰é¡¹5',</span></span><br><span class="line"><span class="undefined">        label: 'åŒ—äº¬çƒ¤é¸­'</span></span><br><span class="line"><span class="undefined">      &#125;],</span></span><br><span class="line"><span class="undefined">      selectData: &#123;</span></span><br><span class="line"><span class="undefined">        value: ''</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined">  methods: &#123;</span></span><br><span class="line"><span class="undefined">    search (val) &#123;</span></span><br><span class="line"><span class="undefined">      let copyObj2 = JSON.parse(JSON.stringify(this.options));</span></span><br><span class="line"><span class="undefined">      if (val != null &amp;&amp; val !== '') &#123;</span></span><br><span class="line"><span class="undefined">        this.options = copyObj2.filter((item) =&gt; &#123;</span></span><br><span class="line"><span class="undefined">          if (item.value.indexOf(val) &gt; -1) &#123;</span></span><br><span class="line"><span class="undefined">            debugger;</span></span><br><span class="line"><span class="undefined">            return true;</span></span><br><span class="line"><span class="undefined">          &#125; else &#123;</span></span><br><span class="line"><span class="undefined">            return false;</span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">      &#125; else &#123;</span></span><br><span class="line"><span class="undefined">        this.options = copyObj2;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åæ¥åˆè¯´è¦æŠŠé€‰æ‹©çš„å€¼ç»™å¦ä¸€ä¸ªå­—æ®µâ€¦äºæ˜¯æˆ‘å°±åœ¨searchæ–¹æ³•ä¸‹é¢åŠ äº†ä¸€è¡Œ<code>this.otherField = val</code>ã€‚ã€‚åæ¥å‰ç«¯æŠŠé‚£ä¸€è¡Œç»™å»é™¤äº†ã€‚ã€‚ã€‚ç„¶åä¿®æ”¹ä¸ºå¦‚ä¸‹ä»£ç ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-select</span> <span class="attr">v-model</span>=<span class="string">"selectData.value"</span> <span class="attr">placeholder</span>=<span class="string">"è¯·é€‰æ‹©"</span> <span class="attr">filterable</span> <span class="attr">:filter-method</span>=<span class="string">"(val)=&gt;search(val,()=&gt;&#123;this.otherField=val&#125;)"</span> <span class="attr">prop</span>=<span class="string">"value"</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"> search (val, callback) &#123;</span><br><span class="line">      callback();</span><br><span class="line">  // ä¸€æ ·çš„ä»£ç </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>åæ¥å°±æ²¡ç®¡äº†ï¼Œä¸è¿‡ç°åœ¨è§‰å¾—è¿™æ ·å†™çš„è¯æœ‰å¥½å¤„ä¹Ÿæœ‰åå¤„ã€‚å¥½å¤„å°±æ˜¯å¯¹äºå¦‚æœåªæœ‰å¾ˆå°‘çš„å­—æ®µå˜åŠ¨çš„è¯ï¼Œè¿™æ ·æ”¹æ— ç–‘çš„å¥½çš„ï¼Œå› ä¸ºå¯ä»¥é¿å…åœ¨æ–¹æ³•é‡Œé¢å†™å¤ªå¤šçš„å­—æ®µï¼Œä½†æ˜¯ä¸€æ—¦é‡å¤çš„å¤šèµ·æ¥ï¼Œæˆ‘è§‰å¾—åœ¨æ–¹æ³•é‡Œé¢å†™èµ·æ¥æ¯”è¾ƒå¥½ã€‚</p><h2 id="ElasticSearchçš„ä¹è§‚é”æœºåˆ¶ï¼ˆåŒæ­¥çš„å‘ï¼‰"><a href="#ElasticSearchçš„ä¹è§‚é”æœºåˆ¶ï¼ˆåŒæ­¥çš„å‘ï¼‰" class="headerlink" title="ElasticSearchçš„ä¹è§‚é”æœºåˆ¶ï¼ˆåŒæ­¥çš„å‘ï¼‰"></a>ElasticSearchçš„ä¹è§‚é”æœºåˆ¶ï¼ˆåŒæ­¥çš„å‘ï¼‰</h2><p>ä¸Šå‘¨ç”±äºåœ¨åšè¡¥å¿æœºåˆ¶çš„æ—¶å€™ï¼Œéœ€è¦å¯¹Esä¸€äº›æ•°æ®è¿›è¡Œé¢‘ç¹çš„æ›´æ–°ï¼Œä½†æ˜¯åœ¨æµ‹è¯•çš„æ—¶å€™ ES ç»å¸¸ä¼šè¿”å›<code>version conflict</code> ï¼Œåæ¥æœç´¢äº†ä¸€ä¸‹ï¼Œå‘ç° ES å¯¹äºæ¯ä¸€ä¸ªæ•°æ®éƒ½æœ‰ä¸€ä¸ª<code>_version</code>å­—æ®µ</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-07-07%20%E4%B8%8B%E5%8D%888.57.25.png" alt=""></p><p>è€Œæˆ‘ä»¬å¯¹ä¸€ä¸ªæ•°æ®å¦‚æœé¢‘ç¹æ›´æ–°çš„è¯ï¼Œå°±ä¼šå¯¼è‡´ESçš„ä¹è§‚é”ç”Ÿæ•ˆï¼Œä»è€Œæ›´æ–°å¤±è´¥ã€‚å¦‚ä¸‹ï¼š</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-07-07%20%E4%B8%8B%E5%8D%889.13.03.png" alt=""></p><p>ç”±äºæˆ‘ä½¿ç”¨çš„ESç‰ˆæœ¬æ˜¯ES6.7.1ï¼Œè¿™æ—¶å€™åªèƒ½é€šè¿‡<code>if_seq_no</code>æ¥è§£å†³äº†ï¼Œå› ä¸ºå½“æˆ‘å°è¯•ä½¿ç”¨å¤–éƒ¨ç‰ˆæœ¬å·æ§åˆ¶çš„æ—¶å€™ï¼Œçªç„¶å‘ç°ã€‚ã€‚ã€‚ESå®˜æ–¹ç«Ÿç„¶ä¸æ¨èäº†</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-07-07%20%E4%B8%8B%E5%8D%889.27.26.png" alt=""></p><p>è¿™éƒ¨åˆ†åç»­å†™æ–‡ç« ç»§ç»­åˆ†æäº†ã€‚ã€‚ã€‚</p><h2 id="ESçš„å‡çº§ä»¥åŠåŸºç¡€æ’åºæ–¹æ³•"><a href="#ESçš„å‡çº§ä»¥åŠåŸºç¡€æ’åºæ–¹æ³•" class="headerlink" title="ESçš„å‡çº§ä»¥åŠåŸºç¡€æ’åºæ–¹æ³•"></a>ESçš„å‡çº§ä»¥åŠåŸºç¡€æ’åºæ–¹æ³•</h2><p>ç”±äºéœ€è¦åˆ—è¡¨çš„æ•°æ®è¿›è¡Œç»¼åˆæŸ¥è¯¢ç„¶åæ’åºï¼Œè¿™ä¸ªæ—¶å€™å°±åªèƒ½æ‰‹å†™æ’åºæ–¹æ³•äº†ï¼Œå¥½åœ¨ESçš„å®˜æ–¹æ–‡æ¡£å€’ä¹Ÿè¯¦ç»†ï¼Œæ‰€ä»¥å‚ç…§å®˜æ–¹çš„æ–‡æ¡£ï¼Œè‡ªå·±æ‘¸ç´¢äº†ä¸¤ä¸ªå°æ—¶å€’ä¹Ÿå†™å‡ºæ¥äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String script = <span class="string">"ä½ çš„æ’åºè„šæœ¬"</span>;</span><br><span class="line">Script inline = <span class="keyword">new</span> Script(script);</span><br><span class="line">SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"ä½ çš„ç´¢å¼•"</span>);</span><br><span class="line">SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">sourceBuilder.sort(<span class="keyword">new</span> ScriptSortBuilder(inline,ScriptSortBuilder.ScriptSortType.NUMBER).order(SortOrder.DESC));</span><br></pre></td></tr></table></figure><h2 id="Rabbitmq"><a href="#Rabbitmq" class="headerlink" title="Rabbitmq"></a>Rabbitmq</h2><p>ç”±äºMqç¯å¢ƒéœ€è¦ç»Ÿä¸€ä¸‹ï¼Œæ‰€ä»¥è¿™æ®µæ—¶é—´ä¹ŸæŠŠè‡ªå·±è´Ÿè´£çš„Mqåˆ<code>fanout</code>æ”¹ä¸º<code>direct</code>äº†ã€‚æ”¹åŠ¨èµ·æ¥åˆ°ä¹Ÿæ²¡å•¥éš¾åº¦ï¼Œå°±æ˜¯åœ¨<code>convertAndSend</code>æ–¹æ³•é‡Œé¢å¤šåŠ äº†ä¸€ä¸ª<code>routeKey</code>å‚æ•°è€Œå·²</p><h2 id="ç®—æ³•"><a href="#ç®—æ³•" class="headerlink" title="ç®—æ³•"></a>ç®—æ³•</h2><p>è¿™å‘¨ä¸»è¦æ˜¯åœ¨ Leetcode ä¸Šå†™äº†ç‚¹<code>Array</code>çš„ä¸€äº›ç®—æ³•é¢˜ï¼Œå› ä¸ºéƒ½æ˜¯ç®€å•çš„é¢˜ç›®ï¼Œæš‚æ—¶è¿˜æœªé‡åˆ°ä¸€äº›æ¯”è¾ƒç»å…¸çš„é¢˜ç›®</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å‘¨ä¸‰æ‰æƒ³èµ·æ¥è¯•è¯•è®°å½•ä¸‹ï¼Œä¸‹å‘¨ä¼°è®¡ä¼šè¯¦ç»†ç‚¹</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è¿™ä¸€å‘¨ä¸»è¦å­¦ä¹ å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;h2 id=&quot;Vue&quot;&gt;&lt;a href=&quot;#Vue&quot; class=&quot;headerlink&quot; title=&quot;Vue&quot;&gt;&lt;/a&gt;Vue&lt;/h2&gt;&lt;p&gt;åœ¨ä½¿ç”¨ElementUIçš„æ—¶å€™æœ‰ä¸€ä¸ª&lt;code&gt;el-select&lt;/code&gt;æ ‡ç­¾ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª
      
    
    </summary>
    
      <category term="å‘¨è®°" scheme="https://somersames.github.io/categories/%E5%91%A8%E8%AE%B0/"/>
    
    
      <category term="å‘¨è®°" scheme="https://somersames.github.io/tags/%E5%91%A8%E8%AE%B0/"/>
    
  </entry>
  
</feed>
