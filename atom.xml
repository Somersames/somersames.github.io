<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Somersames</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://somersames.github.io/"/>
  <updated>2020-05-16T16:55:15.901Z</updated>
  <id>https://somersames.github.io/</id>
  
  <author>
    <name>Somersames</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>阿里云SDK使用代理的一个坑</title>
    <link href="https://somersames.github.io/2020/05/16/%E9%98%BF%E9%87%8C%E4%BA%91SDK%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86%E7%9A%84%E4%B8%80%E4%B8%AA%E5%9D%91/"/>
    <id>https://somersames.github.io/2020/05/16/阿里云SDK使用代理的一个坑/</id>
    <published>2020-05-16T13:25:49.000Z</published>
    <updated>2020-05-16T16:55:15.901Z</updated>
    
    <content type="html"><![CDATA[<p>由于项目中需要使用阿里云的短信平台，所以直接引用了最新的SDK，版本号为 <code>4.5.1</code>。但是由于机器在内网环境，如果需要访问外部网络的话，需要代理机器。于是去看下 阿里的SDK 官方文档，如何支持代理访问，于是找到以下内容：</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/%E9%98%BF%E9%87%8CSDK%E7%9A%84%E5%9D%91/%E9%98%BF%E9%87%8CSDK%E4%BB%A3%E7%90%86.png" alt=""></p><p>坑就坑在这个文档里面的设置方法，设置了并没有什么用。于是自己研究了下这种设置为什么不生效。</p><h2 id="System-setProperty"><a href="#System-setProperty" class="headerlink" title="System.setProperty"></a>System.setProperty</h2><p>这个命令和在启动参数中加 <code>-DXXX=XXX</code> 是一样的效果，例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">"http.proxyHost"</span>, <span class="string">"127.0.0.1"</span>); </span><br><span class="line">System.setProperty(<span class="string">"http.proxyPort"</span>, <span class="string">"8888"</span>);</span><br></pre></td></tr></table></figure></p><p>就等价于 <code>-Dhttp.proxyHost=127.0.0.1 -Dhttp.proxyPort = 8888</code>，但是这种设置有一个限制，那就是只对 JDK 自带的 <code>HttpURLConnection</code> 有效，如下Demo：<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/%E9%98%BF%E9%87%8CSDK%E7%9A%84%E5%9D%91/JDK%E7%9A%84Http%E4%BB%A3%E7%90%86.png" alt=""></p><p>当我们执行这段代码的时候，你会发现确实走了代理（可以本地随便设置一个IP加端口，你会发现一直卡在那里），那么既然这是有效的，就说明了阿里云的 Http 请求一定不是通过 JDK 的 <code>HttpURLConnection</code> 发送的。</p><h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><p>在阿里 <code>doCommonResponse</code> 的调用链路中，发现有一处代码 <code>com.aliyuncs.DefaultAcsClient#doRealAction</code> 如下：<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/%E9%98%BF%E9%87%8CSDK%E7%9A%84%E5%9D%91/ali-http-proxy.png" alt=""></p><p>此时阿里的SDK会通过 <code>System.getenv(&quot;HTTPS_PROXY&quot;)</code> 和 <code>System.getenv(&quot;HTTP_PROXY&quot;)</code> 来判断系统的环境中是否有如下两个变量。有的话就设置到 <code>HttpClientConfig</code> 中，没有的话则直接  return，既然我们系统环境里面没有这两个字段，那么肯定不会设置代理，于是继续往下跟代码。</p><p>最终发送 Http 请求的代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IHttpClient httpClient;</span><br><span class="line">...省略相关代码</span><br><span class="line"><span class="comment">// com.aliyuncs.DefaultAcsClient#doRealAction 第330行</span></span><br><span class="line">response = <span class="keyword">this</span>.httpClient.syncInvoke(httpRequest);</span><br></pre></td></tr></table></figure></p><p><code>httpClient</code> 最终对应的是 <code>IHttpClient</code>，它是阿里 SDK 里面的一个类。</p><h3 id="IHttpClient"><a href="#IHttpClient" class="headerlink" title="IHttpClient"></a>IHttpClient</h3><p>首先看下它的结构。<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/%E9%98%BF%E9%87%8CSDK%E7%9A%84%E5%9D%91/ali-class-struct.png" alt=""></p><p>在这边有两个实现类，<code>ApacheHttpClient</code> 是 apache 下面的一个包，而 <code>CompatibleUrlConnClient</code> 则是 JDK 自带的 http 请求类，那么阿里的SDK到底是初始化那一个SDK呢？</p><p>首先查看官方的发送短信Demo：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">... 省略相关代码</span><br><span class="line">IClientProfile profile = DefaultProfile.getProfile(<span class="string">"cn-hangzhou"</span>, accessKeyId,</span><br><span class="line">accessKeySecret);</span><br><span class="line">IAcsClient acsClient = <span class="keyword">new</span> DefaultAcsClient(profile);</span><br></pre></td></tr></table></figure></p><p><code>new DefaultAcsClient(profile)</code> 这行代码最终会调用<br><code>com.aliyuncs.DefaultAcsClient#DefaultAcsClient(com.aliyuncs.profile.IClientProfile, com.aliyuncs.auth.AlibabaCloudCredentialsProvider)</code> 这个构造器。</p><p>而且在这一行代码里面会进行 <code>HttpClientConfig</code> 的初始化，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultAcsClient</span><span class="params">(IClientProfile profile, AlibabaCloudCredentialsProvider credentialsProvider)</span> </span>&#123;</span><br><span class="line">... 省略相关代码</span><br><span class="line">    <span class="keyword">this</span>.httpClient = HttpClientFactory.buildClient(<span class="keyword">this</span>.clientProfile);</span><br><span class="line">... 省略相关代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/%E9%98%BF%E9%87%8CSDK%E7%9A%84%E5%9D%91/default-config.png" alt=""></p><p> 而在 <code>HttpClientConfig.getDefault()</code> 里面，最终会默认初始化一个 Apache 的 Httpclient。<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpClientConfig <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HttpClientConfig config = <span class="keyword">new</span> HttpClientConfig();</span><br><span class="line">    config.setClientType(HttpClientType.ApacheHttpClient);</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>至此为什么官方文档上写的 <code>System.setProperty</code> 不生效的原因终于找到了。也就是说，如果你是按照官方文档来写的代码，那么你通过 <code>System.setProperty</code> 来设置代理是肯定不是生效的。</p><h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><ol><li>将<code>HTTPS_PROXY</code> 或者 <code>HTTP_PROXY</code> 设置为系统环境变量（可以生效，但是不推荐）</li><li>在 <code>buildClient</code> 方法里面，可以发现只有当 <code>HttpClientConfig</code> 为空的情况下才会创建默认的 config，那么我们可以在 <code>IClientProfile</code> 里面，手动的将 <code>HttpClientConfig</code> 设置进去，从而避免创建默认的<code>HttpClientConfig</code>。<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/%E9%98%BF%E9%87%8CSDK%E7%9A%84%E5%9D%91/solve-plan.png" alt=""></li><li>用 JDK 的 <code>HttpURLConnection</code> 发请求，通过 <code>System.setProperty</code> 设置代理。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;由于项目中需要使用阿里云的短信平台，所以直接引用了最新的SDK，版本号为 &lt;code&gt;4.5.1&lt;/code&gt;。但是由于机器在内网环境，如果需要访问外部网络的话，需要代理机器。于是去看下 阿里的SDK 官方文档，如何支持代理访问，于是找到以下内容：&lt;/p&gt;
&lt;p&gt;&lt;img 
      
    
    </summary>
    
      <category term="阿里云" scheme="https://somersames.github.io/categories/%E9%98%BF%E9%87%8C%E4%BA%91/"/>
    
    
      <category term="Java" scheme="https://somersames.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>记一次parallelStream错误使用导致的NullPointerException</title>
    <link href="https://somersames.github.io/2020/05/11/%E8%AE%B0%E4%B8%80%E6%AC%A1parallelStream%E9%94%99%E8%AF%AF%E4%BD%BF%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84NullPointerException/"/>
    <id>https://somersames.github.io/2020/05/11/记一次parallelStream错误使用导致的NullPointerException/</id>
    <published>2020-05-10T16:21:13.000Z</published>
    <updated>2020-05-10T16:29:17.205Z</updated>
    
    <content type="html"><![CDATA[<h2 id="parallelStream"><a href="#parallelStream" class="headerlink" title="parallelStream"></a>parallelStream</h2><p>在 Java8 中，新增了一个很有用的功能就是 <code>流</code>，这个功能可以使我们可以快速的写出优雅的代码，其中 <code>stream</code> 是一个串行流（说法可能有误…就是不会采取多线程来进行处理）。还有一种就是 <code>parallelStream</code> 采用 <code>ForkJoinPool</code> 来实现并发，加快执行效率。</p><p>所以在使用 <code>parallelStream</code> 的时候一定要注意线程安全的问题，首先看一段代码：<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/%E8%AE%B0%E4%B8%80%E6%AC%A1parallelStream%E9%94%99%E8%AF%AF%E4%BD%BF%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84NullPointerException/%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B.png" alt=""></p><p>在这段代码中，是首先判断 <code>dataListList</code> 里面对象的 <code>name</code> 属性是否是偶数，是的话则添加至偶数List，反之则添加至奇数List。</p><p>然后开始测试这段代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">      DataListTest.test();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行一段时间你就会发现，会出现 <code>NullPointerException</code>，这是因为在之前的 <code>forEach</code> 里面 ArrayList 是一个非线程安全的集合，而 <code>parallelStream</code> 是一个多线程的流，所以就会导致 <code>ArrayList</code> 在并发插入的时候，会出现部分元素是null的情况。具体原因如下：</p><h2 id="ArrayList并发不安全"><a href="#ArrayList并发不安全" class="headerlink" title="ArrayList并发不安全"></a>ArrayList并发不安全</h2><p>ArrayList并发不安全的点在于 <code>add</code> 方法里面没有使用锁来保证线程安全，下面是 add 的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>假设不慎将 <code>ArrayList</code> 用于并发的环境，那么当第一个线程读取到 size 是 0，第二个线程也读取到该 size 也是0，然后都执行完了 <code>ensureCapacityInternal</code> 方法，此时线程一执行完 <code>size++</code> 后被挂起，然后线程二也执行了 <code>size++</code>，那么此时无论哪一个线程先执行数组的赋值操作，它的值一定会被另一个线程所覆盖。</p><blockquote><p>回到上面并发流空指针那一个例子</p></blockquote><p>出现异常情况的 <code>List</code> 如下：<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/%E8%AE%B0%E4%B8%80%E6%AC%A1parallelStream%E9%94%99%E8%AF%AF%E4%BD%BF%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84NullPointerException/List%E4%B8%BAnull.png" alt=""></p><p>然后在 <code>Collectors.toMap()</code> 方法里面最终会调用到 HashMap 的 merge 方法，而 HashMap 的 merge 方法第一行就是判断 <code>value</code> 是否为空，所以就导致了 <code>NullPointerException</code></p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/%E8%AE%B0%E4%B8%80%E6%AC%A1parallelStream%E9%94%99%E8%AF%AF%E4%BD%BF%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84NullPointerException/merge%E4%B8%BA%E7%A9%BA.png" alt=""></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在使用 <code>parallelStream</code> 一定需要注意并发的安全，同时注意在重构代码的时候如果是这种并发流的话，一定要注意线程安全。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;parallelStream&quot;&gt;&lt;a href=&quot;#parallelStream&quot; class=&quot;headerlink&quot; title=&quot;parallelStream&quot;&gt;&lt;/a&gt;parallelStream&lt;/h2&gt;&lt;p&gt;在 Java8 中，新增了一个很有用的功能就
      
    
    </summary>
    
      <category term="Java" scheme="https://somersames.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://somersames.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>WeakHashMap的实现原理</title>
    <link href="https://somersames.github.io/2020/04/22/WeakHashMap%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"/>
    <id>https://somersames.github.io/2020/04/22/WeakHashMap的实现原理/</id>
    <published>2020-04-21T16:29:25.000Z</published>
    <updated>2020-05-10T14:41:38.082Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h2 id="什么是WeakHashMap"><a href="#什么是WeakHashMap" class="headerlink" title="什么是WeakHashMap"></a>什么是WeakHashMap</h2><p>WeakHashMap实现了 Map 接口，属于 Java 集合中的一员，其用法几乎和 HashMap 一致，但是由于它的 Entry 还继承了 WeakHashMap ，因此导致它的这个 Entry 在触发 FullGc 的时候是有可能可以被回收的。</p><blockquote><p><strong>以下测试，JVM参数统一为：-Xmx64M -Xms64M -XX:+PrintGCDetails</strong></p></blockquote><p>首先上一段代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;<span class="keyword">byte</span>[][],<span class="keyword">byte</span>[][]&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    <span class="keyword">byte</span>[][] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>][<span class="number">1024</span>];</span><br><span class="line">    map.put(b,<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>][<span class="number">1024</span>]);</span><br><span class="line">    System.gc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>很快就会看到程序抛出了 <code>OOM异常</code></p><p>修改程序为 <code>WeakHashMap</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WeakHashMap&lt;<span class="keyword">byte</span>[][],<span class="keyword">byte</span>[][]&gt; map = <span class="keyword">new</span> WeakHashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    <span class="keyword">byte</span>[][] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>][<span class="number">1024</span>];</span><br><span class="line">    map.put(b,<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>][<span class="number">1024</span>]);</span><br><span class="line">    System.gc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>你会看到程序运行了很久都没有停下，那么证明了 <code>WeakHashMap</code> 确实会对一些没有其他引用的 key 进行删除了，那么此时如果将程序的代码再次修改下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;WeakHashMap&lt;<span class="keyword">byte</span>[][],<span class="keyword">byte</span>[][]&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    WeakHashMap&lt;<span class="keyword">byte</span>[][],<span class="keyword">byte</span>[][]&gt; map = <span class="keyword">new</span> WeakHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">byte</span>[][] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>][<span class="number">1024</span>];</span><br><span class="line">    map.put(b,<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>][<span class="number">1024</span>]);</span><br><span class="line">    list.add(map);</span><br><span class="line">    System.gc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>此时也会很快的出现了 <code>OOM</code>异常。此时你心里可能会想的是 List 含有了对 WeakReference 的强引用，导致 GC 无法回收对象，但是这里需要注意的是，虽然 List 含有对 WeakHashMap 的强引用，但是 WeakHashMap 的Entry 是继承了 WeakReference 的。因此当 调用 <code>System.gc()</code> 的时候，WeakHashMap 的 Entry 由于没有地方引用，应该是要被回收的。</p><p>为了证实 <code>WeakHashMap</code> 的 key 确实是被 GC 回收了，下面再来看一个例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;WeakHashMap&lt;<span class="keyword">byte</span>[][],Object&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    WeakHashMap&lt;<span class="keyword">byte</span>[][],Object&gt; map = <span class="keyword">new</span> WeakHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">byte</span>[][] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>][<span class="number">1024</span>];</span><br><span class="line">    map.put(b,<span class="keyword">new</span> Object());</span><br><span class="line">    list.add(map);</span><br><span class="line">    System.gc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>此时将 WeakHashMap 的value 修改为一个小对象，你会发现再次运行的话，运行很长时间都不会出现 OOM 异常了。</p><p>那么在看了上面这么多的例子之后，说明 <code>WeakHashMap</code> 的 Entry 肯定是可以被回收的，但是具体如何被回收还是得看下源代码。</p><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><h3 id="eg1"><a href="#eg1" class="headerlink" title="eg1"></a>eg1</h3><p>首先 HashMap 因为持有其对象的强引用，所以导致 GC 无法将其回收，从而导致了 OOM 异常。</p><h3 id="eg2"><a href="#eg2" class="headerlink" title="eg2"></a>eg2</h3><p>WeakHashMap 在运行了很长时间以后，一直未出现 OOM 异常，那么说明了其内部肯定有一些的操作来回收不可达对象。那么下面就来分析为什么会被回收。</p><h4 id="Entry"><a href="#Entry" class="headerlink" title="Entry"></a>Entry</h4><p><code>WeakHashMap</code> 和 <code>HashMap</code> 的大致结构是一样的，但是有一个区别是，<code>WeakHashMap</code>在实现了<code>Map.Entry&lt;K,V&gt;</code> 的时候还继承了 <code>WeakReference&lt;Object&gt;</code> 。如下图所示：<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/WeakHashMap/WeakHashMap-Entry.png" alt=""></p><p>可以看到，此时 <code>Entry&lt;K,V&gt;</code> 的 key 是继承了 <code>WeakReference</code> 的，所以在 System.gc 的时候，key是一定可以被GC的，那么还有一个就是 value 是如何被 GC 的，此时查看 put 方法：<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/WeakHashMap/WeakHashMap-put.png" alt=""></p><p>在这里需要注意的是 </p><blockquote><p>Entry&lt;K,V&gt;[] tab = getTable();</p></blockquote><p>这一行代码是会通过 <code>ReferenceQueue</code> 来判断哪些 key 是可以被回收的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expungeStaleEntries</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Object x; (x = queue.poll()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (queue) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;) x;</span><br><span class="line">            <span class="keyword">int</span> i = indexFor(e.hash, table.length);</span><br><span class="line"></span><br><span class="line">            Entry&lt;K,V&gt; prev = table[i];</span><br><span class="line">            Entry&lt;K,V&gt; p = prev;</span><br><span class="line">            <span class="keyword">while</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Entry&lt;K,V&gt; next = p.next;</span><br><span class="line">                <span class="keyword">if</span> (p == e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (prev == e)</span><br><span class="line">                        table[i] = next;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        prev.next = next;</span><br><span class="line">                    <span class="comment">// Must not null out e.next;</span></span><br><span class="line">                    <span class="comment">// stale entries may be in use by a HashIterator</span></span><br><span class="line">                    e.value = <span class="keyword">null</span>; <span class="comment">// Help GC</span></span><br><span class="line">                    size--;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                prev = p;</span><br><span class="line">                p = next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>通过 <code>queue.poll()</code> 方法来获取被 GC 回收后的key，然后通过对key进行 hash ，取出下标，移动指针，将value 置为 null ，然后结束。至此，为什么 eg2 不会出现 OOM 的结果就出现了，那是因为 <code>WeakHashMap</code> 在进行 put 的之后，还手动调用了一次 System.gc，然后在 put 的时候调用了 <code>expungeStaleEntries</code> 方法，所以 GC 就可以把那些对象回收了。</p><h2 id="eg3和eg4"><a href="#eg3和eg4" class="headerlink" title="eg3和eg4"></a>eg3和eg4</h2><p>对于这两个例子，主要是因为在 for 循环里面是每一次直接 new 了一个 <code>WeakHashMap</code>，而且都是首次调用 put 方法，之后就没有进行任何处理。因此首次 put 进去的数据，无法触发 <code>expungeStaleEntries</code>，因此导致只有 key 可以被回收，而 value 则是无法被回收的（expungeStaleEntries 方法里面手动将 value 置为了 null，导致可以被 GC）。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;h2 id=&quot;什么是WeakHashMap&quot;&gt;&lt;a href=&quot;#什么是WeakHashMap&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
      <category term="Java" scheme="https://somersames.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://somersames.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>代理模式之JDK为什么需要实现接口(下篇)</title>
    <link href="https://somersames.github.io/2020/04/21/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E4%B9%8BJDK%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3-%E4%B8%8B%E7%AF%87/"/>
    <id>https://somersames.github.io/2020/04/21/代理模式之JDK为什么需要实现接口-下篇/</id>
    <published>2020-04-20T17:00:44.000Z</published>
    <updated>2020-04-21T16:23:41.847Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在上篇主要介绍了 JDK 动态代理执行的一些流程，通过 Proxy 类来实现生成新的代理类，在这一篇主要讲的是 Proxy 是如何来生成以及缓存生成的代理类</p><h2 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h2><p>在上一篇的结尾提到过了一个map，其结构如下：</p><blockquote><p>ConcurrentMap&lt;Object, ConcurrentMap&lt;Object, Supplier<v>&gt;&gt;</v></p></blockquote><p>在这里可以看到是两个 <code>ConcurrentMap</code> 来实现的嵌套，那么 Java 为什么要这样设计呢？首先查看 <code>CacheKey</code> 的代码。如下：<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/CacheKey%E7%9A%84%E7%94%9F%E6%88%90.png" alt=""></p><p>可以看到 <code>CacheKey</code> 是继承自 WeakReference，以便于当该 <code>CacheKey</code> 没人使用的时候可以让 GC 直接回收。<code>ReferenceQueue</code> 是 WeakReference 所使用的。</p><p>那么对于 Java 来讲，其是用一个 classLoader 为 key 的 cacheKey 来生成一个 key，这个key就是二级缓存的第一个key。回到上述的map。<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/map%E7%9A%84%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98.png" alt=""></p><p>可以看到在首次初始化的时候，map 还是会以刚刚的 <code>cacheKey</code> 来获取二级缓存，但是首次一定是空的，所以此时直接 new 了一个 <code>ConcurrentMap</code> 作为 <code>value</code> 来放入二级缓存。<br>再往下看代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter));</span><br></pre></td></tr></table></figure></p><p>这是一个 Java8 的 lambda 表达式，查看这个表达式实现的地方：<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/keyFactory.png" alt=""></p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/KeyX%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0.png" alt=""></p><p>上面的 <code>KeyX</code> 的作用是用被代理的人所实现的接口进行hash，同时将它们实现的接口放入 <code>refs</code>，这个<code>refs</code>是一个数组，</p><blockquote><p>这个 refs 和 WeakReference 有关，主要是用于当 WeakReference 的对象被回收的时候作为一个监听</p></blockquote><p>此时这个 subKey 已经生成了，那么接下来就是</p><blockquote><p> Supplier<v> supplier = valuesMap.get(subKey);</v></p></blockquote><p>这个也是 Java8 的 lambda 函数，具体作用是通过调用其 get 方法，可以快读的执行函数，但是这里，这个 <code>supplier</code> 是由 <code>Factory</code> 所实现的。<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/supplier.png" alt=""></p><p>这一段代码的具体逻辑是，当 <code>supplier</code> 不为空的时候就直接通过 <code>get</code> 方法获取其 value，然后返回，但是如果为 <code>null</code> 的话，那么首先就要初始化一个 <code>Factory</code>，然后在这期间，如果有现成将 <code>supplier</code> 赋值了，那么此时就会进行空判断，如果替换 <code>valueMap</code> 成功，则直接返回刚刚生成的 <code>factory</code>，否则返回 <code>valueMap</code> 里面的值。</p><p>在这里需要注意的是这个 value 就是一个代理类的的类名称。</p><h2 id="代理类生成"><a href="#代理类生成" class="headerlink" title="代理类生成"></a>代理类生成</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="comment">// serialize access</span></span><br><span class="line">    <span class="comment">// re-check</span></span><br><span class="line">    Supplier&lt;V&gt; supplier = valuesMap.get(subKey);</span><br><span class="line">    <span class="keyword">if</span> (supplier != <span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// something changed while we were waiting:</span></span><br><span class="line">        <span class="comment">// might be that we were replaced by a CacheValue</span></span><br><span class="line">        <span class="comment">// or were removed because of failure -&gt;</span></span><br><span class="line">        <span class="comment">// return null to signal WeakCache.get() to retry</span></span><br><span class="line">        <span class="comment">// the loop</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// else still us (supplier == this)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// create new value</span></span><br><span class="line">    V value = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        value = Objects.requireNonNull(valueFactory.apply(key, parameter));</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123; <span class="comment">// remove us on failure</span></span><br><span class="line">            valuesMap.remove(subKey, <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// the only path to reach here is with non-null value</span></span><br><span class="line">    <span class="keyword">assert</span> value != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wrap value with CacheValue (WeakReference)</span></span><br><span class="line">    CacheValue&lt;V&gt; cacheValue = <span class="keyword">new</span> CacheValue&lt;&gt;(value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// put into reverseMap</span></span><br><span class="line">    reverseMap.put(cacheValue, Boolean.TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// try replacing us with CacheValue (this should always succeed)</span></span><br><span class="line">    <span class="keyword">if</span> (!valuesMap.replace(subKey, <span class="keyword">this</span>, cacheValue)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Should not reach here"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// successfully replaced us with new CacheValue -&gt; return the value</span></span><br><span class="line">    <span class="comment">// wrapped by it</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里还有一个重要的方法就是 <code>Factory.get()</code>，该方法由 <code>synchronized</code> 修饰，是用于生成代理类的 class 文件的。而生成代理类的方法在 <code>ProxyClassFactory</code> 的 apply 里面。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123;</span><br><span class="line">    Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = <span class="keyword">new</span> IdentityHashMap&lt;&gt;(interfaces.length);</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">       <span class="comment">// ...... 省略</span></span><br><span class="line">        <span class="keyword">if</span> (!interfaceClass.isInterface()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                interfaceClass.getName() + <span class="string">" is not an interface"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...... 省略</span></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">        <span class="keyword">int</span> flags = intf.getModifiers();</span><br><span class="line">        <span class="keyword">if</span> (!Modifier.isPublic(flags)) &#123;</span><br><span class="line">            accessFlags = Modifier.FINAL;</span><br><span class="line">            String name = intf.getName();</span><br><span class="line">            <span class="keyword">int</span> n = name.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">            String pkg = ((n == -<span class="number">1</span>) ? <span class="string">""</span> : name.substring(<span class="number">0</span>, n + <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                proxyPkg = pkg;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pkg.equals(proxyPkg)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"non-public interfaces from different packages"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...... 省略</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Choose a name for the proxy class to generate.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">long</span> num = nextUniqueNumber.getAndIncrement();</span><br><span class="line">    String proxyName = proxyPkg + proxyClassNamePrefix + num;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Generate the specified proxy class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(</span><br><span class="line">        proxyName, interfaces, accessFlags);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> defineClass0(loader, proxyName,</span><br><span class="line">                            proxyClassFile, <span class="number">0</span>, proxyClassFile.length);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * A ClassFormatError here means that (barring bugs in the</span></span><br><span class="line"><span class="comment">         * proxy class generation code) there was some other</span></span><br><span class="line"><span class="comment">         * invalid aspect of the arguments supplied to the proxy</span></span><br><span class="line"><span class="comment">         * class creation (such as virtual machine limitations</span></span><br><span class="line"><span class="comment">         * exceeded).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在这里有几个重要的方法说下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否是接口，这也是为什么 JDK动态代理必须实现一个接口了，因为不是接口的话这个地方验证过不去</span></span><br><span class="line"><span class="keyword">if</span> (!interfaceClass.isInterface()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">        interfaceClass.getName() + <span class="string">" is not an interface"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>至于生成的类，可以通过生成文件来查看了。当生成完 class 文件之后，回到 <code>Proxy.newProxyInstance</code> 方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</span><br><span class="line"><span class="keyword">final</span> InvocationHandler ih = h;</span><br><span class="line"><span class="keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;</span><br><span class="line">    AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            cons.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> Object[]&#123;h&#125;);</span><br></pre></td></tr></table></figure><p>在这里是将参数上的 <code>InvocationHandler</code> 通过构造器将代理类中的 <code>InvocationHandler</code> 赋值，从而使用<br><code>invoke</code> 方法来实现代理。</p><h2 id="生成的代理类"><a href="#生成的代理类" class="headerlink" title="生成的代理类"></a>生成的代理类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> design_model.proxy.jdk.Car;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="keyword">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, Class.forName(<span class="string">"java.lang.Object"</span>));</span><br><span class="line">            m3 = Class.forName(<span class="string">"design_model.proxy.jdk.Car"</span>).getMethod(<span class="string">"run"</span>);</span><br><span class="line">            m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>);</span><br><span class="line">            m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;在上篇主要介绍了 JDK 动态代理执行的一些流程，通过 Proxy 类来实现生成新的代理类，在这一篇主要讲的是 Proxy 是如何来生成以及
      
    
    </summary>
    
      <category term="Java" scheme="https://somersames.github.io/categories/Java/"/>
    
    
      <category term="动态代理" scheme="https://somersames.github.io/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>代理模式之JDK为什么需要实现接口(上篇)</title>
    <link href="https://somersames.github.io/2020/04/15/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%E4%B9%8BJDK%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3-%E4%B8%8A%E7%AF%87/"/>
    <id>https://somersames.github.io/2020/04/15/代理模式之JDK为什么需要实现接口-上篇/</id>
    <published>2020-04-15T14:58:59.000Z</published>
    <updated>2020-04-20T17:01:45.861Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>首先代理模式分为静态代理和动态代理，由于JDK采用的是动态代理，所以静态代理在这里不再介绍。</p><h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><h3 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h3><p>首先<code>JDK</code>的动态代理要求真实的对象必须实现一个接口，而代理类则实现<code>InvocationHandler</code>接口来完成动态代理。如下代码：</p><blockquote><p>接口</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">jdkProxy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>被代理的类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bus</span> <span class="keyword">implements</span> <span class="title">Car</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jdkProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"测试"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>代理类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before---------"</span>);</span><br><span class="line">        Object object = method.invoke(target,args);</span><br><span class="line">        System.out.println(<span class="string">"after---------"</span>);</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getInstance</span><span class="params">(Object target)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">        Class&lt;?&gt; clazz = target.getClass();</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(<span class="keyword">new</span> SelfClassLoader(),clazz.getInterfaces(),<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在代理模式中真实对象继承一个接口如果说是为了在代理类中统一管理，那么在 <code>JDK动态代理</code> 中如果被代理的对象还必须实现一个接口就有点繁琐了，但是对于 Java 语言来说其实也没办法。我们都认为很繁琐的一个实现，JDK 开发人员应该也会想到这一点。</p><p>下面就来解释下为什么动态代理必须实现一个接口。</p><h4 id="为什么必须实现一个接口"><a href="#为什么必须实现一个接口" class="headerlink" title="为什么必须实现一个接口"></a>为什么必须实现一个接口</h4><p>在回答这个问题之前，首先要说明的是 <code>JDK动态代理</code> 实现的原理是重新为对象类生成了一个子类，这个类由于是 JDK 自己生成的，于是会以<code>$</code>开头，在 JDK 文档中有如下说明：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A proxy class has the following properties:</span><br><span class="line"></span><br><span class="line">Proxy classes are <span class="keyword">public</span>, <span class="keyword">final</span>, and not <span class="keyword">abstract</span>.</span><br><span class="line">The unqualified name of a proxy class is unspecified. The space of class names that begin with the string "$Proxy" should be, however, reserved for proxy classes.</span><br><span class="line">A proxy <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">reflect</span>.<span class="title">Proxy</span>.</span></span><br></pre></td></tr></table></figure></p><p>其实还有很多说明，但是涉及到本文的也就上面三条。</p><ol><li>proxy类是非抽象类，且由<code>public final</code>修饰。</li><li>proxy类是以<code>$Proxy</code>开头的加类的名称。</li><li>proxy类是<code>java.lang.reflect.Proxy</code>的子类。</li></ol><p>那么既然是<code>$Proxy</code>开头的，那么是否可以将生成的子类打印出来呢？，如下代码：</p><p>可以看到这个新生成的类其实是直接继承了 <code>Proxy</code> 类，由于Java的单继承方式，此时如果要获取对象类里面的方法那么就必须实现一个接口，所以也就对象类必须要实现一个接口。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Car car = (Car) <span class="keyword">new</span> ProxyTest().getInstance(<span class="keyword">new</span> Bus());</span><br></pre></td></tr></table></figure></p><p>那么当我们执行这个代码的时候究竟在执行什么呢？在这里 debug 来跟踪源码解释 JDK 到底是如何生产 Proxy 代理类的.</p><blockquote><p>newProxyInstance方法<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/newProxyInstance.png" alt=""></p></blockquote><p>在这个方法里面，目前暂时需要注意红框中的方法，代理类是在该方法里面是生成的。</p><p><code>Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</code> 这一行代码，在这里返回的是一个 class，然后通过反射来初始化这个 class，最后这个 class 就是 JDK 生成的代理类。</p><blockquote><p>getProxyClass0</p></blockquote><p>而在 <code>getProxyClass0</code> 方法里面就是通过 <code>proxyClassCache.get(loader, interfaces)</code>来获取 Proxy，如果里面包含该 classLoader 加载的 interface 的话，则直接返回，否则就是再初始化一次，然后返回。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,</span><br><span class="line">                                           Class&lt;?&gt;... interfaces) &#123;</span><br><span class="line">    <span class="keyword">if</span> (interfaces.length &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the proxy class defined by the given loader implementing</span></span><br><span class="line">    <span class="comment">// the given interfaces exists, this will simply return the cached copy;</span></span><br><span class="line">    <span class="comment">// otherwise, it will create the proxy class via the ProxyClassFactory</span></span><br><span class="line">    <span class="keyword">return</span> proxyClassCache.get(loader, interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>proxyClassCache.get(loader, interfaces)</p></blockquote><p>从这个方法之后就是真正开始生成 Proxy 类的过程，由于这里面包含一些 Java8 的 lambda表达式 用法，对于不太了解的人可能会有点看不懂。<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%96%87%E7%AB%A0/proxy.png" alt=""></p><p>上面的图给出了初始化 map 的一个方法，在这里需要注意的是，这个map的结构如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Object, ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt;&gt; map</span><br><span class="line">        = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br></pre></td></tr></table></figure></p><p>也就是一个两层的 ConcurrentMap，而之所以为为什么这样设计是跟实现的接口相关的，是由于第一层的 key 是由 classLoader 所生成的 key，而第二层测试keyX，与所实现的接口有关。<br>剩下的将会在下一篇文章。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;首先代理模式分为静态代理和动态代理，由于JDK采用的是动态代理，所以静态代理在这里不再介绍。&lt;/p&gt;
&lt;h2 id=&quot;动态代理&quot;&gt;&lt;a hr
      
    
    </summary>
    
      <category term="Java" scheme="https://somersames.github.io/categories/Java/"/>
    
    
      <category term="动态代理" scheme="https://somersames.github.io/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>重温Java中String</title>
    <link href="https://somersames.github.io/2020/04/06/%E9%87%8D%E6%B8%A9Java%E4%B8%ADString/"/>
    <id>https://somersames.github.io/2020/04/06/重温Java中String/</id>
    <published>2020-04-06T13:41:39.000Z</published>
    <updated>2020-04-08T15:55:23.399Z</updated>
    
    <content type="html"><![CDATA[<p>本文的内容都是基于 JDK1.8 来写的，主要是复习下 String 类的设计。</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>String 是一个用于存储字符串的类，其内部是通过 char 数组来实现，在 Java 中，1byte = 8bit，1char = 2byte, 所以在 Java 中，String 的code point是16位。<br>String 类是由 final 关键字来修饰的，因此表明该类不可以被继承，同时 String 又实现了 Serializable、Comparable、CharSequence接口，表明 String 可以被序列化，以及使用cpmpareTo来比较两个字符串的值。</p><h2 id="字符集编码"><a href="#字符集编码" class="headerlink" title="字符集编码"></a>字符集编码</h2><h3 id="内码"><a href="#内码" class="headerlink" title="内码"></a>内码</h3><p>内码指的是程序内部自己使用的字符集，java中是以 <code>UTF-16</code> 来表示的</p><blockquote><p>The Java programming language represents text in sequences of 16-bit code units, using the UTF-16 encoding.</p></blockquote><p>UTF-16最多可以表示 65535 种字符，那么不在 65535 之内的字符，该如何表示呢，这时候就需要用两个字节来表示这个字符。以😁这个emoje为例子：其Code的编码是<code>1F601</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">具体方法是：</span><br><span class="line"></span><br><span class="line">Code Point减去<span class="number">0x10000</span>， 得到的值是长度为<span class="number">20</span>bit（不足的补<span class="number">0</span>）；</span><br><span class="line">将得到数值的高位的<span class="number">10</span>比特的值 加上<span class="number">0xD800</span>的前<span class="number">6</span>位得到第一个Code Unit。</span><br><span class="line">步骤<span class="number">1</span>得到数值的低位的<span class="number">10</span>比特的值 加上<span class="number">0xDC00</span>的前<span class="number">6</span>位得到第二个Code Unit。</span><br></pre></td></tr></table></figure></p><p>于是计算方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">1F</span>601 - <span class="number">0x10000</span> = <span class="number">1111011000000001</span></span><br><span class="line">不满<span class="number">20</span>位的补<span class="number">0</span>；</span><br><span class="line">所以得到：<span class="number">00001111011000000001</span>。</span><br><span class="line"><span class="number">0xD800</span>：<span class="number">1101100000000000</span></span><br><span class="line"><span class="number">0xDC00</span>：<span class="number">1101110000000000</span></span><br><span class="line">于是高位的代理就是：<span class="number">1101100000111101</span></span><br><span class="line">于是低位的代理就是：<span class="number">1101111000000001</span></span><br><span class="line">最终得到：d83d,de01</span><br></pre></td></tr></table></figure></p><p>在 String 的代码中体现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">codePointAt</span><span class="params">(CharSequence seq, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c1 = seq.charAt(index);</span><br><span class="line">    <span class="keyword">if</span> (isHighSurrogate(c1) &amp;&amp; ++index &lt; seq.length()) &#123;</span><br><span class="line">        <span class="keyword">char</span> c2 = seq.charAt(index);</span><br><span class="line">        <span class="keyword">if</span> (isLowSurrogate(c2)) &#123;</span><br><span class="line">            <span class="keyword">return</span> toCodePoint(c1, c2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">toCodePoint</span><span class="params">(<span class="keyword">char</span> high, <span class="keyword">char</span> low)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Optimized form of:</span></span><br><span class="line">    <span class="comment">// return ((high - MIN_HIGH_SURROGATE) &lt;&lt; 10)</span></span><br><span class="line">    <span class="comment">//         + (low - MIN_LOW_SURROGATE)</span></span><br><span class="line">    <span class="comment">//         + MIN_SUPPLEMENTARY_CODE_POINT;</span></span><br><span class="line">    <span class="keyword">return</span> ((high &lt;&lt; <span class="number">10</span>) + low) + (MIN_SUPPLEMENTARY_CODE_POINT</span><br><span class="line">                                    - (MIN_HIGH_SURROGATE &lt;&lt; <span class="number">10</span>)</span><br><span class="line">                                    - MIN_LOW_SURROGATE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>注意这个high &lt;&lt; 10是因为code转成16进制的时候，还补了4个0<br>当 String 判断是否是一个 code point 的时候，首先会判断是否是高位代理，是的话在判断下一个字节是否是低位代理，是的就通过<code>toCodePoint</code>来推导出原来的code。</p></blockquote><h2 id="readResolve方法"><a href="#readResolve方法" class="headerlink" title="readResolve方法"></a>readResolve方法</h2><p>这个方法是为了保证序列化的时候，避免生成多个 String 对象，首先当一个对象被反序列化的时候，其调用链如下:</p><blockquote><p>ObjectInputStream -&gt; readObject() -&gt; readObject0(boolean unshared) -&gt; readOrdinaryObject(boolean unshared) </p></blockquote><p>在<code>readOrdinaryObject</code>中，主要是需要注意如下两段代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Object obj;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    obj = desc.isInstantiable() ? desc.newInstance() : <span class="keyword">null</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> (IOException) <span class="keyword">new</span> InvalidClassException(</span><br><span class="line">        desc.forClass().getName(),</span><br><span class="line">        <span class="string">"unable to create instance"</span>).initCause(ex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (obj != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">    handles.lookupException(passHandle) == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">    desc.hasReadResolveMethod())</span><br><span class="line">&#123;</span><br><span class="line">    Object rep = desc.invokeReadResolve(obj);</span><br><span class="line">    <span class="keyword">if</span> (unshared &amp;&amp; rep.getClass().isArray()) &#123;</span><br><span class="line">        rep = cloneArray(rep);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rep != obj) &#123;</span><br><span class="line">        <span class="comment">// Filter the replacement object</span></span><br><span class="line">        <span class="keyword">if</span> (rep != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rep.getClass().isArray()) &#123;</span><br><span class="line">                filterCheck(rep.getClass(), Array.getLength(rep));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                filterCheck(rep.getClass(), -<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handles.setObject(passHandle, obj = rep);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ObjectStreamClass：</span><br><span class="line">readResolveMethod = getInheritableMethod(cl, <span class="string">"readResolve"</span>, <span class="keyword">null</span>, Object.class);</span><br></pre></td></tr></table></figure></p><p>如果没有重写<code>readResolve</code>的话，那么此时便会直接返回<code>newInstance</code> 生成的新对象了。</p><h2 id="final-的使用"><a href="#final-的使用" class="headerlink" title="final 的使用"></a>final 的使用</h2><p>在 String 中，可以看到需要地方使用到了 final 字段，例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">char</span> value[];</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectStreamField[] serialPersistentFields = <span class="keyword">new</span> ObjectStreamField[<span class="number">0</span>];</span><br></pre></td></tr></table></figure></p><p>这些都好理解，但是其中有一个方法里面的变量名却也使用了final，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">indexOfSupplementary</span><span class="params">(<span class="keyword">int</span> ch, <span class="keyword">int</span> fromIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Character.isValidCodePoint(ch)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">char</span>[] value = <span class="keyword">this</span>.value;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">char</span> hi = Character.highSurrogate(ch);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">char</span> lo = Character.lowSurrogate(ch);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> max = value.length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = fromIndex; i &lt; max; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value[i] == hi &amp;&amp; value[i + <span class="number">1</span>] == lo) &#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在这里我个人感觉其实是没什么作用的，因为方法内部的<code>value</code>会随着<code>this.value</code>的变化而变化(一般不可能)，所以这里的final，也就<code>hi</code>和<code>lo</code>以及<code>max</code>有作用，可以保证同一个方法内部，<br>在多线程的竞态条件下不改变。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;本文的内容都是基于 JDK1.8 来写的，主要是复习下 String 类的设计。&lt;/p&gt;
&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;String 是一个用于存储字符串的类，其内
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot中异步线程的处理</title>
    <link href="https://somersames.github.io/2020/04/02/SpringBoot%E4%B8%AD%E5%BC%82%E6%AD%A5%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%A4%84%E7%90%86/"/>
    <id>https://somersames.github.io/2020/04/02/SpringBoot中异步线程的处理/</id>
    <published>2020-04-02T15:46:30.000Z</published>
    <updated>2020-04-02T15:46:59.043Z</updated>
    
    <content type="html"><![CDATA[<p>在工作或者学习的时候，我们都会接触到异步编程，大多数情况下都是通过新建一个线程池，然后调用<code>submit</code>方法或者<code>execute</code>方法来执行。如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">simpleThreadPool</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ExecutorService executor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">4</span>,<span class="number">5</span>,<span class="number">0</span>, TimeUnit.SECONDS,<span class="keyword">new</span> LinkedBlockingDeque&lt;Runnable&gt;());</span><br><span class="line">        executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"run"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Callable&lt;String&gt; callable = <span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"callable"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Future future = executor.submit(callable);</span><br><span class="line">        System.out.println(future.get());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>在Springboot中其实也可以这样做，但是不利于后期的维护，加入后期需要把 <code>runable</code> 的方法修改为同步类型的，那么此时就需要大量的改动代码，如果说很多地方都用到的了的话，就会很容易漏掉了一处导致bug的产生。</p><h2 id="Spring的解决方法"><a href="#Spring的解决方法" class="headerlink" title="Spring的解决方法"></a>Spring的解决方法</h2><h3 id="不需要返回值的异步"><a href="#不需要返回值的异步" class="headerlink" title="不需要返回值的异步"></a>不需要返回值的异步</h3><p>其实在Spring中就有类似的解决方法，只不过需要我们自己配置。<br>首先新建一个配置类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">asyncPool</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">100</span>);</span><br><span class="line">        executor.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">30</span>);</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在这里最好的做法是将其配置到配置文件中，这样以后调整就不需要改动代码，不过此处为了演示，也就直接固定了。</p><blockquote><p>新建一个 <code>Service</code> 测试。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"A"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayB</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.currentThread().sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(<span class="string">"B"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>调用</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AsyncService asyncService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noReturnAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        asyncService.sayB();</span><br><span class="line">        asyncService.sayA();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>新建一个测试类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = AsyncApplication.class)</span><br><span class="line"><span class="meta">@WebAppConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TestService testService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noReturnAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        testService.noReturnAsync();</span><br><span class="line">        Thread.currentThread().sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时在控制台会发现是先打印的 A，然后再打印的 B，所以这里可以肯定确认的是肯定是异步执行的。</p><p>但是一般情况下，有一个业务方法并不是通用的，假如有一个 <code>C</code> 方法，这个方法是 TestServcie 类里面单独一个人使用的，这个情况下如果需要在 TestServicde 里面使用的话，那么就需要通过 Aop 来获取当前的代理对象。如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AsyncService asyncService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noReturnAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        asyncService.sayB();</span><br><span class="line">        asyncService.sayA();</span><br><span class="line">        C();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">C</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"C"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>如果这样写的话，C方法就会被当成一个同步方法，于是就需要通过 <code>AopContext.currentProxy()</code> 来切换代理对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AsyncService asyncService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noReturnAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        asyncService.sayB();</span><br><span class="line">        asyncService.sayA();</span><br><span class="line">        ((TestService) AopContext.currentProxy()).C();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">C</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"C"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>如果是使用 <code>((TestService) AopContext.currentProxy()).C()</code> 的话，则必须要新增如下Bean<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        BeanDefinition beanDefinition = beanFactory.getBeanDefinition(org.springframework.scheduling.config.TaskManagementConfigUtils.ASYNC_ANNOTATION_PROCESSOR_BEAN_NAME);</span><br><span class="line">        beanDefinition.getPropertyValues().add(<span class="string">"exposeProxy"</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="需要返回值的异步"><a href="#需要返回值的异步" class="headerlink" title="需要返回值的异步"></a>需要返回值的异步</h3><p>上面介绍的都是不需要返回值的异步方法，那么其实很多场景下都是需要返回值的，此时可以通过如下方法来实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Async</span>(<span class="string">"asyncPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">futureA</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.currentThread().sleep(<span class="number">1100</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;String&gt;(<span class="string">"A"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>调用方式还是和之前一直，就是最后需要用一个 <code>Future</code> 来接。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noReturnAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">        Future future = asyncService.futureA();</span><br><span class="line">        asyncService.sayB();</span><br><span class="line">        asyncService.sayA();</span><br><span class="line">        System.out.println(future.get());</span><br><span class="line">        ((TestService) AopContext.currentProxy()).C();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在工作或者学习的时候，我们都会接触到异步编程，大多数情况下都是通过新建一个线程池，然后调用&lt;code&gt;submit&lt;/code&gt;方法或者&lt;code&gt;execute&lt;/code&gt;方法来执行。如下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;tabl
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://somersames.github.io/categories/SpringBoot/"/>
    
    
      <category term="SpringBoot" scheme="https://somersames.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>ES7中大小写不敏感的模糊匹配</title>
    <link href="https://somersames.github.io/2020/03/20/ES7%E4%B8%AD%E5%A4%A7%E5%B0%8F%E5%86%99%E4%B8%8D%E6%95%8F%E6%84%9F%E7%9A%84%E6%A8%A1%E7%B3%8A%E5%8C%B9%E9%85%8D/"/>
    <id>https://somersames.github.io/2020/03/20/ES7中大小写不敏感的模糊匹配/</id>
    <published>2020-03-20T14:14:24.000Z</published>
    <updated>2020-04-02T15:46:07.017Z</updated>
    
    <content type="html"><![CDATA[<p>在ES7.0中</p><p>如果要实现大小写的模糊查询，则首先必须要自定义 <code>analysis</code>，在自定义的 <code>analysis</code> 里面，如果是针对keyword类型的字段， analysis 要定义成 normalizer，而对于text类型的话，则需要为analyzer。如下演示的是<code>normalizer</code>类型的定义。</p><blockquote><p>新建索引<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"normalizer"</span>: &#123;</span><br><span class="line">        <span class="attr">"self_normalizer"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"custom"</span>,</span><br><span class="line">          <span class="attr">"char_filter"</span>: [],</span><br><span class="line">          <span class="attr">"filter"</span>: [</span><br><span class="line">            <span class="string">"lowercase"</span>,</span><br><span class="line">            <span class="string">"asciifolding"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"mappings"</span>:&#123;</span><br><span class="line">    <span class="attr">"properties"</span>:&#123;</span><br><span class="line">      <span class="attr">"field_1"</span>:&#123;</span><br><span class="line">        <span class="attr">"type"</span>:<span class="string">"keyword"</span>,</span><br><span class="line">        <span class="attr">"normalizer"</span>: <span class="string">"self_normalizer"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>此时向ES中新增几条数据：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"took"</span>: <span class="number">6</span>,</span><br><span class="line"><span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">"_shards"</span>: &#123;</span><br><span class="line"><span class="attr">"total"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="attr">"successful"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="attr">"skipped"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"hits"</span>: &#123;</span><br><span class="line"><span class="attr">"total"</span>: &#123;</span><br><span class="line"><span class="attr">"value"</span>: <span class="number">4</span>,</span><br><span class="line"><span class="attr">"relation"</span>: <span class="string">"eq"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"max_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="attr">"hits"</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="attr">"_id"</span>: <span class="string">"2"</span>,</span><br><span class="line"><span class="attr">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="attr">"_source"</span>: &#123;</span><br><span class="line"><span class="attr">"field_1"</span>: <span class="string">"abc"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line"><span class="attr">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="attr">"_source"</span>: &#123;</span><br><span class="line"><span class="attr">"field_1"</span>: <span class="string">"ABC"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="attr">"_id"</span>: <span class="string">"3"</span>,</span><br><span class="line"><span class="attr">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="attr">"_source"</span>: &#123;</span><br><span class="line"><span class="attr">"field_1"</span>: <span class="string">"aBC"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="attr">"_id"</span>: <span class="string">"4"</span>,</span><br><span class="line"><span class="attr">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="attr">"_source"</span>: &#123;</span><br><span class="line"><span class="attr">"field_1"</span>: <span class="string">"Abc"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><p>可以看到此时的对于<code>field_1</code>，在Es中的值大小写都有的，此时进行模糊查询：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"bool"</span>: &#123;</span><br><span class="line">            <span class="attr">"must"</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">"wildcard"</span>: &#123;</span><br><span class="line">                  <span class="attr">"field_1"</span>: &#123;</span><br><span class="line">                    <span class="attr">"value"</span>: <span class="string">"*a*"</span>,</span><br><span class="line">                    <span class="attr">"boost"</span>: <span class="number">1</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"adjust_pure_negative"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"boost"</span>: <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"adjust_pure_negative"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"boost"</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>返回值<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"took"</span>: <span class="number">9</span>,</span><br><span class="line"><span class="string">"timed_out"</span>: <span class="keyword">false</span>,</span><br><span class="line"><span class="string">"_shards"</span>: &#123;</span><br><span class="line"><span class="string">"total"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">"successful"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">"skipped"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="string">"failed"</span>: <span class="number">0</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"hits"</span>: &#123;</span><br><span class="line"><span class="string">"total"</span>: &#123;</span><br><span class="line"><span class="string">"value"</span>: <span class="number">4</span>,</span><br><span class="line"><span class="string">"relation"</span>: <span class="string">"eq"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"max_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="string">"hits"</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="string">"_id"</span>: <span class="string">"2"</span>,</span><br><span class="line"><span class="string">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="string">"_source"</span>: &#123;</span><br><span class="line"><span class="string">"field_1"</span>: <span class="string">"abc"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="string">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line"><span class="string">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="string">"_source"</span>: &#123;</span><br><span class="line"><span class="string">"field_1"</span>: <span class="string">"ABC"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="string">"_id"</span>: <span class="string">"3"</span>,</span><br><span class="line"><span class="string">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="string">"_source"</span>: &#123;</span><br><span class="line"><span class="string">"field_1"</span>: <span class="string">"aBC"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_index"</span>: <span class="string">"test_ascii"</span>,</span><br><span class="line"><span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line"><span class="string">"_id"</span>: <span class="string">"4"</span>,</span><br><span class="line"><span class="string">"_score"</span>: <span class="number">1.0</span>,</span><br><span class="line"><span class="string">"_source"</span>: &#123;</span><br><span class="line"><span class="string">"field_1"</span>: <span class="string">"Abc"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在ES7.0中&lt;/p&gt;
&lt;p&gt;如果要实现大小写的模糊查询，则首先必须要自定义 &lt;code&gt;analysis&lt;/code&gt;，在自定义的 &lt;code&gt;analysis&lt;/code&gt; 里面，如果是针对keyword类型的字段， analysis 要定义成 normalizer，而
      
    
    </summary>
    
      <category term="ElasticSearch" scheme="https://somersames.github.io/categories/ElasticSearch/"/>
    
    
      <category term="ElasticSearch" scheme="https://somersames.github.io/tags/ElasticSearch/"/>
    
  </entry>
  
  <entry>
    <title>springboot多数据源-sqlSessionFactory</title>
    <link href="https://somersames.github.io/2020/03/19/springboot%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90-sqlSessionFactory/"/>
    <id>https://somersames.github.io/2020/03/19/springboot多数据源-sqlSessionFactory/</id>
    <published>2020-03-19T11:57:04.000Z</published>
    <updated>2020-03-20T14:08:57.710Z</updated>
    
    <content type="html"><![CDATA[<p>在SpringBoot中，动态的切换数据源的方式有两种，一种是通过<code>AbstractRoutingDataSource</code>来通过注解实现，另一种则是通过配置不同的<code>SqlSessionFactory</code>来读取不同文件夹的mapper，从而实现多数据源。<br>代码如下：</p><blockquote><p>DataSourceOneConfig</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = &#123;<span class="string">"xyz.somersames.dao.one"</span>&#125; ,sqlSessionTemplateRef = <span class="string">"dataSourceOneSqlSessionTemplate"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceOneConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceOneT"</span>)</span><br><span class="line">    <span class="comment">// 这里后面加一个T是防止Spring出现skiped mapperFactoryBean 错误，导致无法注入</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.one"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceOneSqlSessionFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">setSqlSessionFactory</span><span class="params">(@Qualifier(<span class="string">"dataSourceOneT"</span>)</span> DataSource dataSource) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSource);</span><br><span class="line">        bean.setMapperLocations(<span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string">"classpath:mapper/one/*.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceOneTransactionManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">setTransactionManager</span><span class="params">(@Qualifier(<span class="string">"dataSourceOneT"</span>)</span> DataSource dataSource) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceOneSqlSessionTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionTemplate <span class="title">setSqlSessionTemplate</span><span class="params">(@Qualifier(<span class="string">"dataSourceOneSqlSessionFactory"</span>)</span> SqlSessionFactory sqlSessionFactory) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>DataSourceTwoConfig</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = &#123;<span class="string">"xyz.somersames.dao.two"</span>&#125; ,sqlSessionTemplateRef = <span class="string">"dataSourceTwoSqlSessionTemplate"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceTwoConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceTwoT"</span>)</span><br><span class="line">    <span class="comment">// 这里后面加一个T是防止Spring出现skiped mapperFactoryBean 错误，导致无法注入</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.two"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceTwoSqlSessionFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">setSqlSessionFactory</span><span class="params">(@Qualifier(<span class="string">"dataSourceTwoT"</span>)</span> DataSource dataSource) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSource);</span><br><span class="line">        bean.setMapperLocations(<span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string">"classpath:mapper/two/*.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceTwoTransactionManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">setTransactionManager</span><span class="params">(@Qualifier(<span class="string">"dataSourceTwoT"</span>)</span> DataSource dataSource) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceTwoSqlSessionTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionTemplate <span class="title">setSqlSessionTemplate</span><span class="params">(@Qualifier(<span class="string">"dataSourceTwoSqlSessionFactory"</span>)</span> SqlSessionFactory sqlSessionFactory) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当添加了这两个配置以后，dataSourceOneT 会扫描 <code>mapper/one</code> 下面的 xml 文件，而 dataSourceTwoT 会扫描 <code>mapper/two</code> 下面的 xml 文件。<br>然后添加配置文件</p><blockquote><p>application.yml</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8091</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    one:</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      password:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">jdbc:mysql://localhost:3306/test?useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">    two:</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      password:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">jdbc:mysql://localhost:3306/test_lock?useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br></pre></td></tr></table></figure><p>在这里顺带说一句，SqlSessionFactory 负责打开 SqlSession，一个SqlSession代表的就是一次回话，但是如果你在方法上加了一个 <code>@Transactional</code> 注解，那么这个方法里面的所有数据库操作都会认为是一个SqlSession</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在SpringBoot中，动态的切换数据源的方式有两种，一种是通过&lt;code&gt;AbstractRoutingDataSource&lt;/code&gt;来通过注解实现，另一种则是通过配置不同的&lt;code&gt;SqlSessionFactory&lt;/code&gt;来读取不同文件夹的mapper，
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://somersames.github.io/categories/SpringBoot/"/>
    
    
      <category term="SpringBoot" scheme="https://somersames.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot2.x是怎样只初始化LettuceConnectionFactory的呢</title>
    <link href="https://somersames.github.io/2020/01/05/SpringBoot2-x%E6%98%AF%E6%80%8E%E6%A0%B7%E5%8F%AA%E5%88%9D%E5%A7%8B%E5%8C%96LettuceConnectionFactory%E7%9A%84%E5%91%A2/"/>
    <id>https://somersames.github.io/2020/01/05/SpringBoot2-x是怎样只初始化LettuceConnectionFactory的呢/</id>
    <published>2020-01-05T07:22:19.000Z</published>
    <updated>2020-01-05T07:27:44.880Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SpringBoot1-5使用Redis和2-x的区别"><a href="#SpringBoot1-5使用Redis和2-x的区别" class="headerlink" title="SpringBoot1.5使用Redis和2.x的区别"></a>SpringBoot1.5使用Redis和2.x的区别</h2><p>在 SpringBoot1.5 的版本的时候，如果要创建一个 RedisTemplate 的话，那么可以直接使用如下代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;String,Object&gt; <span class="title">redisTemplate</span><span class="params">(JedisConnectionFactory jedisConnectionFactory)</span></span>&#123;</span><br><span class="line">        RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(jedisConnectionFactory);</span><br><span class="line">        <span class="comment">// 添加序列化代码</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>然后在业务类中直接通过 <code>@Autowired</code> 注解来调用 redisTemplate，但是如果将 SpringBoot1.5 升级到 2.0 之后，你会发现这样写的话，SpringBoot 启动的时候会报错。报错内容如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The following candidates were found but could not be injected:</span><br><span class="line">- Bean method <span class="string">'redisConnectionFactory'</span> in <span class="string">'JedisConnectionConfiguration'</span> not loaded because <span class="meta">@ConditionalOnBean</span> (types: org.springframework.data.redis.connection.RedisConnectionFactory; SearchStrategy: all) found beans of type <span class="string">'org.springframework.data.redis.connection.RedisConnectionFactory'</span> redisConnectionFactory</span><br><span class="line">    </span><br><span class="line">Consider revisiting the entries above or defining a bean of type <span class="string">'org.springframework.data.redis.connection.jedis.JedisConnectionFactory'</span> in your configuration.</span><br></pre></td></tr></table></figure></p><p>这个提示说明了 <code>redisConnectionFactory</code> 没有被加载到，这个时候先去官方文档上看下 changelog，然后在看下是不是有什么变化。<br><a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.0-Migration-Guide#redis" target="_blank" rel="noopener">SpringBoot1.x升级到2.X的简介</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Redis</span><br><span class="line">Lettuce is now used instead of Jedis as the Redis driver when you use spring-boot-starter-data-redis. If you are using higher level Spring Data constructs you should find that the change is transparent.</span><br><span class="line"></span><br><span class="line">We still support Jedis. Switch dependencies <span class="keyword">if</span> you prefer Jedis by excluding io.lettuce:lettuce-core and adding redis.clients:jedis instead.</span><br><span class="line"></span><br><span class="line">Connection pooling is optional and, <span class="keyword">if</span> you are using it, you now need to add commons-pool2 yourself as Lettuce, contrary to Jedis, does not bring it transitively.</span><br></pre></td></tr></table></figure></p><p>也就是说 SpringBoot2.x 已经将 LettuceConnectionFactory 作为官方的 Redis 连接工具了，那么尝试着将 <code>LettuceConnectionFactory</code> 作为那个 redisTemplate 的入参，最后调整如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;String,Object&gt; <span class="title">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span></span>&#123;</span><br><span class="line">    RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">    redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">    <span class="comment">// 序列化代码</span></span><br><span class="line">    <span class="keyword">return</span> redisTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>于是启动就不再报错了。而且也可以正常的使用。但是如果你还是想使用 Jedis 的话，直接 exclued <code>io.lettuce:lettuce-core</code> 即可。</p><h2 id="为什么在SpringBoot2-x中两个RedisConnectionFactory只会加载一个"><a href="#为什么在SpringBoot2-x中两个RedisConnectionFactory只会加载一个" class="headerlink" title="为什么在SpringBoot2.x中两个RedisConnectionFactory只会加载一个"></a>为什么在SpringBoot2.x中两个RedisConnectionFactory只会加载一个</h2><h3 id="SpringBoot2-x中加载的加载机制redisConnectionFactory的实现"><a href="#SpringBoot2-x中加载的加载机制redisConnectionFactory的实现" class="headerlink" title="SpringBoot2.x中加载的加载机制redisConnectionFactory的实现"></a>SpringBoot2.x中加载的加载机制redisConnectionFactory的实现</h3><p>首先 Redis 的一些配置都是依赖于 <code>RedisAutoConfiguration</code>，这个类是在 <code>spring-boot-autoconfigure</code> 里面，首先看下这个类的大体结构：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(RedisOperations.class)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(RedisProperties.class)</span><br><span class="line"><span class="meta">@Import</span>(&#123; LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"><span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> StringRedisTemplate <span class="title">stringRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">StringRedisTemplate template = <span class="keyword">new</span> StringRedisTemplate();</span><br><span class="line">template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"><span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>首先这个类上面有四个注解，那么这四个注解的作用如下：</p><ol><li>@Configuration(proxyBeanMethods = false)，声明这是一个配置类，同时也说明了不要让 SpringBoot 为这个类生成代理类</li><li>@ConditionalOnClass(RedisOperations.class)，当 classPath 中出现了 <code>RedisOperations</code> 这个类之后，该类才会加载成一个Bean</li><li>@EnableConfigurationProperties(RedisProperties.class)，将配置类 <code>RedisProperties</code> 加载进来，由于</li><li>@Import({ LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class })</li></ol><p>在上述的几个注解里面，最重要的是 <code>@Import</code> 注解，这个注解可以允许我们在</p><p>TODO</p><h2 id="LettuceConnectionConfiguration-和-JedisConnectionConfiguration"><a href="#LettuceConnectionConfiguration-和-JedisConnectionConfiguration" class="headerlink" title="LettuceConnectionConfiguration 和 JedisConnectionConfiguration"></a>LettuceConnectionConfiguration 和 JedisConnectionConfiguration</h2><p>当查看这两个类里面的方法的时候，会发现在创建 <code>redisConnectionFactory</code> 这个Bean的时候，都会有一个 @ConditionalOnMissingBean(RedisConnectionFactory.class) 注解。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(RedisConnectionFactory.class)</span><br><span class="line"><span class="function">LettuceConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ObjectProvider&lt;LettuceClientConfigurationBuilderCustomizer&gt; builderCustomizers,</span></span></span><br><span class="line"><span class="function"><span class="params">        ClientResources clientResources)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">    LettuceClientConfiguration clientConfig = getLettuceClientConfiguration(builderCustomizers, clientResources,</span><br><span class="line">            getProperties().getLettuce().getPool());</span><br><span class="line">    <span class="keyword">return</span> createLettuceConnectionFactory(clientConfig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(RedisConnectionFactory.class)</span><br><span class="line"><span class="function">JedisConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ObjectProvider&lt;JedisClientConfigurationBuilderCustomizer&gt; builderCustomizers)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createJedisConnectionFactory(builderCustomizers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>很明显，这两个注解都是当 <code>RedisConnectionFactory.class</code> 这个 Bean 不存在的时候才会创建，而且在 <code>RedisAutoConfiguration</code> 中，首先 import 的是 <code>LettuceConnectionConfiguration</code>，所以最后才会导致在 SpringBoot2.x 的时候，默认加载的 <code>redisConnectionFactory</code> 是 <code>LettuceConnectionFactory</code>。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;SpringBoot1-5使用Redis和2-x的区别&quot;&gt;&lt;a href=&quot;#SpringBoot1-5使用Redis和2-x的区别&quot; class=&quot;headerlink&quot; title=&quot;SpringBoot1.5使用Redis和2.x的区别&quot;&gt;&lt;/a&gt;Sprin
      
    
    </summary>
    
      <category term="SpringBoot" scheme="https://somersames.github.io/categories/SpringBoot/"/>
    
    
      <category term="SpringBoot" scheme="https://somersames.github.io/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>浅谈工厂模式</title>
    <link href="https://somersames.github.io/2019/12/27/%E6%B5%85%E8%B0%88%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"/>
    <id>https://somersames.github.io/2019/12/27/浅谈工厂模式/</id>
    <published>2019-12-26T16:14:53.000Z</published>
    <updated>2019-12-26T16:45:11.465Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>工厂模式解决的是频繁的修改某一些 new 操作，隐藏真实的创建过程，方便以后更加快速的新增和扩展，简单来说就是维护一类关系。</p><h3 id="简单工厂："><a href="#简单工厂：" class="headerlink" title="简单工厂："></a>简单工厂：</h3><p>把对象的创建放到一个Util中，通过不同的入参来创建不同的类。这也是日常编码中经常用到的，不过缺点就是每次新增一个类的时候，都需要修改<code>if/else</code>判断，有点繁琐。</p><h3 id="工厂方法："><a href="#工厂方法：" class="headerlink" title="工厂方法："></a>工厂方法：</h3><p>将含有相同属性的类抽象成一个工厂，这一个工厂只负责自己的对象的创建，对修改关闭，对扩展开放。</p><h3 id="抽象工厂："><a href="#抽象工厂：" class="headerlink" title="抽象工厂："></a>抽象工厂：</h3><p>对类的操作进一步的划分，将某种类的操作再次进行抽象化。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>假设现在要开发一个餐厅点餐系统，首先肯定是有顾客以及食物。为了以后的扩展性，在这里通过三种工厂方法来实现不同的需求</p><h3 id="简单工厂"><a href="#简单工厂" class="headerlink" title="简单工厂"></a>简单工厂</h3><p>现在有两个类，User 和 Food，此时有一个需求是人需要吃食物，可能你毫不犹豫的写下了如下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Potato</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> temperaturel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Potato</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"加热中"</span>);</span><br><span class="line">        <span class="keyword">this</span>.temperaturel = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> User().dinner();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dinner</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Potato potato = <span class="keyword">new</span> Potato(<span class="string">"土豆"</span>);</span><br><span class="line">        potato.cook();</span><br><span class="line">        System.out.println(<span class="string">"吃晚餐"</span> + potato.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>后来有一天需求变了，现在需要再加一个食物以供客户选择，后来你想了下，决定写一个 <code>Util</code> 类。如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getFood</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(name != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"Potato"</span>.equals(name))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Potato(<span class="string">"土豆"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"Tomato"</span>.equals(name))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tomato(<span class="string">"西红柿"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>这段代码明显的有一个问题就是，返回的 Object 在另一个地方进行强制转换的时候，由于不知道返回的是 Potato 还是 Tomato，所以很容易抛出转换异常，所以此时，再继续优化这段代码，由于土豆和西红柿都是食物的一种，于是可以直接抽象一个接口出来。这样土豆和马铃薯都实现这个接口。如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Food</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cook</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Potato</span> <span class="keyword">implements</span> <span class="title">Food</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> temperaturel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Potato</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"加热中"</span>);</span><br><span class="line">        <span class="keyword">this</span>.temperaturel = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tomato</span> <span class="keyword">implements</span> <span class="title">Food</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> temperaturel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tomato</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"加热中"</span>);</span><br><span class="line">        <span class="keyword">this</span>.temperaturel = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这个时候呢，修改 Util 类，让它返回 Food 这个抽象，然后通过实例化子类，来实现模版的调用，于是继续修改 Util 类。如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FoodUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Food <span class="title">getFood</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(name != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"Potato"</span>.equals(name))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Potato(<span class="string">"土豆"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"Tomato"</span>.equals(name))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tomato(<span class="string">"西红柿"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> User().dinner(<span class="string">"Potato"</span>);</span><br><span class="line">        <span class="keyword">new</span> User().dinner(<span class="string">"Tomato"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dinner</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        Food food = FoodUtil.getFood(name);</span><br><span class="line">        food.cook();</span><br><span class="line">        System.out.println(<span class="string">"吃晚餐"</span> + food.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>但是随着食物种类的不断增加，每一次新增一种食物，你都要去修改<code>getFood</code>这个方法，每次修改完毕之后，你还必须对其进行回归测试，万一改错了，或者<code>equals</code>方法调用者的<code>key</code>重复了，那就会影响到系统的运行了。而且这也不符合设计模式里面的开闭原则，对扩展开放，对修改关闭。所以此时继续对这个 Util 进行修改。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Food <span class="title">getFood</span><span class="params">(Class&lt;? extends Food&gt; clazz)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(clazz != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 在这里方便演示是设计模式，所以在Tomato 和 Potato加入了无参的构造器</span></span><br><span class="line">            <span class="keyword">return</span> clazz.newInstance();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>这就是一个简单工厂模式，简单工厂模式严格意义上来讲并不属于设计模式其中之一，但是这也是我们在开发过程中经常使用的一种方式，用于避免一些无意义的 new 操作。<br>接下来就来讲下工厂方法模式。</p><h2 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//抽象的一个工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line">    <span class="function">Food <span class="title">createFood</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 西红柿工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PotatoFactory</span> <span class="keyword">implements</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">createFood</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Potato();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 土豆工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomatoFactory</span> <span class="keyword">implements</span> <span class="title">FoodFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">createFood</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"清洗干净"</span>);</span><br><span class="line">        System.out.println(<span class="string">"切好"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Tomato();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个时候，假设我们要使用的话，则直接通过 new 一个子类即可，如下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FoodFactory potatoFactory = <span class="keyword">new</span> PotatoFactory();</span><br><span class="line">        FoodFactory tomatoFactory = <span class="keyword">new</span> TomatoFactory();</span><br><span class="line">        tomatoFactory.createFood().cook();</span><br><span class="line">        potatoFactory.createFood().cook();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这样做的好处是，对扩展开放，当需要添加其他食物的时候，直接新建一个<code>Factory</code>类然后实现<code>FoodFactory</code>接口即可，这就是工厂模式的好处。</p><h2 id="抽象工厂模式"><a href="#抽象工厂模式" class="headerlink" title="抽象工厂模式"></a>抽象工厂模式</h2><p>抽象工厂模式是对工厂的更进一步抽象，例如 土豆 和 西红柿是一组产品，因为它们都同属于食物。但是现在有两个地方都可以生产 土豆 和 西红柿，A地的是金色的，B地生产的是银色的，于是此时 A 和 B 就产生了一个产品等级。但是A 和 B都是具有一组通用的特性，即使可以生产不同的颜色 土豆 和 西红柿。</p><pre><code class="java"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlantFactory</span> </span>{    <span class="function">Tomato <span class="title">plantTomato</span><span class="params">()</span></span>;    <span class="function">Potato <span class="title">plantPotato</span><span class="params">()</span></span>;}<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AFactory</span> <span class="keyword">implements</span> <span class="title">PlantFactory</span></span>{    <span class="meta">@Override</span>    <span class="function"><span class="keyword">public</span> Tomato <span class="title">plantTomato</span><span class="params">()</span> </span>{        System.out.println(<span class="string">"plantTomato By A"</span>);        <span class="keyword">return</span> <span class="keyword">new</span> Tomato();    }    <span class="meta">@Override</span>    <span class="function"><span class="keyword">public</span> Potato <span class="title">plantPotato</span><span class="params">()</span> </span>{        System.out.println(<span class="string">"plantPotato By A"</span>);        <span class="keyword">return</span> <span class="keyword">new</span> Potato();    }}<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BFactory</span> <span class="keyword">implements</span> <span class="title">PlantFactory</span> </span>{    <span class="meta">@Override</span>    <span class="function"><span class="keyword">public</span> Tomato <span class="title">plantTomato</span><span class="params">()</span> </span>{        System.out.println(<span class="string">"plantTomato By B"</span>);        <span class="keyword">return</span> <span class="keyword">new</span> Tomato();    }    <span class="meta">@Override</span>    <span class="function"><span class="keyword">public</span> Potato <span class="title">plantPotato</span><span class="params">()</span> </span>{        System.out.println(<span class="string">"plantPotato By B"</span>);        <span class="keyword">return</span> <span class="keyword">new</span> Potato();    }}<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{        PlantFactory plantFactory = <span class="keyword">new</span> AFactory();        plantFactory.plantPotato().cook();    }}</code></pre><p>总的来说，这三种设计模式中，除了抽象工厂模式很少使用到，其他两种在平常开发的项目中基本上都可以看到。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;工厂模式解决的是频繁的修改某一些 new 操作，隐藏真实的创建过程，方便以后更加快速的新增和扩展，简单来说就是维护一类关系。&lt;/p&gt;
&lt;h3
      
    
    </summary>
    
      <category term="设计模式" scheme="https://somersames.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="设计模式" scheme="https://somersames.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Mysql中int类型的简单总结</title>
    <link href="https://somersames.github.io/2019/12/17/Mysql%E4%B8%ADint%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%AE%80%E5%8D%95%E6%80%BB%E7%BB%93/"/>
    <id>https://somersames.github.io/2019/12/17/Mysql中int类型的简单总结/</id>
    <published>2019-12-16T16:33:00.000Z</published>
    <updated>2019-12-16T16:46:20.162Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>首先问两个问题：</p><ol><li>int(1)和int(10)有什么区别。</li><li>int(3)可以存储 10000 这个数字吗？</li><li>int(11)可以用来存储手机号么？</li></ol><p>本次的源代码以及测试的 Mysql 版本均为 8.0.17</p><h2 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h2><p>首先新建一个表，SQL如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_int(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> ,</span><br><span class="line">    <span class="keyword">no</span> <span class="built_in">int</span>(<span class="number">5</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    phone <span class="built_in">int</span>(<span class="number">11</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br></pre></td></tr></table></figure></p><p>当你执行完这个 SQL 以后，Mysql会发出一个如下提示：</p><blockquote><p>[2019-12-16 23:08:24] [HY000][1681] Integer display width is deprecated and will be removed in a future release.<br>首先不管这个提示，待会后文会解释的。</p></blockquote><p> 然后新增测试数据：<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test_int`</span> (<span class="string">`id`</span>, <span class="string">`no`</span>, <span class="string">`phone`</span>) <span class="keyword">VALUES</span> (<span class="number">10000</span>, <span class="number">1008611</span>, <span class="number">123124</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test_int`</span> (<span class="string">`id`</span>, <span class="string">`no`</span>, <span class="string">`phone`</span>) <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="number">134</span>, <span class="number">124</span>);</span><br></pre></td></tr></table></figure></p><p> 然后再进行 select 查看。<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> mysql&gt; select * from test_int;</span><br><span class="line">+<span class="comment">-------+---------+--------+</span></span><br><span class="line">| id    | no      | phone  |</span><br><span class="line">+<span class="comment">-------+---------+--------+</span></span><br><span class="line">|    10 |     134 |    124 |</span><br><span class="line">| 10000 | 1008611 | 123124 |</span><br><span class="line">+<span class="comment">-------+---------+--------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><p> 可以看到其实并没有影响到任何数据的插入，随后查询 Mysql 的官方文档，里面有这样的一段话</p><blockquote><p>If you specify ZEROFILL for a numeric column, MySQL automatically adds the UNSIGNED attribute to the column.</p></blockquote><p>随后再次新建一个表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_int_zerofill(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">unsigned</span> zerofill <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> ,</span><br><span class="line">    <span class="keyword">no</span> <span class="built_in">int</span>(<span class="number">5</span>) <span class="keyword">unsigned</span> zerofill <span class="keyword">not</span> <span class="literal">null</span> ,</span><br><span class="line">    phone <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> zerofill</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line">The ZEROFILL attribute is deprecated and will be removed in a future release. <span class="keyword">Use</span> the <span class="keyword">LPAD</span> <span class="keyword">function</span> <span class="keyword">to</span> zero-<span class="keyword">pad</span> numbers, <span class="keyword">or</span> <span class="keyword">store</span> the formatted numbers <span class="keyword">in</span> a <span class="built_in">CHAR</span> column.</span><br></pre></td></tr></table></figure></p><p>虽然提示 ZEROFILL 快要被废弃了，但是为了演示区别，所以暂时还是不管了。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from test_int_zerofill;</span><br><span class="line">+<span class="comment">-------+--------+-------------+</span></span><br><span class="line">| id    | no     | phone       |</span><br><span class="line">+<span class="comment">-------+--------+-------------+</span></span><br><span class="line">|   010 |  00010 | 00000000010 |</span><br><span class="line">| 12345 | 123456 | 00001234567 |</span><br><span class="line">+<span class="comment">-------+--------+-------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><p>所以对于问题1，所以 int(1) 和 int(10) 其实是没有区别的，唯一有区别的地方就在于如果使用了 <code>unsigned zerofill</code> 修饰的话，那么不足长度的会在左边进行补 0 ，而如果没有用 <code>unsigned zerofill</code> 进行修饰的话，可以说基本上是没有区别的。</p><p>对于问题2，因为 int 括号里面的值与位数无关， 所以是可以的。<br>到此，对于执行第一个SQL所进行的提示，是因为 Mysql 也觉得其实没什么意义，而是更加推荐用 <code>LDAP()</code> 这个函数来判断。</p><p>对于第二个问题，可以尝试一个手机号：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`test_int_zerofill`</span> (<span class="string">`id`</span>, <span class="string">`no`</span>, <span class="string">`phone`</span>) <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="number">10</span>, <span class="number">13100000000</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">22001</span>][<span class="number">1264</span>] <span class="keyword">Data</span> truncation: <span class="keyword">Out</span> <span class="keyword">of</span> <span class="keyword">range</span> <span class="keyword">value</span> <span class="keyword">for</span> <span class="keyword">column</span> <span class="string">'phone'</span> <span class="keyword">at</span> <span class="keyword">row</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p><p>出现这个问题的原因在于 int 类型在 mysql 里面是四个字节，而一个字节是 8 位，所以在 mysql 里面，一个int 类型最多可以储存 2^31(一个符号位置)，也就是约 21 亿左右，无符号的也最多42亿，但是手机号最低也是11位，也就是 130 多亿。所以肯定是无法存储的。<br>下面是 Mysql 官方给出的 num 类型的存储范围<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/%E6%88%AA%E5%B1%8F2019-12-17%E4%B8%8A%E5%8D%8812.25.08.png" alt=""></p><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>由于想看下 Mysql 到底是如何处理 int 类型的数值的，于是下载并且编译了 Mysql 的源码，一直跟着 debug，最后找到了 Mysql 判断 int 是否超长的一个代码，如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">type_conversion_status Field_long::store(<span class="keyword">double</span> nr) &#123;</span><br><span class="line">  ASSERT_COLUMN_MARKED_FOR_WRITE;</span><br><span class="line">  type_conversion_status error = TYPE_OK;</span><br><span class="line">  int32 res;</span><br><span class="line">  nr = rint(nr);</span><br><span class="line">  <span class="keyword">if</span> (unsigned_flag) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nr &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      res = <span class="number">0</span>;</span><br><span class="line">      error = TYPE_WARN_OUT_OF_RANGE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr &gt; (<span class="keyword">double</span>)UINT_MAX32) &#123;</span><br><span class="line">      res = UINT_MAX32;</span><br><span class="line">      set_warning(Sql_condition::SL_WARNING, ER_WARN_DATA_OUT_OF_RANGE, <span class="number">1</span>);</span><br><span class="line">      error = TYPE_WARN_OUT_OF_RANGE;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">      res = (int32)(ulong)nr;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nr &lt; (<span class="keyword">double</span>)INT_MIN32) &#123;</span><br><span class="line">      res = (int32)INT_MIN32;</span><br><span class="line">      error = TYPE_WARN_OUT_OF_RANGE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nr &gt; (<span class="keyword">double</span>)INT_MAX32) &#123;</span><br><span class="line">      res = (int32)INT_MAX32;</span><br><span class="line">      error = TYPE_WARN_OUT_OF_RANGE;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">      res = (int32)(longlong)nr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (error)</span><br><span class="line">    set_warning(Sql_condition::SL_WARNING, ER_WARN_DATA_OUT_OF_RANGE, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WORDS_BIGENDIAN</span></span><br><span class="line">  <span class="keyword">if</span> (table-&gt;s-&gt;db_low_byte_first) &#123;</span><br><span class="line">    int4store(ptr, res);</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">    longstore(ptr, res);</span><br><span class="line">  <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在这段代码里面，Mysql首先会判断是否带有符号位，如果是无符号位的话，则是直接判断是否大于 UINT_MAX32，而如果是有符号的话，则是判断是否小于 INT_MIN32 或者大于 INT_MAX32，否则直接为最小或者最大值，然后设置error。<br>PS：这一段代码是还未进行 InnoDB 引擎层，可以看到 Mysql 是在 Server 层进行SQL语句的校验。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题&quot;&gt;&lt;a href=&quot;#问题&quot; class=&quot;headerlink&quot; title=&quot;问题&quot;&gt;&lt;/a&gt;问题&lt;/h2&gt;&lt;p&gt;首先问两个问题：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;int(1)和int(10)有什么区别。&lt;/li&gt;
&lt;li&gt;int(3)可以存储 10000 这
      
    
    </summary>
    
      <category term="Mysql" scheme="https://somersames.github.io/categories/Mysql/"/>
    
    
      <category term="Mysql" scheme="https://somersames.github.io/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>java validation 的国际化</title>
    <link href="https://somersames.github.io/2019/12/09/java-validation-%E7%9A%84%E5%9B%BD%E9%99%85%E5%8C%96/"/>
    <id>https://somersames.github.io/2019/12/09/java-validation-的国际化/</id>
    <published>2019-12-09T14:56:38.000Z</published>
    <updated>2019-12-09T16:18:47.197Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在一个完整的项目里面，肯定是有各种各样的入参校验的，如果业务上的一些逻辑校验，可以放在 Service 层面进行，但是如果是 Controller 里面的校验，直接可以用 validation 进行验证。配合注解可以很方便的实现各种各样的入参校验。<br>如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank</span>(message = <span class="string">"用户名称不能为空"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Max</span>(value = <span class="number">18</span>)</span><br><span class="line">    <span class="meta">@Min</span>(value = <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>然后在Controller里面<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"test"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testError</span><span class="params">(@Valid  @RequestBody User user ,Errors errors)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">for</span> (ObjectError err : errors.getAllErrors()) &#123;</span><br><span class="line">            <span class="keyword">return</span> err.getDefaultMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>当入参的 JSON 如果 name 是空的话，就会直接返回 <code>用户名称不能为空</code>，当然这里是做了一些简化，返回的应该还有 Code 和 Message。这样的话一个简单的 Controller 检验入参就实现的，但是为了扩展性和可维护性，还需要考虑<code>国际化</code>以及<code>可配置化</code>。</p><h2 id="扩展性"><a href="#扩展性" class="headerlink" title="扩展性"></a>扩展性</h2><p>如果在之后需要更改一个校验的提示语，那么在上面的代码里面是需要修改代码的，那么最好的办法就是把这些提示信息都加到配置文件中，那么以后需要修改某些提示的话，直接改配置文件即可。<br>在 Spring 官方文档的 <strong>4.7.1</strong> 中有一个类 <code>MessageCodesResolver</code> 可以用来实现错误信息的可配置化</p><h3 id="MessageCodesResolver"><a href="#MessageCodesResolver" class="headerlink" title="MessageCodesResolver"></a>MessageCodesResolver</h3><p>这个类需要和<code>spring.mvc.message-codes-resolver-format</code>一起来使用，根据官方文档的提示，查看<code>DefaultMessageCodesResolver.Format</code>，会发现这个参数有两个枚举，一个是 PREFIX_ERROR_CODE，另一个是 POSTFIX_ERROR_CODE。<br>这两个什么意思呢，简单来讲，根据上面的 User 类，如果我要配置当 name 不为空的提示语，下面两种枚举对应在配置文件中的键值是不一样的。</p><ol><li>PREFIX_ERROR_CODE<blockquote><p>NotBlank.user.name = 用户名称不能为空</p></blockquote></li><li>POSTFIX_ERROR_CODE。<blockquote><p>user.name.NotBlank = 用户名称不能为空</p></blockquote></li></ol><p>个人偏向于第二种写法的，因为感觉第二种更加符合阅读习惯。</p><h2 id="messgae配置文件"><a href="#messgae配置文件" class="headerlink" title="messgae配置文件"></a>messgae配置文件</h2><p>既然需要做成配置文件，那么在 application.yml 里面把一些属性都配置好，如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  mvc:</span></span><br><span class="line"><span class="attr">    message-codes-resolver-format:</span> <span class="string">postfix_error_code</span></span><br><span class="line"><span class="attr">  messages:</span></span><br><span class="line"><span class="attr">    basename:</span> <span class="string">i18n/validation</span></span><br></pre></td></tr></table></figure></p><p>然后在 Resources 下面新建一个 validation.properties<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user.name.NotBlank = 用户名称不能为空</span><br><span class="line">user.age.Max = 年龄最高不能高于<span class="number">18</span></span><br><span class="line">user.age.Min = 年龄最高不能低于<span class="number">10</span></span><br></pre></td></tr></table></figure></p><h3 id="Controller-校验"><a href="#Controller-校验" class="headerlink" title="Controller 校验"></a>Controller 校验</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MessageSource messageSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"test/cn"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testErrorCn</span><span class="params">(@Valid  @RequestBody User user ,Errors errors)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">for</span> (ObjectError err : errors.getAllErrors()) &#123;</span><br><span class="line">            String msg = messageSource.getMessage(err, Locale.CHINA);</span><br><span class="line">            <span class="keyword">return</span> msg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里暂时先不管 <code>Locale.CHINA</code> 这个参数的含义，首先通过 errors 先判断入参是否有问题，有的话直接通过 messageSource.getMessage() 方法直接返回错误信息即可。</p><h3 id="PsotMan测试"><a href="#PsotMan测试" class="headerlink" title="PsotMan测试"></a>PsotMan测试</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /test/cn HTTP/<span class="number">1.1</span></span><br><span class="line">Host: localhost:<span class="number">8071</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"age"</span>:<span class="number">15</span>&#125;</span><br></pre></td></tr></table></figure><p>返回：用户名称不能为空</p><p>那么以后如果需要修改返回提示的话，直接修改配置文件即可，从而不需要修改代码。</p><h3 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h3><p>如果需要将该提示国际化，直接修改配置文件即可，新建两个配置文件<code>validation_zh_CN.properties</code>，<code>validation_en_US.properties</code>，然后分别新建提示配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">validation_zh_CN.properties：</span><br><span class="line">user.name.NotBlank = 用户名称不能为空</span><br><span class="line">user.age.Max = 年龄最高不能高于18</span><br><span class="line">user.age.Min = 年龄最高不能低于10</span><br><span class="line"></span><br><span class="line">validation_en_US.properties：</span><br><span class="line">user.name.NotBlank = user name can not be null</span><br><span class="line">user.age.Max = the max gae can not grater than 18</span><br><span class="line">user.age.Min = the max gae can not less than 10</span><br></pre></td></tr></table></figure></p><p>此时在Controller里面代如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MessageSource messageSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testError</span><span class="params">(@Valid  @RequestBody User user ,Errors errors)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">            <span class="keyword">for</span> (ObjectError err : errors.getAllErrors()) &#123;</span><br><span class="line">                <span class="keyword">return</span> err.getDefaultMessage();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"test/cn"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testErrorCn</span><span class="params">(@Valid  @RequestBody User user ,Errors errors)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">            <span class="keyword">for</span> (ObjectError err : errors.getAllErrors()) &#123;</span><br><span class="line">                String msg = messageSource.getMessage(err, Locale.CHINA);</span><br><span class="line">                <span class="keyword">return</span> msg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"test/en"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testErrorEn</span><span class="params">(@Valid  @RequestBody User user ,Errors errors)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(errors.hasErrors())&#123;</span><br><span class="line">            <span class="keyword">for</span> (ObjectError err : errors.getAllErrors()) &#123;</span><br><span class="line">                String msg = messageSource.getMessage(err, Locale.US);</span><br><span class="line">                <span class="keyword">return</span> msg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>User的代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Max</span>(value = <span class="number">18</span>)</span><br><span class="line">    <span class="meta">@Min</span>(value = <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>当我们请求 <code>test/en</code> 和 <code>test/cn</code>的时候就会出现不同的提示，</p><ol><li>test/en<blockquote><p>user name can not be null</p></blockquote></li><li>test/cn<blockquote><p>用户名称不能为空</p></blockquote></li></ol><p>这其中重要的实现就是 Locale.US 和 Locale.CHINA，在这里实现的话，最好是根据用户的选择语言来动态的切换实现Local的转换。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;在一个完整的项目里面，肯定是有各种各样的入参校验的，如果业务上的一些逻辑校验，可以放在 Service 层面进行，但是如果是 Control
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>java信号量的简单了解</title>
    <link href="https://somersames.github.io/2019/12/04/java%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3/"/>
    <id>https://somersames.github.io/2019/12/04/java信号量的简单了解/</id>
    <published>2019-12-03T16:20:45.000Z</published>
    <updated>2019-12-04T15:57:42.276Z</updated>
    
    <content type="html"><![CDATA[<!-- 信号量在计算机的操作系统以及并发的时候经常使用到，用于多个线程之间的通信。（待定） --><p>在Java语言里面，Semaphore 的作用是可以控制对于同一个临界资源，允许多少个线程同时执行。<br>当线程执行到临界区域的时候，需要先向 Semaphore 申请一个令牌，此时 Semaphore 会判断现有的的令牌是不是小于0，如果小于0，则阻塞当前线程，直至有线程将令牌归还回来。</p><h2 id="申请到了permits"><a href="#申请到了permits" class="headerlink" title="申请到了permits"></a>申请到了permits</h2><p>如果一个线程直接申请到了permits，则是直接通过CAS操作将 state 减一即可，然后线程继续执行。</p><h2 id="无法申请到permits"><a href="#无法申请到permits" class="headerlink" title="无法申请到permits"></a>无法申请到permits</h2><p>当无法申请到 Semaphore 的 permits 的时候，则会将当前的线程进行阻塞，直到有线程执行完毕，释放了 permit。</p><h3 id="Semaphore-的类关系"><a href="#Semaphore-的类关系" class="headerlink" title="Semaphore 的类关系"></a>Semaphore 的类关系</h3><p>那么在 <code>Semaphore</code> 里面，如果 <code>permits</code> 已经被降到0以下，按照信号量的规则，应当将当前线程阻塞，直到 <code>permits</code> 大于 0。查看 Semaphore 的类组织结构，会发现它的一些操作全部都是依赖于自己的一个 Sync 变量，此外还有两个变量用于实现公平锁和非公平锁，都是继承自 <code>Sync</code>，而 <code>Sync</code> 则是继承自 <code>AbstractQueuedSynchronizer</code> (下文简称AQS)。所以 Semaphore 的实现全部是依赖于 AQS。<br>以下为 Semaphore 的类图：<br> <img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/Semphore%E7%9A%84%E9%9D%9E%E5%85%AC%E5%B9%B3%E4%BE%9D%E8%B5%96.png" alt=""></p><!-- 在这里当获取的资源数已经成为了负数，那么首先会将上一个节点设置为`SINGLE`(-1)，这样的话，当上一个节点被释放或者被取消的话，那么它的后续节点就会运行， --><!-- AQS里面，独占锁的话是在释放锁的时候会进行通知下一个节点，但是共享锁却不是，它是在开始运行的时候就直接通知下一个节点， --><p>下面是一个例子来说明 Semaphore 是如何工作的。</p><p>如下Demo<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> no;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span> ;i&lt; <span class="number">2</span> ;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> SemaphoreTest(i)).start();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.currentThread().sleep(<span class="number">1000000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(no + <span class="string">"start"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            semaphore.acquire();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(no);</span><br><span class="line">        System.out.println(<span class="string">"semaphore"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.currentThread().sleep(<span class="number">10000</span>);</span><br><span class="line">            semaphore.release();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SemaphoreTest</span><span class="params">(<span class="keyword">int</span> no)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.no = no;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在这个例子中，首先获取到 permits 的线程会执行，而第二个线程则会被阻塞，直到 permits 被释放。这也是 Semaphore 的目的，控制有多少个线程可以同时的访问某一个资源。</p><h4 id="设置permits"><a href="#设置permits" class="headerlink" title="设置permits"></a>设置permits</h4><p>在 Semaphore 里面，直接使用 AQS 里面的<code>state</code>变量来决定允许多少个线程同时访问一个资源，通过 Semaphore 的构造函数就可以发现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Semaphore</span><span class="params">(<span class="keyword">int</span> permits)</span> </span>&#123;</span><br><span class="line">    sync = <span class="keyword">new</span> NonfairSync(permits);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2694183684443567898L</span>;</span><br><span class="line"></span><br><span class="line">    NonfairSync(<span class="keyword">int</span> permits) &#123;</span><br><span class="line">        <span class="keyword">super</span>(permits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquireShared(acquires);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>该super就是调用 Sync 的构造函数，然后调用 AQS 里面的 <code>setState方法</code>，最后设置 AQS 的 state。</p><h4 id="获取permits"><a href="#获取permits" class="headerlink" title="获取permits"></a>获取permits</h4><p>当一个线程尝试调用 acquire 方法的时候，最终会通过 NonfairSync 的 tryAcquireShared 方法，在该方法里面，会获取当前线程的 state，然后减去入参带过来的参数（默认是 1 ），最后判断是否小于 0，若大于 0 的话，则直接采用 CAS 的操作将剩余的 state 替换掉。小于 0 的话，直接返回并且会进入另一个方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">nonfairTryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> available = getState();</span><br><span class="line">        <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">        <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            <span class="keyword">return</span> remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetState</span><span class="params">(<span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// See below for intrinsics setup to support this</span></span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, stateOffset, expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>由于 state 是由 <code>volatile</code> 修饰的，所以说当一个线程原子性的修改了 state，另一个线程也会立即获取到 state 的最新状态的。<br>这个方法不是一个原子性的，但是由于 CAS 操作是原子性的，那么最终还是能保证一致性的。如下：</p><ol><li>如果一个线程在获取到了 available 恰好为 1， 准备减去 1 的时候，此时另一个线程恰好 CAS 执行完毕，将 state 更新为 0 了，此时第一个线程在执行 CAS 的时候，由于 expect 已经修改为 0 了，所以此时 CAS 操作一定不成功。</li><li>如果在 getState 之前，state 已经被修改成 0 的，那么由于 <code>remaining &lt; 0</code>，所以直接返回 remaining。</li></ol><h4 id="线程阻塞"><a href="#线程阻塞" class="headerlink" title="线程阻塞"></a>线程阻塞</h4><p>在这里先简单介绍下线程的阻塞方式：<br>首先生成一个 Node，然后再判断下队列的尾部 tail 是不是为 null，如果是的话初始化 head 和 tail，并且将当前线程的 Node 的前置节点指向 head，然后通过 CAS 操作将 tail 设置为当前线程创建的 node， 最后将 head 的后置节点指向该节点。</p><p>然后再判断前置节点是不是 head，是的话就再次尝试获取 state，若获取不到则直接将前一个节点的 waitStatus 修改为 -1（即后置节点的线程需要被唤醒）然后直接通过<code>LockSupport.park(this)</code>将其阻塞。</p><p>当 CAS 操作失败，一般都是 state 已经小于 0 了，此时就会进入 doAcquireSharedInterruptibly 方法里面，在该方法里面会使用 AQS 里面的 FIFO 队列，来实现对于临界资源的控制。</p><h5 id="详细"><a href="#详细" class="headerlink" title="详细"></a>详细</h5><p>Semaphore 首先会进行创建一个 Node，在首次阻塞某一个线程的时候，由于 tail 为null，所以会直接进入 enq 方法，在该方法里面会将 tail 和 head 都设置为一个新的 node，然后展开第二次的循环，最后在将当前线程的 node 的 prev 指向 head，通过CAS操作将 tail 指定为该node，最后将 head 的 next 指向 该node（注意这一步为非原子性的，所以会影响到后面的release方法的一个判断）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node t = tail;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>到这里，一个 FIFO 队列就生成了，此时 head 为一个node（waitStatus为0，next为被阻塞的线程），当从 addWaiter 方法返回的时候，Semaphore 还会进行一个判断，如果当前线程的前置节点是 head，就再次尝试一次获取 state，如果获取不到的话就将前置节点的 waitStatus 设置成 -1，然后通过<code>LockSupport.park(this)</code>将本线程中断，至此该线程被阻塞了。</p><p><strong>如果在判断前置节点是 head 之后，然后通过 tryAcquireShared 获取到了 state</strong> 那么此时就会调用 setHeadAndPropagate 将自己设置为头节点，同时判断是否需要唤醒后续的节点</p><h2 id="释放"><a href="#释放" class="headerlink" title="释放"></a>释放</h2><p>假如一个线程执行完毕之后，是会调用 release 方法来释放资源的，首先还是以 CAS 操作原子性的增加 state，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> current = getState();</span><br><span class="line">        <span class="keyword">int</span> next = current + releases;</span><br><span class="line">        <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum permit count exceeded"</span>);</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReleaseShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Ensure that a release propagates, even if there are other</span></span><br><span class="line"><span class="comment">        * in-progress acquires/releases.  This proceeds in the usual</span></span><br><span class="line"><span class="comment">        * way of trying to unparkSuccessor of head if it needs</span></span><br><span class="line"><span class="comment">        * signal. But if it does not, status is set to PROPAGATE to</span></span><br><span class="line"><span class="comment">        * ensure that upon release, propagation continues.</span></span><br><span class="line"><span class="comment">        * Additionally, we must loop in case a new node is added</span></span><br><span class="line"><span class="comment">        * while we are doing this. Also, unlike other uses of</span></span><br><span class="line"><span class="comment">        * unparkSuccessor, we need to know if CAS to reset status</span></span><br><span class="line"><span class="comment">        * fails, if so rechecking.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="keyword">int</span> ws = h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;            <span class="comment">// loop to recheck cases</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;                <span class="comment">// loop on failed CAS</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h == head)                   <span class="comment">// loop if head changed</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">        * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">        * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">        * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">        * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">        * non-cancelled successor.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>当 CAS 操作成功之后返回 true，然后调用 doReleaseShared 方法，在该方法里面，会首先将 head 的状态更改为 0，然后然后通过 unparkSuccessor 来唤醒后面的线程，在这里需要注意的是那一个 for 循环里面的代码。</p><h3 id="为什么for循环的时候需要从尾节点开始"><a href="#为什么for循环的时候需要从尾节点开始" class="headerlink" title="为什么for循环的时候需要从尾节点开始"></a>为什么for循环的时候需要从尾节点开始</h3><p>在这里其实是由于前面在设置尾节点的时候 CAS 虽然是一个原子性操作，但是在 CAS 操作之后，紧跟着 <code>pred.next = node</code> 这一步为非原子性的，所以就导致了有可能从头遍历的时候会断开掉，所以此时就需要从尾节点开始，因为这样一定不会断开的，也是最有保证的。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- 信号量在计算机的操作系统以及并发的时候经常使用到，用于多个线程之间的通信。（待定） --&gt;
&lt;p&gt;在Java语言里面，Semaphore 的作用是可以控制对于同一个临界资源，允许多少个线程同时执行。&lt;br&gt;当线程执行到临界区域的时候，需要先向 Semaphore 申请一
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Java8中的流式简单总结</title>
    <link href="https://somersames.github.io/2019/11/22/Java8%E4%B8%AD%E7%9A%84%E6%B5%81%E5%BC%8F%E7%AE%80%E5%8D%95%E6%80%BB%E7%BB%93/"/>
    <id>https://somersames.github.io/2019/11/22/Java8中的流式简单总结/</id>
    <published>2019-11-21T16:03:01.000Z</published>
    <updated>2019-11-21T16:16:13.769Z</updated>
    
    <content type="html"><![CDATA[<p>在大量使用Java8中的流式操作之后，觉得用起来还挺舒服的，所以正好趁这个机会总结下。</p><p>使用Java8的lambda表达式的时候，需要先把集合转为一种流，也就是调用 stream 方法，但是 stream 却是 Collection 类里面的一个方法，也就是只有 Collection 的子类才可以使用，所以 Map 集合是使用不了的，同理，对于数组，可以通过<code>Arrays.stream()</code> 方法来讲数组转为一个Stream，这样也可以使用Stream里面的方法了，</p><h2 id="将集合转为流"><a href="#将集合转为流" class="headerlink" title="将集合转为流"></a>将集合转为流</h2><p>下面介绍几个很常用的方法来介绍流式操作的便捷性。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stringList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">stringList.add(<span class="string">"a1"</span>);</span><br><span class="line">stringList.add(<span class="string">"b1"</span>);</span><br><span class="line">stringList.add(<span class="string">"a2"</span>);</span><br><span class="line">stringList.add(<span class="string">"b2"</span>);</span><br><span class="line">stringList.stream();</span><br></pre></td></tr></table></figure><p>这样我们就可以得到了一个流式操作，接下来就可以使用Stream里面定义好的方法了</p><h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>该方法用于过滤我们设置的一些判断条件，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">streamFilter</span><span class="params">(List&lt;String&gt; list)</span></span>&#123;</span><br><span class="line">        List&lt;String&gt; result = list.stream().filter(item -&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"a"</span>.equals(item))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这个只是一个普通的String数组遍历，可以看到如果我们通过Java8之前的代码写的话，会首先 new一个List，然后通过add方法来进行插入，这样虽然不会出现什么问题，但是会显得不是那么整洁，但是用流式操作的话，感觉会方便不少。</p><p>如果我们有多个条件要进行过滤的话，filter也是支持链式调用的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">streamFilter</span><span class="params">(List&lt;String&gt; list)</span></span>&#123;</span><br><span class="line">        List&lt;String&gt; result = list.stream().filter(item -&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">"a1"</span>.equals(item))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">        .filter(item -&gt; (item.startsWith(<span class="string">"a"</span>)))</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">        result.stream().forEach(item -&gt; System.out.println(item));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>map常用于一些遍历条件，例如取出某些JavaBean的属性并作为集合。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将一个Person集合的所有姓名取出：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//取出集合内所有的姓名</span></span><br><span class="line">List&lt;String&gt; nameList = list.stream().map(Person::getName).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="comment">//去重取出集合内所有的姓名</span></span><br><span class="line">List&lt;String&gt; nameDistinctList = list.stream().map(Person::getName).distinct().collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="comment">//找出所有成年的人</span></span><br><span class="line">List&lt;String&gt; ageList = list.stream().filter(</span><br><span class="line">                item -&gt; (Objects.nonNull(item.getAge()) &amp;&amp; item.getAge() &gt; <span class="number">18</span>)</span><br><span class="line">        ).map(Person::getName).distinct().collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="comment">//将所有已经成年的人按照年龄进行分组</span></span><br><span class="line">Map&lt;Integer, List&lt;Person&gt;&gt; ageSameList = list.stream().filter(</span><br><span class="line">                item -&gt; (Objects.nonNull(item.getAge()) &amp;&amp; item.getAge() &gt; <span class="number">18</span>)</span><br><span class="line">        ).collect(Collectors.groupingBy(Person::getAge));</span><br></pre></td></tr></table></figure><h3 id="findFirst"><a href="#findFirst" class="headerlink" title="findFirst"></a>findFirst</h3><p>在我的使用过程中，感觉这个方法配合枚举类相当的好用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ProvinceEnum &#123;</span><br><span class="line">    BEIJING(<span class="string">"北京市"</span>,<span class="string">"110000"</span>),</span><br><span class="line">    TIANJIN(<span class="string">"天津市"</span>,<span class="string">"120000"</span>),</span><br><span class="line">    HEBEI(<span class="string">"河北省"</span>,<span class="string">"130000"</span>),</span><br><span class="line">    SHANXI(<span class="string">"山西省"</span>,<span class="string">"140000"</span>),</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">private</span> String cn;</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    ProvinceEnum(String cn, String code) &#123;</span><br><span class="line">        <span class="keyword">this</span>.cn = cn;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCnByCode</span><span class="params">(String code)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(ProvinceEnum.values()).filter(</span><br><span class="line">                item -&gt; (StringUtils.isNotEmpty(item) &amp;&amp; item.getCn().equals(code))</span><br><span class="line">        ).map(ProvinceEnum::getCn).findFirst().orElse(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 由于其他的方法大致与这上面几个方法相似，所以就不再写demo了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在大量使用Java8中的流式操作之后，觉得用起来还挺舒服的，所以正好趁这个机会总结下。&lt;/p&gt;
&lt;p&gt;使用Java8的lambda表达式的时候，需要先把集合转为一种流，也就是调用 stream 方法，但是 stream 却是 Collection 类里面的一个方法，也就是只
      
    
    </summary>
    
      <category term="Java" scheme="https://somersames.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://somersames.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JDK1.7中的ConcurrentHashMap实现细节(二)</title>
    <link href="https://somersames.github.io/2019/09/15/JDK1-7%E4%B8%AD%E7%9A%84ConcurrentHashMap%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/"/>
    <id>https://somersames.github.io/2019/09/15/JDK1-7中的ConcurrentHashMap实现细节/</id>
    <published>2019-09-15T12:35:02.000Z</published>
    <updated>2019-09-15T12:48:37.657Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在JDK1.7向JDK1.8升级的过程中，<code>ConcurrentHashMap</code>由原来的可重入锁和<code>CAS</code>锁直接被替换为<code>synchronized</code>关键字了，虽然说在功能上都是完全一致的，但是在这里一直都有一个疑惑，既然在1.7的使用过程中没什么问题，那到底是出于什么原因要将其替换呢。</p><h2 id="JDK1-7中的ConcurrentHashMap"><a href="#JDK1-7中的ConcurrentHashMap" class="headerlink" title="JDK1.7中的ConcurrentHashMap"></a>JDK1.7中的ConcurrentHashMap</h2><p>在JDK1.7中，其结构是由一个可重入锁<code>Segment</code>数组和每一个节点下的<code>HashEntry</code>数组来实现的。结构图如下:<br><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/1.7ConcurrentHashMap.png" alt=""></p><p>由于 segment 是一个锁，所以如果在并发的过程中，多个线程尝试向一个 segment 中的 HashEntry 进行插入的时候，只能有一个线程会获取到锁，其他的线程会被阻塞直至锁被释放，所以这个容器是一个并发安全的。</p><!--那么为什么是一个可重入锁呢，--><p>查看 put 方法的调用链的时候，可以发现最终都是调用的是<code>Segment</code>的<code>put</code>方法。</p><p><code>segment</code> 类在 <code>ConCurrentHashMap</code> 中的变量是以一个数组的形式所存在的，由于<code>segment</code>继承了 ReentrantLock ，所以是它也是一个可重入锁，因此在<code>JDK1.7</code>里面，是通过 <code>segment</code>的 重入锁机制来实现并发的写入。同时也可以发现如果调用的是<code>ConcurrentHashMap</code>的无参构造函数的话，那么初始化<code>Segment</code>数组大小就是16，当然这个数组大小其实是可以被调整的，但是无论怎样进行调整，最终 segment 数组的大小永远都是2的n次方。</p><h2 id="Segment"><a href="#Segment" class="headerlink" title="Segment"></a>Segment</h2><p>在<code>ConcurrentHashMap</code>里面，一个<code>segment</code>就是一个<code>HashEntry</code>的数组，而一个<code>HashEntry</code>就是一个<code>bucket</code>。</p><blockquote><p>但是需要注意的是，ConcurrentHashMap 默认的 segment 数组的大小是16，也就是说最多只可能有16个线程同时进行处理</p></blockquote><p>当调用 put 方法的时候，会通过一个可重入锁的 CAS 操作来尝试获取该 segment 锁，如果获取到了则直接新建一个 Node 节点，如果还未获取到则直接调用<code>scanAndLockForPut</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> HashEntry&lt;K,V&gt; <span class="title">scanAndLockForPut</span><span class="params">(K key, <span class="keyword">int</span> hash, V value)</span> </span>&#123;</span><br><span class="line">    HashEntry&lt;K,V&gt; first = entryForHash(<span class="keyword">this</span>, hash);</span><br><span class="line">    HashEntry&lt;K,V&gt; e = first;</span><br><span class="line">    HashEntry&lt;K,V&gt; node = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> retries = -<span class="number">1</span>; <span class="comment">// negative while locating node</span></span><br><span class="line">    <span class="keyword">while</span> (!tryLock()) &#123;</span><br><span class="line">        HashEntry&lt;K,V&gt; f; <span class="comment">// to recheck first below</span></span><br><span class="line">        <span class="keyword">if</span> (retries &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node == <span class="keyword">null</span>) <span class="comment">// speculatively create node</span></span><br><span class="line">                    node = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                retries = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(e.key))</span><br><span class="line">                retries = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                e = e.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (++retries &gt; MAX_SCAN_RETRIES) &#123;</span><br><span class="line">            lock();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((retries &amp; <span class="number">1</span>) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                 (f = entryForHash(<span class="keyword">this</span>, hash)) != first) &#123;</span><br><span class="line">            e = first = f; <span class="comment">// re-traverse if entry changed</span></span><br><span class="line">            retries = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="scanAndLockForPut方法的作用"><a href="#scanAndLockForPut方法的作用" class="headerlink" title="scanAndLockForPut方法的作用"></a>scanAndLockForPut方法的作用</h3><p>在这个方法里面，会在 while 循环里面尝试 64 次，而且可以看到在这个循环语句里面有一些细节的操作。具体如下：</p><ul><li>判断当前头节点 first 是否为 null，是的话则初始化 node </li><li>如果 first 不是 null，判断当前的 key 是否和 first 相等</li><li>如果 first 即不为null，并且当前的 key 又不和入参的key相同，则直接寻找其 next 节点，直至 next 为null，然后进行第一步</li></ul><p>其实上面的一些步骤仅仅是该方法循环的第一步要做的，当上述三个步骤都进行完毕之后，首先会判断循环的次数是否已经大于 <code>MAX_SCAN_RETRIES</code> 如果是的话，则直接调用 <code>lock</code> 方法，如果不是的话则调用第三个判断。</p><p>第三个判断中会判断当前循环次数是不是偶数，如果是的话则会判断当前的头节点还是不是之前的first，如果不是的话则需要重新将新的头节点赋值给 first 然后将循环次数改成1，再次重试。</p><p>其实这个方法如果仔细看看，你会发现貌似没啥作用，因为返回的是 node，但是 node 一旦第一次被赋值之后，以后便不会做任何的更改，所以正如该方法的注释所说的一样，<strong>这个方法仅仅是为 JVM 做一个预热而已</strong>。</p><h3 id="继续获取锁"><a href="#继续获取锁" class="headerlink" title="继续获取锁"></a>继续获取锁</h3><p>如果在 64 次以内还是未获取到该锁，则会调用<code>lock</code>方法，由于 ConcurrentHashMap 在初始化 segment 的时候，并未显式调用<code>ReentrantLock</code>的构造方法，而 ReentrantLock 又是默认初始化非公平锁，所以此时在 scanAndLockForPut 里面的 lock 其实调用的是 NonfairSync 里面的 lock 方法，即再次以非公平锁的方式来尝试获取锁<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>当最后一次如果 CAS 操作还未获取到锁的时候，segment 就会调用<strong>acquire(1)</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在这里可以看到的是 if 判断里面还是会再次尝试获取锁，当还未获取到锁的时候，就将该 Node 放入到 FIFO 队列的末尾，然后等待着被唤醒执行</p><p>从上面的一个流程不难看出，在 segment 首先会以可重入锁的方式来尝试性的获取锁，当没取到的时候会<strong>while循环</strong>64次做一个预热，如果在循环的过程中还是未获取到锁，则会进行两次<code>CAS</code>操作(分别在两个不同的方法里面)，如果最终还是无法获取到锁的话，那么此时就会将自己放入到 AQS 中的 FIFO 队列。</p><p>回过头来再看 segment 里面的第一行代码：</p><blockquote><p>HashEntry&lt;K,V&gt; node = tryLock() ? null : scanAndLockForPut(key, hash, value);</p></blockquote><p>那么可以看到的是，在JDK1.7里面，put方法如果在大量并发的情况下，如果要获取一个锁会进行非常多的操作，而且它默认的 segment 数组大小还是 16 ，也就是说map的所有键值，出现碰撞的概率不是 1/map.size()，而永远是 1/16。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;在JDK1.7向JDK1.8升级的过程中，&lt;code&gt;ConcurrentHashMap&lt;/code&gt;由原来的可重入锁和&lt;code&gt;CAS&lt;
      
    
    </summary>
    
      <category term="Java" scheme="https://somersames.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://somersames.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Leetcode数组中连续分组</title>
    <link href="https://somersames.github.io/2019/09/08/Leetcode%E6%95%B0%E7%BB%84%E4%B8%AD%E8%BF%9E%E7%BB%AD%E5%88%86%E7%BB%84/"/>
    <id>https://somersames.github.io/2019/09/08/Leetcode数组中连续分组/</id>
    <published>2019-09-08T15:19:58.000Z</published>
    <updated>2019-09-08T15:35:54.872Z</updated>
    
    <content type="html"><![CDATA[<p>在Leetcode上有一道题目，如下：</p><blockquote><p>In a deck of cards, each card has an integer written on it.<br>  Return true if and only if you can choose X &gt;= 2 such that it is possible to split the entire deck into 1 or more groups of cards, where:<br>  Each group has exactly X cards.<br>  All the cards in each group have the same integer.</p></blockquote><p>这一题就是一个求最大公约数的题目，当任意两组的公约数为1的时候，那么此时就说明，他们的分组数量不相等就可以直接返回false了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasGroupsSizeX</span><span class="params">(<span class="keyword">int</span>[] deck)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] count = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10000</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> val : deck)&#123;</span><br><span class="line">            count[val]++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> sum = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> val: deck)&#123;</span><br><span class="line">            <span class="keyword">if</span>(sum == -<span class="number">1</span>)&#123;</span><br><span class="line">                sum = count[val];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sum = getGcd(sum,count[val]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(sum == <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在Leetcode上有一道题目，如下：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In a deck of cards, each card has an integer written on it.&lt;br&gt;  Return true if and only if you c
      
    
    </summary>
    
      <category term="算法" scheme="https://somersames.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="leetcode" scheme="https://somersames.github.io/tags/leetcode/"/>
    
  </entry>
  
  <entry>
    <title>mysql的幻读(二)</title>
    <link href="https://somersames.github.io/2019/08/27/mysql%E7%9A%84%E5%B9%BB%E8%AF%BB-%E4%BA%8C/"/>
    <id>https://somersames.github.io/2019/08/27/mysql的幻读-二/</id>
    <published>2019-08-27T15:48:53.000Z</published>
    <updated>2019-08-27T16:06:02.829Z</updated>
    
    <content type="html"><![CDATA[<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>在InnoDB里面，是通过快照读来实现<code>RC</code>和<code>PR</code>隔离级别的区分，因为在<code>RC</code>隔离级别下，每一次的select都是一个快照读，所以是可以读取到已经提交的数据，从而导致幻读。所以在<code>RC</code>隔离级别下，快照读和当前读都是可以出现幻读。</p><p>但是在<code>PR</code>的隔离级别下，由于快照读仅仅只生成一次，所以在<code>PR</code>级别下的快照读是无法出现幻读的，但是当前读确实可以出现幻读。</p><p>查看Mysql官方对于<code>幻读</code>的定义。</p><blockquote><p>The so-called phantom problem occurs within a transaction when the same query produces different sets of rows at different times. </p></blockquote><p>也就是说一个事物同一条查询语句查询出来了两个不同的集合就可以称之为幻读。</p><h3 id="ANSI-SQL-隔离级别"><a href="#ANSI-SQL-隔离级别" class="headerlink" title="ANSI SQL 隔离级别"></a>ANSI SQL 隔离级别</h3><p>在<code>ANSI SQL 隔离级别</code>的定义中<code>PR</code>级别是可以出现幻读的。<br>但是在InnoDB引擎里面自己通过<code>GAP锁</code>和<code>Next-Key锁</code>使得<code>PR</code>隔离级别下无法出现幻读。原因就在于InnoDB的<code>GAP</code>锁</p><h2 id="GAP锁"><a href="#GAP锁" class="headerlink" title="GAP锁"></a>GAP锁</h2><p>在<code>InnoDB</code>里面，GAP锁是用于防止幻读的一个手段，具体的操作是首先当我们新增一个数据的时候，<code>InnoDB</code>会在此时加一个<code>GAP</code>锁从而防止其他事务对该区间的一些数据操作，导致幻读的出现。</p><h3 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h3><h4 id="PR级别："><a href="#PR级别：" class="headerlink" title="PR级别："></a><code>PR</code>级别：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from test_lock.test;</span><br><span class="line">+---------+-----------+----------------+------------+-------------+</span><br><span class="line">| user_id | user_name | user_password  | is_deleted | phone       |</span><br><span class="line">+---------+-----------+----------------+------------+-------------+</span><br><span class="line">| a       | zhangsan  | 123456         |          0 | 15112345678 |</span><br><span class="line">| b       | lisi      | lisi123456     |          0 | 15112345678 |</span><br><span class="line">| c       | wangwu    | wangwu123456   |          0 | 15112345678 |</span><br><span class="line">| d       | caocao    | caocao123456   |          0 | 15112345678 |</span><br><span class="line">| e       | liubei    | liubei123456   |          0 | 15112345678 |</span><br><span class="line">| f       | zhangfei  | zhangfei123456 |          0 | 15112345678 |</span><br><span class="line">| g       | guanyu    | guanyu123456   |          0 | 15112345678 |</span><br><span class="line">| h       | daqiao    | daqiao123456   |          0 | 15112345678 |</span><br><span class="line">| m       | xiaoqiao  | xiaoqiao123456 |          0 | 15112345678 |</span><br><span class="line">+---------+-----------+----------------+------------+-------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><em>事物一</em>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test_lock.test where  user_id &gt; &apos;g&apos; and user_id &lt; &apos;m&apos; for update ;</span><br><span class="line">+---------+-----------+---------------+------------+-------------+</span><br><span class="line">| user_id | user_name | user_password | is_deleted | phone       |</span><br><span class="line">+---------+-----------+---------------+------------+-------------+</span><br><span class="line">| h       | daqiao    | daqiao123456  |          0 | 15112345678 |</span><br><span class="line">+---------+-----------+---------------+------------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><em>事物二</em>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test_lock.`test` values(&apos;i&apos;,&apos;daqiao&apos;,&apos;daqiao123456&apos;,0,&apos;15112345678&apos;);</span><br></pre></td></tr></table></figure></p><p>此时在<code>PR</code>隔离级别下会阻塞。</p><p>此时查看数据库中的锁：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ysql&gt; select * from performance_schema.data_locks;</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+</span><br><span class="line">| ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE              | LOCK_STATUS | LOCK_DATA |</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+</span><br><span class="line">| INNODB | 140169161014704:1068:140169076344152   |                235275 |        50 |       16 | test_lock     | test        | NULL           | NULL              | NULL       |       140169076344152 | TABLE     | IX                     | GRANTED     | NULL      |</span><br><span class="line">| INNODB | 140169161014704:7:4:14:140169076341272 |                235275 |        50 |       16 | test_lock     | test        | NULL           | NULL              | PRIMARY    |       140169076341272 | RECORD    | X,GAP,INSERT_INTENTION | WAITING     | &apos;m&apos;       |</span><br><span class="line">| INNODB | 140169161013840:1068:140169076338200   |                235274 |        47 |       20 | test_lock     | test        | NULL           | NULL              | NULL       |       140169076338200 | TABLE     | IX                     | GRANTED     | NULL      |</span><br><span class="line">| INNODB | 140169161013840:7:4:14:140169076335256 |                235274 |        47 |       20 | test_lock     | test        | NULL           | NULL              | PRIMARY    |       140169076335256 | RECORD    | X                      | GRANTED     | &apos;m&apos;       |</span><br><span class="line">| INNODB | 140169161013840:7:4:15:140169076335256 |                235274 |        47 |       20 | test_lock     | test        | NULL           | NULL              | PRIMARY    |       140169076335256 | RECORD    | X                      | GRANTED     | &apos;h&apos;       |</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+------------------------+-------------+-----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>可以看到在<code>m</code>列由于<code>GAP</code>锁和<code>INSERT_INTENTION</code>互相冲突，导致<code>事物二</code>无法进行插入</p><blockquote><p>事物一由于进行<code>for update</code>查询，所以会对区间加一个GAP锁<br>事物二由于是新增，所以会加一个插入意向锁<br>由于<code>GAP</code>锁阻塞住了插入意向锁，导致<code>事物二</code>无法进行插入</p></blockquote><p>此时<code>事物二</code>也会在这里阻塞住，而在<code>RC</code>隔离级别下，<code>事物二</code>是不会等待的。<br>但是如果仔细一点，其实这里还可以发现另一个锁，就是插入意向锁<code>INSERT_INTENTION LOCK</code></p><h2 id="INSERT-INTENTION-LOCK"><a href="#INSERT-INTENTION-LOCK" class="headerlink" title="INSERT_INTENTION_LOCK"></a>INSERT_INTENTION_LOCK</h2><p>Mysql官方文档中将<code>INSERT_INTENTION</code>定义为一个<code>GAP</code>锁，但是它的意义和真正的<code>GAP</code>锁之间是有天大的差别的，<code>INSERT_INTENTION_LOCK</code>并不会阻塞<code>GAP</code>锁，但相反<code>GAP</code>会阻塞<code>INSERT_INTENTION_LOCK</code>，并且该锁的锁定范围是插入行一直到下一个索引，这一整个区间<br>如下例子：<br><em>事物一</em>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test_lock.`test` values(&apos;i&apos;,&apos;daqiao&apos;,&apos;daqiao123456&apos;,0,&apos;15112345678&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><em>事物二</em>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_lock.`test` set user_id=&apos;l&apos;  where  user_id = &apos;k&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 0  Changed: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p><p>此时查看事物中锁：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance_schema.data_locks;</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+</span><br><span class="line">| ENGINE | ENGINE_LOCK_ID                         | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+</span><br><span class="line">| INNODB | 140169161014704:1068:140169076344152   |                235293 |        50 |       48 | test_lock     | test        | NULL           | NULL              | NULL       |       140169076344152 | TABLE     | IX        | GRANTED     | NULL      |</span><br><span class="line">| INNODB | 140169161014704:7:4:14:140169076341272 |                235293 |        50 |       48 | test_lock     | test        | NULL           | NULL              | PRIMARY    |       140169076341272 | RECORD    | X,GAP     | GRANTED     | &apos;m&apos;       |</span><br><span class="line">| INNODB | 140169161013840:1068:140169076338200   |                235288 |        47 |       32 | test_lock     | test        | NULL           | NULL              | NULL       |       140169076338200 | TABLE     | IX        | GRANTED     | NULL      |</span><br><span class="line">+--------+----------------------------------------+-----------------------+-----------+----------+---------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>可以看到<code>事物二</code>确实已经执行成功了，而且<code>事物一</code>的插入意向锁并未阻塞事物二的插入语句<br>。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在Mysql的<code>InnoDB</code>中，幻读的解决方案是采用了一个间隙锁<code>GAP</code>锁来实现的</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;定义&quot;&gt;&lt;a href=&quot;#定义&quot; class=&quot;headerlink&quot; title=&quot;定义&quot;&gt;&lt;/a&gt;定义&lt;/h2&gt;&lt;p&gt;在InnoDB里面，是通过快照读来实现&lt;code&gt;RC&lt;/code&gt;和&lt;code&gt;PR&lt;/code&gt;隔离级别的区分，因为在&lt;code&gt;RC&lt;
      
    
    </summary>
    
      <category term="Mysql" scheme="https://somersames.github.io/categories/Mysql/"/>
    
    
      <category term="Mysql" scheme="https://somersames.github.io/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>Mysql中的幻读(一)</title>
    <link href="https://somersames.github.io/2019/08/18/Mysql%E4%B8%AD%E7%9A%84%E5%B9%BB%E8%AF%BB-%E4%B8%80/"/>
    <id>https://somersames.github.io/2019/08/18/Mysql中的幻读-一/</id>
    <published>2019-08-18T12:41:54.000Z</published>
    <updated>2019-08-18T13:53:34.790Z</updated>
    
    <content type="html"><![CDATA[<h2 id="什么是幻读"><a href="#什么是幻读" class="headerlink" title="什么是幻读"></a>什么是幻读</h2><p>幻读表示的是在一个事物里面 同一个<code>select</code>语句，前后两次查询出来的结果是不相同的，需要注意的一点是，在InnoDB里面，幻读跟事物的隔离级别有关，更加准确的说是跟一个事物的快照和当前读有关</p><p>下面是在Mysql8.0.11版本下进行幻读的复现：</p><ul><li>引擎：InnoDB</li><li>事物隔离级别：Read Commited</li></ul><h3 id="MVCC和快照读以及当前读"><a href="#MVCC和快照读以及当前读" class="headerlink" title="MVCC和快照读以及当前读"></a>MVCC和快照读以及当前读</h3><h4 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h4><p>在介绍MVCC之前先来介绍下MVCC为什么会出现，首先数据库作为一个数据存储工具，那么肯定是存在并发的情况，<br>在Mysql的InnoDB里面最常见的就是<code>x</code>锁，这是一种写锁，在并发的情况下只有一个事务会获取该锁，其他事务则会一直等待直至获取到该锁。</p><p>那么在读取的时候如何保证并发的事物都能正确的读取到自己正确的数据呢？</p><p>在MVCC的概念里面，如果事务的隔离级别是<code>Read Commited</code>的话，那么每一次的快照都都会读取该行的最近一次<code>commited</code>数据，而如果是<code>Repeatable Read</code>的话，则是会读取当前事务ID开始之前的一次<code>commited</code>数据。</p><p>所以MVCC仅仅是作为一个保证数据库并发读情况下的一个数据正确的手段而已，在不同的数据库里面，有不同的实现，例如在<code>OceanBase</code>里面，是通过操作链来解决并发读的问题</p><h4 id="快照读"><a href="#快照读" class="headerlink" title="快照读"></a>快照读</h4><p>快照读是利用MVCC和 <code>undo log</code> 来实现的，其主要作用就是当我们对某行数据修改之后，并不会将原值修改，而是在上一个版本上面再新建一个版本(修改InnoDB的隐藏两列)。<br>所以在不同的隔离级别下，可以根据自己的<code>事物ID</code>来获取自己所需要的数据。当第一条不满足的时候，会沿着<code>undo log</code>一直寻找，在<code>Read Commited</code>隔离级别下就是直接找出该行数据最后一次提交的版本</p><h4 id="当前读"><a href="#当前读" class="headerlink" title="当前读"></a>当前读</h4><p>当前读是对数据的加锁读取，读取的都是最新的数据，例如如下SQL：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select ... for update</span><br><span class="line">select ... in share mode</span><br><span class="line">insert</span><br><span class="line">update</span><br><span class="line">delete</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>同时也需要注意的一点是，当前读会对涉及到的行都进行加锁</p><h4 id="为什么会有当前读和快找读"><a href="#为什么会有当前读和快找读" class="headerlink" title="为什么会有当前读和快找读"></a>为什么会有当前读和快找读</h4><p>按照Mysql官方的解释，当前读是为了防止其他事物修改你即将进行的操作</p><blockquote><p>If you query data and then insert or update related data within the same transaction, the regular SELECT statement does not give enough protection. Other transactions can update or delete the same rows you just queried. InnoDB supports two types of locking reads that offer extra safety</p></blockquote><h3 id="幻读发生的条件"><a href="#幻读发生的条件" class="headerlink" title="幻读发生的条件"></a>幻读发生的条件</h3><p>首先解释下Mysql官方对于幻读的解释：</p><blockquote><p>The so-called phantom problem occurs within a transaction when the same query produces different sets of rows at different times. For example, if a SELECT is executed twice, but returns a row the second time that was not returned the first time, the row is a “phantom” row.</p></blockquote><p>这里Mysql官方虽然只是给出了对于<code>幻行</code>的定义，但是仍然可以简单解释下，也就是说两次的<code>select</code>前后得到的结果集是不同的，那么新多出来的一行就可以称之为<code>幻行</code></p><p><strong>在这里特别需要注意的是，在PR隔离界别下，只有当前读才会出现幻读</strong></p><h4 id="Read-Commited"><a href="#Read-Commited" class="headerlink" title="Read Commited"></a>Read Commited</h4><p>在<code>Read Commited</code>隔离级别下，每一次的<code>select</code> 都是一次快照读，所以在该隔离级别下，幻读可以在快照读和当前读发生。</p><blockquote><p>事务一<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set session transaction isolation level read committed;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START TRANSACTION;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from szh.t1</span><br><span class="line">    -&gt; ;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from `szh`.`t1`;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>事务二<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `szh`.`t1`(`area_id`, `order_num`) VALUES (3, 22);</span><br></pre></td></tr></table></figure></p></blockquote><p>此时<code>事务一</code>再进行select<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from `szh`.`t1`;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">|       3 |        22 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>于是幻读发生了</p><h4 id="Repeatable-Read"><a href="#Repeatable-Read" class="headerlink" title="Repeatable Read"></a>Repeatable Read</h4><p>那么如果在<code>Repeatable Read</code>隔离级别下，上面的SQL在执行一遍会出现什么情况呢？</p><blockquote><p>事务一<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START TRANSACTION;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `t1`</span><br><span class="line">    -&gt; ;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">|       3 |        22 |</span><br><span class="line">|       4 |        33 |</span><br><span class="line">|       5 |        55 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>事务二<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `szh`.`t1`(`area_id`, `order_num`) VALUES (6, 66);</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>事务一再次select<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM `t1`;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">|       3 |        22 |</span><br><span class="line">|       4 |        33 |</span><br><span class="line">|       5 |        55 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></blockquote><p>可以看到的是在快照读下面，是没有幻读出现的，那么修改select为当前读呢？<br>在事务一里面再次执行以下SQL<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM `t1` for update;</span><br><span class="line">+---------+-----------+</span><br><span class="line">| area_id | order_num |</span><br><span class="line">+---------+-----------+</span><br><span class="line">|       1 |        22 |</span><br><span class="line">|       2 |        10 |</span><br><span class="line">|       3 |        22 |</span><br><span class="line">|       4 |        33 |</span><br><span class="line">|       5 |        55 |</span><br><span class="line">|       6 |        66 |</span><br><span class="line">+---------+-----------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>可以看到确实出现了两次的select不同的情况。<br>所以需要强调一点的是，在<code>Repeatable Read</code>隔离级别下，只有当前读才会出现幻读，因为在该级别下，快照读是从<code>begin</code>开始的第一个普通<code>select</code>建立的<code>Read View</code>，以后的普通<code>select</code>都是基于第一次的<code>select</code>，自然而然不会出现幻读了 </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;什么是幻读&quot;&gt;&lt;a href=&quot;#什么是幻读&quot; class=&quot;headerlink&quot; title=&quot;什么是幻读&quot;&gt;&lt;/a&gt;什么是幻读&lt;/h2&gt;&lt;p&gt;幻读表示的是在一个事物里面 同一个&lt;code&gt;select&lt;/code&gt;语句，前后两次查询出来的结果是不相同的，需要
      
    
    </summary>
    
      <category term="Mysql" scheme="https://somersames.github.io/categories/Mysql/"/>
    
    
      <category term="Mysql" scheme="https://somersames.github.io/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>Mysql数据库出现死锁的情况(一)</title>
    <link href="https://somersames.github.io/2019/08/04/Mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%BA%E7%8E%B0%E6%AD%BB%E9%94%81%E7%9A%84%E6%83%85%E5%86%B5-%E4%B8%80/"/>
    <id>https://somersames.github.io/2019/08/04/Mysql数据库出现死锁的情况-一/</id>
    <published>2019-08-04T08:32:31.000Z</published>
    <updated>2019-08-04T08:49:05.600Z</updated>
    
    <content type="html"><![CDATA[<p>在临近上线之前，我们系统做了一次压力测试，发现有一个接口在高并发情况下会出现一个死锁的情况。。首先申明…不是我写的，我只是帮忙排查下。</p><p>随着对Mysql锁的深入了解，于是就准备写几篇文章来记录下Mysql各种事物和索引的情况下出现死锁的情况。</p><p>今天就介绍下在并发插入的情况下，哪几种情况会出现死锁：</p><h2 id="INNODB下的各种锁"><a href="#INNODB下的各种锁" class="headerlink" title="INNODB下的各种锁"></a>INNODB下的各种锁</h2><p>在介绍锁的时候只会介绍跟本节相关的锁，而且只会讲述大概是什么，至于锁的更加详细的讲解可能会到以后再详细介绍。</p><h3 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h3><p>行锁分为写锁和读取锁，</p><blockquote><p>读锁（S锁）也可以称之为 <code>共享锁</code> ， 它表示的是任何一个事物都可以读取该行数据(可以被多个事物获取到)。</p></blockquote><blockquote><p>写锁（X锁）也可以称之为排它锁，它表示的是该行数据不允许任何人进行修改，同时也不允许任何事物获取该行事物的S锁，但是普通的 <code>select</code> 语句是可以的。</p></blockquote><h2 id="背景信息一"><a href="#背景信息一" class="headerlink" title="背景信息一"></a>背景信息一</h2><h3 id="注意：以下测试都是基于该事物隔离级别和数据库版本"><a href="#注意：以下测试都是基于该事物隔离级别和数据库版本" class="headerlink" title="注意：以下测试都是基于该事物隔离级别和数据库版本"></a>注意：以下测试都是基于该事物隔离级别和数据库版本</h3><p>数据库版本：8.0.11</p><p>事务隔离级别：REPEATABLE-READ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE 'transaction_isolation';</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line">| Variable_name         | Value           |</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line">| transaction_isolation | REPEATABLE-READ |</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h2 id="SQL准备"><a href="#SQL准备" class="headerlink" title="SQL准备:"></a>SQL准备:</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> test_lock  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_lock.<span class="string">`test`</span> (</span><br><span class="line">    <span class="string">`user_id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`user_name`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`user_password`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`is_deleted`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`phone`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`user_id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`t1_god`</span> (<span class="string">`user_name`</span>,<span class="string">`user_password`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure><p>准备数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'a'</span>,<span class="string">'zhangsan'</span>,<span class="string">'123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'b'</span>,<span class="string">'lisi'</span>,<span class="string">'lisi123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'c'</span>,<span class="string">'wangwu'</span>,<span class="string">'wangwu123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'d'</span>,<span class="string">'caocao'</span>,<span class="string">'caocao123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'e'</span>,<span class="string">'liubei'</span>,<span class="string">'liubei123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'f'</span>,<span class="string">'zhangfei'</span>,<span class="string">'zhangfei123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'g'</span>,<span class="string">'guanyu'</span>,<span class="string">'guanyu123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'h'</span>,<span class="string">'xiaoqiao'</span>,<span class="string">'xiaoqiao123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br></pre></td></tr></table></figure><h3 id="情况一："><a href="#情况一：" class="headerlink" title="情况一："></a>情况一：</h3><blockquote><p> 三个事物都执行同一个Insert语句，第一个事物然后回滚</p></blockquote><p>此时第三个事物会提示死锁，第二个事物正常插入。</p><h4 id="复现步骤："><a href="#复现步骤：" class="headerlink" title="复现步骤："></a>复现步骤：</h4><p>开启三个事物，每一个事物分别执行如下SQL，然后再将第一个事物进行回滚或者提交，然后你就会发现第三个事物发生了死锁。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## DeadLock</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'i'</span>,<span class="string">'daqiao'</span>,<span class="string">'daqiao123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br></pre></td></tr></table></figure><p>Mysql提示如下：</p><blockquote><p>[2019-08-04 14:33:48] Connected<br>sql&gt; start transaction<br>[2019-08-04 14:33:49] completed in 4 ms<br>sql&gt; begin<br>[2019-08-04 14:33:49] completed in 6 ms<br>sql&gt; insert into test_lock.<code>test</code> values(‘i’,’daqiao’,’daqiao123456’,0,’15112345678’)<br>[2019-08-04 14:34:00] [40001][1213] Deadlock found when trying to get lock; try restarting transaction<br>[2019-08-04 14:34:00] [40001][1213] Deadlock found when trying to get lock; try restarting transaction</p></blockquote><p>那么打印出Mysql出现死锁的日志：重点日志如下</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line"><span class="number">2019</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">06</span>:<span class="number">33</span>:<span class="number">59</span> <span class="number">0</span>x7f1818599700</span><br><span class="line">*** (<span class="number">1</span>) TRANSACTION:</span><br><span class="line">TRANSACTION <span class="number">231690</span>, ACTIVE <span class="number">34</span> sec inserting</span><br><span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">4</span> lock <span class="keyword">struct</span>(s), heap size <span class="number">1136</span>, <span class="number">2</span> row lock(s)</span><br><span class="line">MySQL thread id <span class="number">9</span>, OS thread handle <span class="number">139741464762112</span>, query id <span class="number">95</span> <span class="number">172</span><span class="variable">.17</span><span class="variable">.0</span><span class="variable">.1</span> root update</span><br><span class="line"><span class="comment">/* ApplicationName=IntelliJ IDEA 2019.1.3 */</span> insert into test_lock.<span class="meta">`test` values('i','daqiao','daqiao123456',0,'15112345678')</span></span><br><span class="line">*** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id <span class="number">7</span> page no <span class="number">4</span> n bits <span class="number">80</span> index PRIMARY of <span class="keyword">table</span> <span class="meta">`test_lock`.`test` trx id 231690 lock_mode X insert intention waiting</span></span><br><span class="line">Record lock, heap no <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">8</span>; hex <span class="number">73757072656</span>d756d; asc supremum;;</span><br><span class="line"></span><br><span class="line">*** (<span class="number">2</span>) TRANSACTION:</span><br><span class="line">TRANSACTION <span class="number">231691</span>, ACTIVE <span class="number">10</span> sec inserting</span><br><span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line"><span class="number">4</span> lock <span class="keyword">struct</span>(s), heap size <span class="number">1136</span>, <span class="number">2</span> row lock(s)</span><br><span class="line">MySQL thread id <span class="number">10</span>, OS thread handle <span class="number">139741464467200</span>, query id <span class="number">139</span> <span class="number">172</span><span class="variable">.17</span><span class="variable">.0</span><span class="variable">.1</span> root update</span><br><span class="line"><span class="comment">/* ApplicationName=IntelliJ IDEA 2019.1.3 */</span> insert into test_lock.<span class="meta">`test` values('i','daqiao','daqiao123456',0,'15112345678')</span></span><br><span class="line">*** (<span class="number">2</span>) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id <span class="number">7</span> page no <span class="number">4</span> n bits <span class="number">80</span> index PRIMARY of <span class="keyword">table</span> <span class="meta">`test_lock`.`test` trx id 231691 lock mode S</span></span><br><span class="line">Record lock, heap no <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">8</span>; hex <span class="number">73757072656</span>d756d; asc supremum;;</span><br><span class="line"></span><br><span class="line">*** (<span class="number">2</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id <span class="number">7</span> page no <span class="number">4</span> n bits <span class="number">80</span> index PRIMARY of <span class="keyword">table</span> <span class="meta">`test_lock`.`test` trx id 231691 lock_mode X insert intention waiting</span></span><br><span class="line">Record lock, heap no <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">8</span>; hex <span class="number">73757072656</span>d756d; asc supremum;;</span><br><span class="line"></span><br><span class="line">*** WE ROLL BACK TRANSACTION (<span class="number">2</span>)</span><br><span class="line">------------</span><br></pre></td></tr></table></figure><p>从以上日志我们可以看到，事物一正在请求该行记录的 <code>X锁</code> ，事物二持有该行的<code>S锁</code>，但是也在等待获取该行的<code>X锁</code>。</p><p>关于Mysql的 <code>insert</code> 逻辑，可以大致理解为如果一个事物正在对一个记录进行 <code>insert</code>，此时 InnoDB 并不会主动的将其加一个锁，而是在主键索引上加一个 <code>trx_id</code>，</p><p>当第二个事物检测到该行记录正在被一个活跃的事物持有的时候，此时第二个事物会帮第一个事物的隐式锁住转为显式锁。如下例子：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## DeadLock</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'i'</span>,<span class="string">'daqiao'</span>,<span class="string">'daqiao123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br></pre></td></tr></table></figure><p>此时查看Mysql中锁的情况：</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/insert%E6%AD%BB%E9%94%81%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%BA%8B%E7%89%A9.png" alt=""></p><p>可以看到此时Mysql仅仅是在表上加入了一个插入意向锁（IX锁），持有该锁表示该事物在接下来有可能会对自己设计到的行加入排它锁（X锁）</p><p><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html" target="_blank" rel="noopener">Mysql关于意向锁的介绍</a></p><blockquote><p>The intention locking protocol is as follows:</p><ul><li>Before a transaction can acquire a shared lock on a row in a table, it must first acquire an <code>IS</code> lock or stronger on the table.</li><li>Before a transaction can acquire an exclusive lock on a row in a table, it must first acquire an <code>IX</code> lock on the table.</li></ul></blockquote><p>大意就是如果你想获得一个行的 <code>X锁</code>，那么你就必须先获取表的 <code>IX锁</code></p><p>那么此时再进行第二个事物的插入：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## DeadLock</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_lock.<span class="string">`test`</span> <span class="keyword">values</span>(<span class="string">'i'</span>,<span class="string">'daqiao'</span>,<span class="string">'daqiao123456'</span>,<span class="number">0</span>,<span class="string">'15112345678'</span>);</span><br></pre></td></tr></table></figure><p>再次查看数据库中的锁：</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/Mysql%E7%AC%AC%E4%BA%8C%E4%B8%AA%E4%BA%8B%E7%89%A9.png" alt=""></p><p>此时会发现第一个事物已经获取到了行级别的<code>X锁</code>，第二个事物获取到了 <code>IX</code> 锁以及 <code>S锁</code> 。</p><p>那么此时第三个事物开启之后数据库中的锁又会是什么样子的呢？</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/Mysql%E7%AC%AC%E4%B8%89%E4%B8%AA%E4%BA%8B%E7%89%A9.png" alt=""></p><p>可以发现另外两个事物都在等待获取该行的<code>S锁</code>。然后此时第一个事物进行回滚，此时第三个事物就会提示死锁。</p><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><h4 id="前提结论"><a href="#前提结论" class="headerlink" title="前提结论"></a>前提结论</h4><ol><li><code>S锁</code>是可以升级到<code>X锁</code>的</li><li>一个<code>S锁</code>需要升级到<code>X</code>锁必须保证只有当前事物持有<code>S锁</code></li></ol><h4 id="死锁原因"><a href="#死锁原因" class="headerlink" title="死锁原因"></a>死锁原因</h4><p>当第一个事物回滚之后，第二个事物和第三个事物都会获得到该行的<code>S锁</code>，但是此时第二个事物将要执行 insert 语句，也就是第二个事物正在等待获取该行的<code>X锁</code>，但是此时第三个事物也正在准备 insert，它也在准备获取 <code>X锁</code>，目前这两个事物都持有该行的 <code>S锁</code> ，而如果需要获取 <code>X锁</code>，则是需要对方释放<code>S</code>锁。如下图：</p><p><img src="https://szhtc-1252780558.cos.ap-shanghai.myqcloud.com/TwoTrxLock.png" alt=""></p><h3 id="简单复现步骤："><a href="#简单复现步骤：" class="headerlink" title="简单复现步骤："></a>简单复现步骤：</h3><p>为了验证上面的情况，我准备如下几个SQL：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">## 事物一</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test_lock.test <span class="keyword">where</span> user_id=<span class="string">'h'</span>  <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 事物二</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test_lock.test <span class="keyword">where</span> user_id=<span class="string">'h'</span>  <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"></span><br><span class="line">## 事物一再执行</span><br><span class="line"><span class="keyword">update</span> test_lock.<span class="string">`test`</span> <span class="keyword">set</span> user_name=<span class="string">'abc'</span>  <span class="keyword">where</span>  user_id = <span class="string">'h'</span>;</span><br><span class="line"></span><br><span class="line">## 事物二再执行</span><br><span class="line"><span class="keyword">update</span> test_lock.<span class="string">`test`</span> <span class="keyword">set</span> user_name=<span class="string">'abc'</span>  <span class="keyword">where</span>  user_id = <span class="string">'h'</span>;</span><br><span class="line"></span><br><span class="line">## 此时事物二就会提示死锁</span><br></pre></td></tr></table></figure><p>这是因为事物一和事物二都在等待对方释放<code>S锁</code>，但是都不肯释放，于是死锁发生了。</p><h3 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a>情况二</h3><blockquote><p> 三个事物都执行同一个Insert语句，第一个事物然后提交</p></blockquote><p>此时第二个事物和第三个事物都会提示主键冲突，并无死锁出现。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这种情况下的死锁是由于 <code>S锁</code> 升级到 <code>X锁</code>导致的一种死锁，在平常的业务代码中应该尽量避免并发插入一个主键。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在临近上线之前，我们系统做了一次压力测试，发现有一个接口在高并发情况下会出现一个死锁的情况。。首先申明…不是我写的，我只是帮忙排查下。&lt;/p&gt;
&lt;p&gt;随着对Mysql锁的深入了解，于是就准备写几篇文章来记录下Mysql各种事物和索引的情况下出现死锁的情况。&lt;/p&gt;
&lt;p&gt;今
      
    
    </summary>
    
      <category term="Mysql" scheme="https://somersames.github.io/categories/Mysql/"/>
    
    
      <category term="Mysql" scheme="https://somersames.github.io/tags/Mysql/"/>
    
  </entry>
  
</feed>
